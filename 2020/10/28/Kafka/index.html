<!DOCTYPE html>
<html lang="en">
<head>

<!-- 爆炸效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>


  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liweian.co.uk","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="More than 80% of all Fortune 100 companies trust, and use Kafka.Apache Kafka is an open-source distributed event streaming platform used by thousands of companies for high-performance data pipelines,">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka">
<meta property="og:url" content="https://liweian.co.uk/2020/10/28/Kafka/index.html">
<meta property="og:site_name" content="Eloise&#39;s Paradise">
<meta property="og:description" content="More than 80% of all Fortune 100 companies trust, and use Kafka.Apache Kafka is an open-source distributed event streaming platform used by thousands of companies for high-performance data pipelines,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/top10.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%89%E5%BA%8F%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E5%88%86%E5%8C%BA%E7%9A%84%E4%BA%8B%E4%BB%B6.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E5%89%AF%E6%9C%AC%E7%B2%92%E5%BA%A6%E5%88%B0%E4%B8%BB%E9%A2%98%E5%88%86%E5%8C%BA%E7%9A%84%E5%9B%BE%E5%BD%A2%E8%A7%A3%E9%87%8A.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E5%9F%9F%E5%90%8DIP%E6%98%A0%E5%B0%84.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/JDK%E9%85%8D%E7%BD%AE%E5%B9%B6%E6%A3%80%E6%9F%A5.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/myid.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/zookeeper%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/kafka%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/kafka%E8%84%9A%E6%9C%AC%E6%9F%A5%E7%9C%8B.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/kafka%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B%E6%88%90%E5%8A%9F%E4%B8%8E%E5%90%A6.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BDMySQL%E5%AE%89%E8%A3%85tar%E5%8C%85.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/MySQL%E5%AE%89%E8%A3%85%E5%8C%85%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E8%BF%87MySQL.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/kafkaeagle%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/kafkaeagle%E7%99%BB%E5%BD%95%E9%A1%B5.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E6%96%B0%E5%BB%BAtopicA.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/consumer1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/consumer2%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/consumer1%E5%92%8C2%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%90%8E.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_1.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_2.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_3.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E9%87%8D%E8%AF%953%E6%AC%A1.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9.png">
<meta property="og:image" content="https://liweian.co.uk/2020/10/28/Kafka/%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%AD%94%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="article:published_time" content="2020-10-28T00:56:31.000Z">
<meta property="article:modified_time" content="2020-10-28T01:06:21.000Z">
<meta property="article:author" content="Brooks.H.Joshua">
<meta property="article:tag" content="Kafka">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liweian.co.uk/2020/10/28/Kafka/top10.png">

<link rel="canonical" href="https://liweian.co.uk/2020/10/28/Kafka/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Kafka | Eloise's Paradise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div id="id-header-inner"  class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eloise's Paradise</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">22</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">62</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>
	<!-- 改变css样式 -->
<script type="text/javascript">
var url = document.location.pathname;
var folderName = url.substr(1, url.length - 2)
console.log(folderName);

var listPostUrl = [
    "/" + folderName + "/" + "post-banner.png",
    "/" + folderName + "/" + "post-banner.jpg",
];

var nSuccessCount = 0;
var nResponceCount = 0;
function OnHttpResponse(bSuccess, strUrl) {
    console.log("OnHttpResponse: " + bSuccess + ", " + strUrl);
    nResponceCount++;
    if(nSuccessCount > 0){
        return;
    }
    if(bSuccess) {
        nSuccessCount++;
        document.getElementById("id-header-inner").style.backgroundImage = "url(" + strUrl + ")";
    }
    if(nResponceCount >= listPostUrl.length && nSuccessCount <= 0){
        // 使用默认图
        document.getElementById("id-header-inner").style.backgroundImage = "url(/images/background.jpg)";
    }
}

function changeBanner(strPostUrl, nIndex){
    console.log("try to load" + strPostUrl);
    var xmlhttp;
    if (window.XMLHttpRequest)
    {
        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
        xmlhttp=new XMLHttpRequest();
    }
    else
    {
        // IE6, IE5 浏览器执行代码
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
            OnHttpResponse(true, strPostUrl);
        } else {
            OnHttpResponse(false, strPostUrl);
        }
    }
    xmlhttp.open("HEAD",strPostUrl,true);
    xmlhttp.send();
}

listPostUrl.forEach(changeBanner);
</script>



    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/10/28/Kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kafka
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-28 08:56:31 / Modified: 09:06:21" itemprop="dateCreated datePublished" datetime="2020-10-28T08:56:31+08:00">2020-10-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index">
                    <span itemprop="name">MQ</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>24 mins.</span>
            </span>


           
          
          <div class="out-img-topic">
          <img src=/image/Kafka_top10.png class="img-topic">
          </div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>More than 80% of all Fortune 100 companies trust, and use <strong>Kafka</strong>.Apache Kafka is an <strong>open-source distributed event streaming platform</strong> used by thousands of companies for <strong>high-performance</strong> data pipelines, streaming analytics, data integration, and mission-critical applications.</p>
<a id="more"></a>

<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p><img src="/2020/10/28/Kafka/top10.png" alt="Top10"></p>
<h3 id="What–-gt-何为事件流"><a href="#What–-gt-何为事件流" class="headerlink" title="What–&gt;何为事件流?"></a><font color="red">What</font>–&gt;何为事件流?</h3><p>事件流(<strong>Event Streming</strong>)是”数字化”的人体中枢神经系统. 是商业业务日益软件化和自动化的切持续不断运作的现实世界技术基础.<br>从技术上来说,事件流是以流式事件的方式从事件源(如数据库, 传感器, 移动设备, 云服务,软件应用等)即时获取,存储,操作数据,然后处理并且即时响应给其他事件流的最佳实践. 因此, 事件流是数据流得以持续翻译和信息能够在对的时间出现在对的位置的保障.</p>
<h3 id="Where–-gt-事件流用在何处"><a href="#Where–-gt-事件流用在何处" class="headerlink" title="Where–&gt;事件流用在何处?"></a><font color="red">Where</font>–&gt;事件流用在何处?</h3><p>事件流在各行各业都有则广泛的应用, 如下:</p>
<ul>
<li>在股票, 银行,保险等行业即时处理转账和交易数据</li>
<li>在物流和自动化产业跟踪监控车辆,船舰等的实时数据</li>
<li>在工厂持续从IoT设备获取并分析数据</li>
<li>在零售,酒店,旅游业以及移动应用场景中, 采集并立即响应顾客的数据请求</li>
<li>在医疗领域, 持续监控病人的健康数据并做出高效准确的预测以尽早寻求追加治疗方案</li>
<li>连接并存储同一公司不同业务分支的数据并确保其可用性</li>
<li>充当数据平台, 事件驱动架构, 微服务 等应用场景的基石.</li>
</ul>

<h3 id="Why–-gt-Kafka如何支撑业务数据"><a href="#Why–-gt-Kafka如何支撑业务数据" class="headerlink" title="Why–&gt;Kafka如何支撑业务数据?"></a><font color="red">Why</font>–&gt;Kafka如何支撑业务数据?</h3><p> kafka具有如下三种能力以确保任何想要在业务场景中实现端对端的事件流处理的用户能够应用一种经过实战检验的方式实现自己的业务:</p>
<ol>
<li>发布和订阅事件流, 即: 持续写入数据到外部系统/读取外部系统该数据</li>
<li>按业务需求和用户意愿持久,可靠地存储事件流</li>
<li>在事件流到达的即刻处理事件流数据(也可以是回溯的方式)</li>
</ol>

<p>所有以上功能在分布式, 高扩展, 弹性, 容错的环境中都是得以保障的. Kafka能部署在物理机, 虚拟机, 容器,本地应用和云应用中. 用户可以根据自身需要和业务场景选择自行管理或者是托管服务(由供应商提供)来管理自己的Kafka环境.</p>
<h3 id="How–-gt-Kafka是如何运作的"><a href="#How–-gt-Kafka是如何运作的" class="headerlink" title="How–&gt;Kafka是如何运作的?"></a>How–&gt;Kafka是如何运作的?</h3><p> Kafka是一个由客户端和服务端组成的分布式系统. 这些服务端和客户端之间通过高效的TCP网络协议进行通信. 他能被能部署在物理机, 虚拟机, 容器,本地应用和云应用中.<br></p>
<p><strong>服务端:</strong>  Kafka集群能运行在由多个数据中心或云基站的环境中. 这些被称之为(<strong>broker</strong>)服务器组成了数据存储层. 另外一部分服务器负责运行Kafka连接器持续从事件流导入/导出数据以与其他系统(数据库或其他Kafka集群)进行整合. 同时, 为了方便用户实现关键用例, Kafka<br> 还提供了易扩展和高容错的性能特点. 如果急群众某一个节点宕机, 集群中其他节点会接管该节点的工作以持续保证数据不会丢失.</p>
<p><strong>客户端:</strong>  客户端保证用户能往那些读/写以及并行处理事件流的分布式应用或微服务中写入数据, 即使是在网络瘫痪或硬件故障的情况下.Kafka提供了大量的客户端API库, 其中对Java和Scala语言支持的最好.  </p>
<h3 id="Terminologies"><a href="#Terminologies" class="headerlink" title="Terminologies"></a>Terminologies</h3><p><font color="red"><strong>1. Event</strong></font>: Event(事件,也被称之为:消息或记录) 记录了现实世界的业务数据信息.  当你往Kafka写入数据时, 其实是在往Kafka提交事件记录. 理论上, 事件有一个key, 一个value值和一个时间戳以及一些(非必须的)元数据头(metadata headers). 如:</p>
<pre><code><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">     </span></span><br><span class="line">Event key: "Alice"</span><br><span class="line">Event value: "Made a payment of $200 to Bob"</span><br><span class="line">Event timestamp: "Jun. 25, 2020 at 2:06 p.m."</span><br></pre></td></tr></table></figure></code></pre><p><font color="red"><strong>2. 生产者</strong></font>: 发布事件到Kafka集群的客户端应用.</p>
<p><font color="red"><strong>3. 消费者</strong></font>: 从Kafka集群订阅事件消费的客户端应用.</p>
<p><font color="red"><strong>4. 主题</strong></font>: 事件被组织并存储在主题中. 可以形象的将主题理解为PC的文件夹, 而事件则是文件夹中的具体的文件.</p>
<p><font color="red"><strong>5. 分区</strong></font>: 一个主题被分布在一系列不同broker中. 这种分布式的分区的设计使得客户端同时从多台broker读取/写入数据成为可能.当一个新的事件被发布到某个主题时, 该事件实际上是被追加到该主题的某一个分区上的. 拥有相同key的事件会被写到相同的分区. 同时,kafka<br>也保证了指定主题分区的消费者会按照事件被写入改分区的顺序取读取该分区的事件.<br><img src="/2020/10/28/Kafka/%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%89%E5%BA%8F%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E5%88%86%E5%8C%BA%E7%9A%84%E4%BA%8B%E4%BB%B6.png" alt="消费者有序读取指定分区的事件"></p>
<p>如上图, 一种颜色代表了一个分区, 消费者A: 手机 和消费者B: 小车 分别向主题: T的分区(P1,P3)和(P3,P4)发布消息.<br>注意: a). 相同key(颜色表示)的事件会被写入同一个分区.<br>     b). 不同的生产者可以往同一个主题的同一个分区写数据.   </p>
<p><font color="red"><strong>6. 副本</strong></font>:  同一份数据会被存储到不同的机器(broker),每一份被称为一个副本, 副本是容错和高可用性的基础. This replication is performed at the level of topic-partitions. 即: 副本的粒度到主题-分区.</p>
<p><img src="/2020/10/28/Kafka/%E5%89%AF%E6%9C%AC%E7%B2%92%E5%BA%A6%E5%88%B0%E4%B8%BB%E9%A2%98%E5%88%86%E5%8C%BA%E7%9A%84%E5%9B%BE%E5%BD%A2%E8%A7%A3%E9%87%8A.png" alt="副本粒度到主题分区的图形解释.png"></p>
<p> Kafka中生产者和消费者是完全解耦的, 该设计保证了高扩展性. 例如, 生产者永远不必等待消费者, 事件会被处理有且一次(exactly-once).</p>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><h3 id="消息代理"><a href="#消息代理" class="headerlink" title="消息代理"></a>消息代理</h3><p>Kafka作为传统消息代理的替代品有着出色的表现. 拥有更高的吞吐量的同时也兼具内置分区, 副本机制,容错以及易扩展,低延时等高级特性. 因此, kafka丝毫不逊色于ActiveMQ和RabbitMQ. </p>
<h3 id="网页动态跟踪"><a href="#网页动态跟踪" class="headerlink" title="网页动态跟踪"></a>网页动态跟踪</h3><p>Kafka最早被应用于网页活动的跟踪监控. 这也就意味着诸如页面浏览, 搜索等网页活动被按照特定规律发布到特定主题. 后续会被HDFS或者离线数据仓库订阅消费.</p>
<h3 id="日志整合"><a href="#日志整合" class="headerlink" title="日志整合"></a>日志整合</h3><p>很多人会将Kafka用作日志整合的解决方案. 典型的日志整合流程是从物理服务器采集日志文件然后放到文件服务器或者HDFS中以供后续处理. Kafka抽取出日志文件的细节并将其抽象成一个更简洁的消息流. 这也就保障了低延时和分布式数据消费.  </p>
<p> <strong>Kafka还可以用于流处理, 事件溯源, 提交日志记录等场景, 此处不做详细讨论, 可参考<a href="http://kafka.apache.org/documentation/#introduction" target="_blank" rel="noopener">官网</a>.</strong></p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>Kafka是java语言开发的, 运行需要JDK支持. 而作为服务监控,同时也需要zookeeper的支持.<br>下面对集群搭建流程做详细解释.</p>
<h3 id="Step-1-关闭防火墙"><a href="#Step-1-关闭防火墙" class="headerlink" title="Step 1 关闭防火墙"></a>Step 1 关闭防火墙</h3><p>   关闭Linux防火墙. 然后检查确认是否已关闭成功.<br>​<code>shell script
service iptables stop   # 关闭防火墙
service iptables status # 查看服务状态
chkconfig iptables off  #停用开机自启动防火墙服务
chkconfig --list        # 检查
​</code><br><strong>注意: CentOS系统版本不同, 关闭防火墙的命令也不一样.</strong><br><img src="/2020/10/28/Kafka/%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99.png" alt="关闭防火墙"></p>
<h3 id="Step-2-配置域名解析"><a href="#Step-2-配置域名解析" class="headerlink" title="Step 2 配置域名解析"></a>Step 2 配置域名解析</h3><p>执行:<br>​<code>shell script
vim /etc/hosts    
​</code><br>修改hosts文件, 为所有集群节点添加IP和HOSTNAME<br><br>192.168.210.140 Node01 <br><br>192.168.210.141 Node02 <br><br>192.168.210.143 Node03 <br></p>
<p>执行:<br>​<code>shell script
vim /etc/sysconfig/network
​</code><br>分别为各个节点添加<br><br>NETWORKING=yes  <br><br>HOSTNAME=Node01<br><br>最终结果如下图:<br></p>
<p><img src="/2020/10/28/Kafka/%E5%9F%9F%E5%90%8DIP%E6%98%A0%E5%B0%84.png" alt="域名IP映射"></p>
<p>然后执行<br>​<code>shell script
reboot
​</code><br>重启系统, 让上述配置文件重新生效.</p>
<h3 id="Step-3-JDK配置"><a href="#Step-3-JDK配置" class="headerlink" title="Step 3 JDK配置"></a>Step 3 JDK配置</h3><p>解压JDK rpm文件到指定目录<br>​<code>shell script
rpm -ivh jdk-8u261-linux-x64.rpm /usr/ -C 
​</code><br>编辑配置文件<br>​<code>shell script
vim ~/.bashrc
​</code><br>在最后追加<br>​<code>shell script
JAVA_HOME=/usr/java/latest
PATH=$PATH:$JAVA_HOME/bin
CLASSPATH=.
export JAVA_HOME
export PATH
export CLASSPATH
​</code><br>然后执行如下代码让配置文件生效<br>​<code>shell script
source ~/.bashrc
​</code><br>然后执行下面代码检查JDK环境是否已配置成功<br>​<code>shell script
java -version
echo $JAVA_HOME
​</code><br>检查结果如下图:<br><img src="/2020/10/28/Kafka/JDK%E9%85%8D%E7%BD%AE%E5%B9%B6%E6%A3%80%E6%9F%A5.png" alt="JDK配置并检查"></p>
<h3 id="Step-4-zookeeper配置"><a href="#Step-4-zookeeper配置" class="headerlink" title="Step 4 zookeeper配置"></a>Step 4 zookeeper配置</h3><p>下载zookeeper 压缩包tar包, 上传到Linux,并执行如下代码解压到指定目录/usr/下:<br>​<code>shell script
tar -zxf  zookeeper-3.4.6.tar.gz -C  /usr/ 
​</code><br>复制官方提供的配置文件,<br>​<code>shell script
cd /usr/zookeeper-3.4.6/conf/
cp zoo_sample.cfg  zk.cfg
​</code><br>然后编辑配置文件<br>​<code>shell script
vim zk.cfg
​</code><br>按下图方式对配置文件做修改(zookeeper快照数据存储路径设置和集群服务器节点信息配置):<br><img src="/2020/10/28/Kafka/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="zookeeper配置文件"></p>
<p>然后按刚才的修改创建zookeeper快照数据的存储目录:<br>​<code>shell script
mkdir /root/zkdata
​</code><br>然后创建编辑myid文件<br>​<code>shell script
vim /root/zkdata/myid
​</code><br>作如下修改: (id要与zk.cfg中配置的server.1=Node01:2888:3888中的server后面的序号一致)</p>
<p><img src="/2020/10/28/Kafka/myid.png" alt="myid"></p>
<p>然后将zookeeper安装目录及其所有子目录,子文件拷贝到集群其他节点.<br>​<code>shell script
scp -r /usr/zookeeper-3.4.6/  root@Node02:/usr
​</code><br>如果没做过<strong>免密配置</strong>, 则输入指定目标节点的root密码即可拷贝. 如果做过免密配置, 则会直接拷贝.<br><br>免密配置的具体配置流程及其原理解释可以参见如下博客.<br><a href="https://www.cnblogs.com/wenxingxu/p/9597307.html" target="_blank" rel="noopener">免密配置</a><br><img src="/2020/10/28/Kafka/%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D.png" alt="远程拷贝"><br>此时在Node02节点的对应目录已经能看到拷贝过来的<code>zookeeper-3.4.6</code>目录. 同样的方法, 将目录也拷贝到Node03节点指定目录.<br><br>然后在Node02和Node03节点中执行如下命令,创建zookeeper的快照数据存储目录, 并添加myid文件<br>​<code>shell script
cd /root
mkdir zkdata
vim zkdata/myid
​</code><br>至此. zookeeper集群配置也就完成. 继续启动所有集群节点的zookeeper服务<br>​<code>shell script
cd /usr/zookeeper-3.4.6/bin/
./zkServer.sh start ../conf/zk.cfg  # 启动服务, ../conf/zk.cfg表示启动当前zookeeper服务要使用的配置文件
​</code><br>然后检测服务启动成功与否<br>​<code>shell script
./zkServer.sh status ../conf/zk.cfg 
​</code><br>见到如下反馈信息说明已经启动成功.<br><img src="/2020/10/28/Kafka/zookeeper%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81.png" alt="zookeeper启动状态"></p>
<p>如果要关闭zookeeper服务可以执行:<br>​<code>shell script
./zkServer.sh stop ../conf/zk.cfg 
​</code></p>
<h3 id="step-5-kafka集群搭建"><a href="#step-5-kafka集群搭建" class="headerlink" title="step 5 kafka集群搭建"></a>step 5 kafka集群搭建</h3><p>解压<br>​<code>shell script
tar -zxf kafka_2.11-2.2.0.tgz -C /usr/ 
​</code><br>修改配置文件<br>​<code>shell script
vim /usr/kafka_2.11-2.2.0/config/server.properties
​</code><br>具体修改如下图中三个配置项:<br><img src="/2020/10/28/Kafka/kafka%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="kafka"><br>按照<code>server.properties</code>里配置的log.dirs配置项的值创建kafka日志目录<br>​<code>shell script
cd /usr/
mkdir kafka-logs
​</code><br>然后就可以进入kafka的bin目录下查看脚本<br>​<code>shell script
cd /usr/kafka_2.11-2.2.0/bin/
​</code><br><img src="/2020/10/28/Kafka/kafka%E8%84%9A%E6%9C%AC%E6%9F%A5%E7%9C%8B.png" alt="kafka脚本查看"><br>想查看具体脚本的使用方法可以执行–help, 如下:<br>​<code>shell script
./kafka-console-consumer.sh --help
​</code><br>启动kafka服务端:<br>​<code>shell script
./kafka-server-start.sh -daemon  ../config/server.properties # -daemon表示以守护/后台进程启动kafka服务, 敞口关闭进程也会继续. 后面则是指明具体的启动配置文件
​</code><br>检测是否启动成功:<br>​<code>shell script
jps
​</code><br><img src="/2020/10/28/Kafka/kafka%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B%E6%88%90%E5%8A%9F%E4%B8%8E%E5%90%A6.png" alt="kafka启动进程成功与否"><br>注意:<br><code>/usr/kafka_2.11-2.2.0/config/server.properties</code>里的broker.id的值要和当前节点的<code>/usr/kafka-logs/meta.properties</code>里的’broker.id’要保持一致. 否则kafka会在启动后秒退.</p>
<p>按照同样的方法配置集群中其他节点的kafka.</p>
<h2 id="Kafka-Eagle安装"><a href="#Kafka-Eagle安装" class="headerlink" title="Kafka-Eagle安装"></a>Kafka-Eagle安装</h2><p>确保ke.sh有可执行权限<br>​<code>shell script
chmod u+x /usr/kafka-eagle-web-2.0.2/bin/ke.sh 
​</code></p>
<p>Linux系统安装MySQL步骤:<br>step1 :<br><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">MySQL官网</a>下载MySQL安装包:<br><img src="/2020/10/28/Kafka/%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BDMySQL%E5%AE%89%E8%A3%85tar%E5%8C%85.png" alt></p>
<p>step2: 上传包<br>winscp(或其他) 软件上传到Linux指定目录下. (此处传到: /mysoftware/)  </p>
<p>step3: 解压<br>​<code>shell script
cd /mysoftware
tar -xvf mysql-8.0.22-1.el8.x86_64.rpm-bundle.tar -C /usr/
​</code><br>step4: 查看解压文件<br>​<code>shell script
ls -l /usr/
​</code><br>如图:<br><img src="/2020/10/28/Kafka/MySQL%E5%AE%89%E8%A3%85%E5%8C%85%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95.png" alt="MySQL安装包解压后的文件清单"></p>
<p>step5: 确认系统之前是否装过MySQL<br>​<code>shell script
rpm -qa | grep mysql 
​</code><br>结果:<br><img src="/2020/10/28/Kafka/%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E8%BF%87MySQL.png" alt="查询系统是否已经安装过MySQL"><br>如果已经安装过mysql, 先卸载:<br>​<code>shell script
rpm -e --nodeps mysql-libs-5.1.71-1.el6.x86_64
​</code><br>然后再次执行:<br>​<code>shell script
rpm -qa | grep mysql 
​</code><br>如果没有任何输出, 说明卸载成功</p>
<p>step5 : 依次安装<br>​<code>shell script
rpm -ivh 
​</code><br><strong>注：ivh中， i-install安装；v-verbose进度条；h-hash哈希校验</strong></p>
<p>安装成功提示:<br><img src="/2020/10/28/Kafka/kafkaeagle%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png" alt="kafkaeagle安装成功提示.png"><br>监控首页<br><img src="/2020/10/28/Kafka/kafkaeagle%E7%99%BB%E5%BD%95%E9%A1%B5.png" alt="kafkaeagle登录页.png"></p>
<h2 id="生态"><a href="#生态" class="headerlink" title="生态"></a>生态</h2><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><h1 id="APIs"><a href="#APIs" class="headerlink" title="APIs"></a>APIs</h1><h2 id="生产者-API"><a href="#生产者-API" class="headerlink" title="生产者 API"></a>生产者 API</h2><h2 id="消费者API"><a href="#消费者API" class="headerlink" title="消费者API"></a>消费者API</h2><h2 id="流-API"><a href="#流-API" class="headerlink" title="流 API"></a>流 API</h2><h2 id="连接-API"><a href="#连接-API" class="headerlink" title="连接 API"></a>连接 API</h2><h2 id="管理员-API"><a href="#管理员-API" class="headerlink" title="管理员 API"></a>管理员 API</h2><h2 id="高级API"><a href="#高级API" class="headerlink" title="高级API"></a>高级API</h2><h3 id="Offset控制"><a href="#Offset控制" class="headerlink" title="Offset控制"></a>Offset控制</h3><h4 id="ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置"><a href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置" class="headerlink" title="ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置"></a>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置</h4><p>在消费者consumerA首次订阅某主题消息topicB的时候, topicB是没有维护consumerA的offset信息的. 那么首次订阅该从什么offset位置开始消费呢? 该offset是有三种策略可选的:</p>
<ol>
<li>latest: [默认]配置, 表示consumerA会从topicB的最新offset位置开始消费, 即从consumerA订阅topicB开始后, 新进入topicB的消息才会被consumerA消费. </li>
<li>earlist: 表示consumerA会从topicB的最开始的offset位置开始消费, 即包括consumerA订阅topicB之前的所有消息都会被消费</li>
<li>none: 如果没找到当前消费者组之前提交的offset值, 会向调用者(消费者)抛异常. </li>
</ol> 
值得注意的是: **offset**配置只会在消费者首次订阅消息的时候生效, 因为一旦开始订阅并消费消息后, 主题topicB 就会维护当前消费者consumerA 的消费的offsset信息, 下次再消费时会从维护的日志中获取consumerA的消费offset位置比如: O1,然后再继续从O1开始消费. 
该配置在JAVA API中由 `ConsumerConfig.AUTO_OFFSET_RESET_CONFIG` 配置项配置.



<h4 id="ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试"><a href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试" class="headerlink" title="ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试"></a>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试</h4><p>为了检测上面的结论, 我们按照如下步骤进行测试:<br>step1: 首先新建一个主题topicA</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.admin.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.10.23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">topicManagement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  AdminClient adminClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = prepareEnvironment();</span><br><span class="line">        adminClient = KafkaAdminClient.create(properties);</span><br><span class="line">        createTopicByMe(adminClient,<span class="string">"topicA"</span>);</span><br><span class="line">        listAllMyTopics(adminClient);</span><br><span class="line">        adminClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTopicByMe</span><span class="params">(AdminClient adminClient,String topic2BCreated)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        CreateTopicsResult createTopicsResult =</span><br><span class="line">                adminClient.createTopics(Arrays.asList(<span class="keyword">new</span> NewTopic(topic2BCreated, <span class="number">3</span>, (<span class="keyword">short</span>) <span class="number">3</span>)));</span><br><span class="line">        createTopicsResult.all().get(); <span class="comment">// 触发同步创建</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listAllMyTopics</span><span class="params">(AdminClient adminClient)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ListTopicsResult listTopicsResult = adminClient.listTopics();</span><br><span class="line">        Set&lt;String&gt; topicNames = listTopicsResult.names().get();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topicNames) &#123;</span><br><span class="line">            stringBuilder.append(topic+<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查看topic的详细信息</span></span><br><span class="line">        String s = stringBuilder.toString();</span><br><span class="line">        String substring = s.substring(<span class="number">0</span>, s.length());</span><br><span class="line">        String[] split = substring.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        DescribeTopicsResult describeTopics = adminClient.describeTopics(Arrays.asList(split));</span><br><span class="line">        Map&lt;String, TopicDescription&gt; descMap = describeTopics.all().get();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, TopicDescription&gt; entry : descMap.entrySet()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"key:\t"</span> + entry.getKey());</span><br><span class="line">            System.out.println(<span class="string">"value:\t"</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Properties <span class="title">prepareEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从控制台输出可以看到topicA创建成功:<br><img src="/2020/10/28/Kafka/%E6%96%B0%E5%BB%BAtopicA.png" alt="新建topicA"></p>
<p>step2: 然后启动一个producer往往topicA里写入5条数据;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">         produce();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 2. 生产者创建</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord = </span><br><span class="line">                    <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"topicA"</span> ,  String.valueOf(i));</span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>step3: 然后分别启动consumer1(offset配置为latest)和consumer2(offset配置为earliest)订阅topicA. <strong>注意此时是两个消费者首次消费topicA</strong><br>conmuser1(offset设置latest):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlleredOffset1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g1"</span>);</span><br><span class="line">        <span class="comment">//offset设置latest</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    String value = next.value(); </span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line">    </span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>conmuser2 (offset设置earliest):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlleredOffset2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g2"</span>);</span><br><span class="line">        <span class="comment">//offset设置earliest</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    String value = next.value(); </span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line">    </span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>step4: 检查consumer1和consumer2的控制台输出.<br><br>consumer1消费结果:<br><img src="/2020/10/28/Kafka/consumer1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer1消费结果"><br>consumer2消费结果:<br><img src="/2020/10/28/Kafka/consumer2%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer2消费结果"></p>
<p>step5: 停掉consumer1和consumer2,后执行step2的代码继续往topicA里写5条数据. (注意为了方便观察, for循环里value的值改成6~10)<br></p>
<p>step6: 然后执行step3中的代码再次启动consumer1和consumer2. 观察consumer1和consumer2的控制台输出.<br><br><img src="/2020/10/28/Kafka/consumer1%E5%92%8C2%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer1和2第二次消费结果"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line">规律: 用户提交的offset偏移量永远都要比本次消费的偏移量+1,代表着下一次消费要开始的offset便宜位置. 而offset值又是从0开始的, 所以consumer1和consumer2第一次消费过后都向kafka提交了的offset值是: 5.  </span><br><span class="line"><span class="code">`ConsumerConfig.AUTO_OFFSET_RESET_CONFIG`</span> 的配置又只在第一次消费时生效, 所以本次不管consumer1还是consumer2 第二次订阅topicA都是从offset: 5的位置开始消费.</span><br><span class="line"></span><br><span class="line">**</span><br></pre></td></tr></table></figure>



<p>step1 ~ step4 说明offset的配置在消费者首次订阅某主题消息时后按照指定的<code>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</code>值(latest,earliest,none)生效.<br><br>step5 ~ step6 说明<code>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</code>值<strong>只在首次消费时生效</strong>. &lt;/br/&gt;</p>
<h4 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启</h4><p>另外可以通过下面两行设置自动提交的策略, 第一行开启, 第二行设置自动提交的时间间隔.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">true</span>);</span><br><span class="line">properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>
<h4 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试</h4><p>自动提交的具体测试步骤;<br>step1: 新建topicB,开启生产者往topicB写5条数据 (具体可以参见ConsumerConfig.AUTO_OFFSET_RESET_CONFIG的step2和step3, 将topic名称改为topicB即可)<br>step2: 编写消费者consumer3, 并开启消费者上面两行自动提交的配置<br><strong>注意: 自动提交配置, 使用的是put方法, 不是setProperty方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAutoCommitConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//指定消费者组g3</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g3"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">        <span class="comment">//自动提交配置, 注意是put方法, 不是setProperty方法. 只有配置项值的类型是String的时候两者一样, 否则只能用put</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">true</span>);</span><br><span class="line">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">10000</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicB"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                    String value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>step3: 启动consumer3进行消费, 观察控制台结果如下. 然后尽快停掉应用(不要超过step2中设置的自动提交offset的时间间隔: 10秒)<br><img src="/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png" alt="自动提交offset测试"></p>
<p>step4: 再次启动consumer3进行消费, 发现还是从最开始offset:0的位置开始消费, 这次让进城多云醒一会, 超过10秒后停掉应用.<br><img src="/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png" alt="自动提交offset测试"></p>
<p>step5: 第三次启动consumer3进行消费, 因为step4中g3消费时间超过10秒, auto_commit自动提交过offset了, 所以此次启动时不会看到从0开始消费.<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%90%8E.png" alt="自动提交offset测试"></p>
<h4 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略</h4><p> step1: 新建topicC,开启生产者往topicC写5条数据 (具体可以参见ConsumerConfig.AUTO_OFFSET_RESET_CONFIG的step2和step3, 将topic名称改为topicC即可)<br> step2: 编写消费者consumer4, 并将自动提交的配置 <code>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG</code>置为false.<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.TopicPartition;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfDefinedCommitStrategy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            consume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.setProperty(</span><br><span class="line">                    ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">            properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g4"</span>);</span><br><span class="line">            properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">            properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 2. 消费者创建</span></span><br><span class="line">            KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">            <span class="comment">// 3. 订阅/消费 Message</span></span><br><span class="line">            consumer.subscribe(Pattern.compile(<span class="string">"topicC"</span>));</span><br><span class="line">            <span class="comment">// 遍历消息队列</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">                <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                    Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                    <span class="comment">//新建一个map集合来存储分区的offset信息, key是TopicPartition, 值是offset和元数据信息</span></span><br><span class="line">                    Map&lt;TopicPartition, OffsetAndMetadata&gt; offsetMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                        ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                        String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                        <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                        String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                        String value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                        <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                        <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                        TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                        Headers headers = next.headers();</span><br><span class="line">                        Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                        <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                        <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                        System.out.println(</span><br><span class="line">                                <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                        );</span><br><span class="line">                        <span class="comment">//每次消费完之后都要提交offset和元数据信息, 也可以格局自己的业务需求去在合适的时机提交.</span></span><br><span class="line">                        offsetMap.put(<span class="keyword">new</span> TopicPartition(topic,partition),<span class="keyword">new</span> OffsetAndMetadata(offset));</span><br><span class="line">                        consumer.commitAsync(offsetMap, <span class="keyword">new</span> OffsetCommitCallback() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, Exception exception)</span> </span>&#123;</span><br><span class="line">                                System.out.println(<span class="string">"提交了如下offset&amp;metadata信息: \r\n"</span>+<span class="string">"offset:\t"</span>+offset+<span class="string">"\texception(if any):\t"</span>+exception);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>发现确实有提交</p>
<p><img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_1.png" alt="自定义提交策略_1"></p>
<p> step3: 停掉消费进城后再次重启, 还是消费者组g4,此时再观察发现又消费到了: offset:4 (如下图:)<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_2.png" alt="自定义提交策略_2"><br> 这是为什么呢?<br> 因为消费者最后一次提交的offset的数值是下一次再次消费时开始订阅的起始位置, 也就是说第一次consumer4消费完之后提交的offset值是4, 所以下一次consumer4是从offset:4开始消费的.<br> 所以, 回到前面提到的规律:用户提交的offset偏移量永远都要比本次消费的偏移量+1, 所以修改step3的代码(offset–&gt;offset+1)后启动一次consumer4让他最后一次提交的offset为5:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offsetMap.put(<span class="keyword">new</span> TopicPartition(topic,partition),<span class="keyword">new</span> OffsetAndMetadata(offset+<span class="number">1</span>));</span><br></pre></td></tr></table></figure><br> step4: 再次启动consumer4消费TopicC发现此次就消费不到了.<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_3.png" alt="自定义提交策略_3"></p>
<h3 id="确认应答与重试机制"><a href="#确认应答与重试机制" class="headerlink" title="确认应答与重试机制"></a>确认应答与重试机制</h3><h4 id="机制解释"><a href="#机制解释" class="headerlink" title="机制解释"></a>机制解释</h4><p> Kafka生产这在发送完一个消息后, 要求broker在规定的时间内进行Ack应答, 如果没有在规定的时间内进行应答, Kafka生产者会重试N次重新发送信息.<br> 而broker的确认应答机制可以有如下几种设置<br> <ol><br> <li>acks=1: 此时Leader会将record写到本地日志中, 但会在不等待所有follower都确认的情况下就做出响应. 这种情况下,如果Leader在确认应答后宕机, 那么记录会丢失. 因为follower还没有进行复制记录到副本.</li><br> <li>acks=0: 此时, 生产者根本不会等待broker做出任何确认, 该记录将立即添加到网络套接字缓冲区并视为已发送.这种情况下不能保证服务端broker已接收到信息.</li><br> <li>acks=all / acks=-1: 两种写法效果一样, 都是: Leader在接收到信息后需要等待全部ISR(in-sync replicas)同步副本确认.这就保证了, 只要至少一个同步副本处于活动状态, 记录就不会丢失. 这是最有力的保证</li><br> </ol><br> 如果生产者在规定时间内没有得到Leader的yingda , 可以开启retries重试机制.<br> request.timeout.ms=30000 (默认30秒)<br> retries=2147483647 (默认)</p>
<p> 具体可以参见官网文档3.3节的<a href="http://kafka.apache.org/documentation/#acks" target="_blank" rel="noopener">acks</a> 部分和4.8节的 <a href="http://kafka.apache.org/documentation/#design_ha" target="_blank" rel="noopener">Availability and Durability Guarantees</a> 部分</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p> ste1: 启动消费者订阅topicC的消息:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.Ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcksConsumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        <span class="comment">//消息接收到后要进行反序列化解析</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//消费者要指明属于哪一个消费者组</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g4"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 消费者创建</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. 订阅/消费 Message</span></span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicC"</span>));</span><br><span class="line">        <span class="comment">// 遍历消息队列</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                    String value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                             <span class="string">"timestampType:\t"</span>+timestampType+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br> step2: 启动生产者往topicC发布消息 (<strong>注意三行确认应答和重试机制的配置</strong>)<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.Ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcksProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">         produce();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line"></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG,<span class="string">"1"</span>); <span class="comment">// 设置请求超时时间为1毫秒.</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"all"</span>); <span class="comment">// 设置确认应答机制为all, 即需要等待所有ISR副本确认</span></span><br><span class="line">        properties.put(ProducerConfig.RETRIES_CONFIG,<span class="number">3</span>); <span class="comment">//设置重试3次, (不包含第一次)</span></span><br><span class="line"></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建producerrecord</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"topicC"</span> , <span class="string">"acks"</span>,<span class="string">"ack test"</span>);</span><br><span class="line">            <span class="comment">// 发送record</span></span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">            <span class="comment">//发送信息后刷新一下</span></span><br><span class="line">            producer.flush();</span><br><span class="line"></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到producer的控制台的3次重试记录:<br> <img src="/2020/10/28/Kafka/%E9%87%8D%E8%AF%953%E6%AC%A1.png" alt="重试3次"><br> 也可以看到消费者控制台的消费记录(从生产者的代码和此处同一创建时间的消息记录有4个(初始发送和3次重试以供4次)不同offset的记录可以看出重复消费了.):<br> <img src="/2020/10/28/Kafka/%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9.png" alt="重复消费"></p>
<p> 确认应答与重试机制原理流程图参见如下:<br> <img src="/2020/10/28/Kafka/%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%AD%94%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="确认应答与重试机制原理流程图"></p>
<h2 id="Kafka-Eagle"><a href="#Kafka-Eagle" class="headerlink" title="Kafka-Eagle"></a>Kafka-Eagle</h2><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="代理-Broker-配置"><a href="#代理-Broker-配置" class="headerlink" title="代理(Broker)配置"></a>代理(Broker)配置</h2><h2 id="主题配置"><a href="#主题配置" class="headerlink" title="主题配置"></a>主题配置</h2><h2 id="生产者配置"><a href="#生产者配置" class="headerlink" title="生产者配置"></a>生产者配置</h2><h2 id="消费者配置"><a href="#消费者配置" class="headerlink" title="消费者配置"></a>消费者配置</h2><h2 id="连接配置"><a href="#连接配置" class="headerlink" title="连接配置"></a>连接配置</h2><h2 id="流配置"><a href="#流配置" class="headerlink" title="流配置"></a>流配置</h2><h2 id="管理员客户端配置"><a href="#管理员客户端配置" class="headerlink" title="管理员客户端配置"></a>管理员客户端配置</h2><h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><h2 id="高效性"><a href="#高效性" class="headerlink" title="高效性"></a>高效性</h2><h2 id="生产者设计"><a href="#生产者设计" class="headerlink" title="生产者设计"></a>生产者设计</h2><h2 id="消费者设计"><a href="#消费者设计" class="headerlink" title="消费者设计"></a>消费者设计</h2><h2 id="消息发送语义"><a href="#消息发送语义" class="headerlink" title="消息发送语义"></a>消息发送语义</h2><h2 id="副本"><a href="#副本" class="headerlink" title="副本"></a>副本</h2><h2 id="日志压缩"><a href="#日志压缩" class="headerlink" title="日志压缩"></a>日志压缩</h2><h2 id="定额"><a href="#定额" class="headerlink" title="定额"></a>定额</h2><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>##</p>

    </div>



<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


  
</div>




    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Brooks.H.Joshua
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://liweian.co.uk/2020/10/28/Kafka/" title="Kafka">https://liweian.co.uk/2020/10/28/Kafka/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kafka/" rel="tag"><i class="fa fa-tag"></i>Kafka</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/05/designpatterns/" rel="prev" title="Designpatterns">
      <i class="fa fa-chevron-left"></i> Designpatterns
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/" rel="next" title="MySQL_Advanced_Optimization_01_性能监控篇">
      MySQL_Advanced_Optimization_01_性能监控篇 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
 


 <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#开始"><span class="nav-number">1.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.1.1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What–-gt-何为事件流"><span class="nav-number">1.1.2.</span> <span class="nav-text">What–&gt;何为事件流?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Where–-gt-事件流用在何处"><span class="nav-number">1.1.3.</span> <span class="nav-text">Where–&gt;事件流用在何处?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why–-gt-Kafka如何支撑业务数据"><span class="nav-number">1.1.4.</span> <span class="nav-text">Why–&gt;Kafka如何支撑业务数据?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How–-gt-Kafka是如何运作的"><span class="nav-number">1.1.5.</span> <span class="nav-text">How–&gt;Kafka是如何运作的?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terminologies"><span class="nav-number">1.1.6.</span> <span class="nav-text">Terminologies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用例"><span class="nav-number">1.2.</span> <span class="nav-text">用例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息代理"><span class="nav-number">1.2.1.</span> <span class="nav-text">消息代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网页动态跟踪"><span class="nav-number">1.2.2.</span> <span class="nav-text">网页动态跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志整合"><span class="nav-number">1.2.3.</span> <span class="nav-text">日志整合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速入门"><span class="nav-number">1.3.</span> <span class="nav-text">快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-关闭防火墙"><span class="nav-number">1.3.1.</span> <span class="nav-text">Step 1 关闭防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-配置域名解析"><span class="nav-number">1.3.2.</span> <span class="nav-text">Step 2 配置域名解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-3-JDK配置"><span class="nav-number">1.3.3.</span> <span class="nav-text">Step 3 JDK配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-4-zookeeper配置"><span class="nav-number">1.3.4.</span> <span class="nav-text">Step 4 zookeeper配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step-5-kafka集群搭建"><span class="nav-number">1.3.5.</span> <span class="nav-text">step 5 kafka集群搭建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-Eagle安装"><span class="nav-number">1.4.</span> <span class="nav-text">Kafka-Eagle安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生态"><span class="nav-number">1.5.</span> <span class="nav-text">生态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#升级"><span class="nav-number">1.6.</span> <span class="nav-text">升级</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APIs"><span class="nav-number">2.</span> <span class="nav-text">APIs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者-API"><span class="nav-number">2.1.</span> <span class="nav-text">生产者 API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消费者API"><span class="nav-number">2.2.</span> <span class="nav-text">消费者API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流-API"><span class="nav-number">2.3.</span> <span class="nav-text">流 API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接-API"><span class="nav-number">2.4.</span> <span class="nav-text">连接 API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理员-API"><span class="nav-number">2.5.</span> <span class="nav-text">管理员 API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级API"><span class="nav-number">2.6.</span> <span class="nav-text">高级API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Offset控制"><span class="nav-number">2.6.1.</span> <span class="nav-text">Offset控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启"><span class="nav-number">2.6.1.3.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试"><span class="nav-number">2.6.1.4.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略"><span class="nav-number">2.6.1.5.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认应答与重试机制"><span class="nav-number">2.6.2.</span> <span class="nav-text">确认应答与重试机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#机制解释"><span class="nav-number">2.6.2.1.</span> <span class="nav-text">机制解释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试"><span class="nav-number">2.6.2.2.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-Eagle"><span class="nav-number">2.7.</span> <span class="nav-text">Kafka-Eagle</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置"><span class="nav-number">3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#代理-Broker-配置"><span class="nav-number">3.1.</span> <span class="nav-text">代理(Broker)配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主题配置"><span class="nav-number">3.2.</span> <span class="nav-text">主题配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者配置"><span class="nav-number">3.3.</span> <span class="nav-text">生产者配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消费者配置"><span class="nav-number">3.4.</span> <span class="nav-text">消费者配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接配置"><span class="nav-number">3.5.</span> <span class="nav-text">连接配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流配置"><span class="nav-number">3.6.</span> <span class="nav-text">流配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理员客户端配置"><span class="nav-number">3.7.</span> <span class="nav-text">管理员客户端配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设计"><span class="nav-number">4.</span> <span class="nav-text">设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#动机"><span class="nav-number">4.1.</span> <span class="nav-text">动机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久化"><span class="nav-number">4.2.</span> <span class="nav-text">持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高效性"><span class="nav-number">4.3.</span> <span class="nav-text">高效性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者设计"><span class="nav-number">4.4.</span> <span class="nav-text">生产者设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消费者设计"><span class="nav-number">4.5.</span> <span class="nav-text">消费者设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息发送语义"><span class="nav-number">4.6.</span> <span class="nav-text">消息发送语义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#副本"><span class="nav-number">4.7.</span> <span class="nav-text">副本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志压缩"><span class="nav-number">4.8.</span> <span class="nav-text">日志压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定额"><span class="nav-number">4.9.</span> <span class="nav-text">定额</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现"><span class="nav-number">5.</span> <span class="nav-text">实现</span></a></li></ol></div>
      </div>
      <!--/noindex-->



      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Brooks.H.Joshua"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Brooks.H.Joshua</p>
  <div class="site-description" itemprop="description">Less Is More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/blog" title="https:&#x2F;&#x2F;spring.io&#x2F;blog" rel="noopener" target="_blank">Spring官博</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.itboyhub.com/" title="http:&#x2F;&#x2F;www.itboyhub.com&#x2F;" rel="noopener" target="_blank">JavaBoy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" title="https:&#x2F;&#x2F;www.cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html" rel="noopener" target="_blank">DSV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://visualgo.net/zh" title="https:&#x2F;&#x2F;visualgo.net&#x2F;zh" rel="noopener" target="_blank">DV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apache.org/index.html#projects-list" title="http:&#x2F;&#x2F;www.apache.org&#x2F;index.html#projects-list" rel="noopener" target="_blank">Apache</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">StackOverflow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://metacademy.org/" title="https:&#x2F;&#x2F;metacademy.org&#x2F;" rel="noopener" target="_blank">Metacademy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">WebNav</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.36zhen.com/t?id=3448" title="http:&#x2F;&#x2F;www.36zhen.com&#x2F;t?id&#x3D;3448" rel="noopener" target="_blank">前端书籍资料</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">G前端开发基础</a>
        </li>
    </ul>
  </div>

     
	<!--网易云音乐-->
	  <div id="music163player">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1002994&auto=1&height=66"></iframe>
	  </div>
      </div>

    </div>
  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Brooks.H.Joshua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">777k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">11:46</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

</html>
