<!DOCTYPE html>
<html lang="en">
<head>

<!-- 爆炸效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>


  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liweian.co.uk","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Less Is More">
<meta property="og:type" content="website">
<meta property="og:title" content="Eloise&#39;s Paradise">
<meta property="og:url" content="https://liweian.co.uk/page/5/index.html">
<meta property="og:site_name" content="Eloise&#39;s Paradise">
<meta property="og:description" content="Less Is More">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Brooks.H.Joshua">
<meta property="article:tag" content="Keep Moving">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liweian.co.uk/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Eloise's Paradise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div id="id-header-inner"  class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eloise's Paradise</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">30</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">22</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">59</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>
	<!-- 改变css样式 -->
<script type="text/javascript">
var url = document.location.pathname;
var folderName = url.substr(1, url.length - 2)
console.log(folderName);

var listPostUrl = [
    "/" + folderName + "/" + "post-banner.png",
    "/" + folderName + "/" + "post-banner.jpg",
];

var nSuccessCount = 0;
var nResponceCount = 0;
function OnHttpResponse(bSuccess, strUrl) {
    console.log("OnHttpResponse: " + bSuccess + ", " + strUrl);
    nResponceCount++;
    if(nSuccessCount > 0){
        return;
    }
    if(bSuccess) {
        nSuccessCount++;
        document.getElementById("id-header-inner").style.backgroundImage = "url(" + strUrl + ")";
    }
    if(nResponceCount >= listPostUrl.length && nSuccessCount <= 0){
        // 使用默认图
        document.getElementById("id-header-inner").style.backgroundImage = "url(/images/background.jpg)";
    }
}

function changeBanner(strPostUrl, nIndex){
    console.log("try to load" + strPostUrl);
    var xmlhttp;
    if (window.XMLHttpRequest)
    {
        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
        xmlhttp=new XMLHttpRequest();
    }
    else
    {
        // IE6, IE5 浏览器执行代码
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
            OnHttpResponse(true, strPostUrl);
        } else {
            OnHttpResponse(false, strPostUrl);
        }
    }
    xmlhttp.open("HEAD",strPostUrl,true);
    xmlhttp.send();
}

listPostUrl.forEach(changeBanner);
</script>



    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/11/22/SpringCloud01/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/22/SpringCloud01/SpringCloud/" class="post-title-link" itemprop="url">SpringCloud01/SpringCloud</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-22 11:40:20" itemprop="dateCreated datePublished" datetime="2020-11-22T11:40:20+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-16 18:16:02" itemprop="dateModified" datetime="2020-04-16T18:16:02+08:00">2020-04-16</time>
              </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>29 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud:"></a>SpringCloud:</h1><h2 id="0-SpringCloud升级-部分组件停用"><a href="#0-SpringCloud升级-部分组件停用" class="headerlink" title="0,SpringCloud升级,部分组件停用:"></a>0,SpringCloud升级,部分组件停用:</h2><p>1,Eureka停用,可以使用zk作为服务注册中心</p>
<p>2,服务调用,Ribbon准备停更,代替为LoadBalance</p>
<p>3,Feign改为OpenFeign</p>
<p>4,Hystrix停更,改为resilence4j</p>
<p>​        或者阿里巴巴的sentienl</p>
<p>5.Zuul改为gateway</p>
<p>6,服务配置Config改为  Nacos</p>
<p>7,服务总线Bus改为Nacos</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建:"></a>环境搭建:</h1><h2 id="1-创建父工程-pom依赖"><a href="#1-创建父工程-pom依赖" class="headerlink" title="1,创建父工程,pom依赖"></a>1,创建父工程,pom依赖</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">代码...</span><br></pre></td></tr></table></figure>

<h2 id="2-创建子模块-pay模块"><a href="#2-创建子模块-pay模块" class="headerlink" title="2,创建子模块,pay模块"></a>2,创建子模块,pay模块</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%843.png" alt></p>
<h3 id="1-子模块名字"><a href="#1-子模块名字" class="headerlink" title="1,子模块名字:"></a>1,子模块名字:</h3><p>​        cloud_pay_8001</p>
<h3 id="2-pom依赖"><a href="#2-pom依赖" class="headerlink" title="2,pom依赖"></a>2,pom依赖</h3><h3 id="3-创建application-yml"><a href="#3-创建application-yml" class="headerlink" title="3,创建application.yml"></a>3,创建application.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">8001</span>   </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">	<span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="comment"># mysql驱动类</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db2019?useUnicode=true&amp;characterEncoding=</span></span><br><span class="line">            <span class="string">UTF-8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span>								</span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">mybatis:</span>			</span><br><span class="line">    <span class="attr">mapper-locations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br><span class="line">   	<span class="attr">type-aliases-package:</span> <span class="string">com.eiletxie.springcloud.entities</span></span><br><span class="line">   			<span class="string">它一般对应我们的实体类所在的包，这个时候会自动取对应包中不包括包名的简单类名作为包括包名的别名。多个package之间可以用逗号或者分号等来进行分隔（value的值一定要是包的全）</span></span><br></pre></td></tr></table></figure>

<h3 id="4-主启动类"><a href="#4-主启动类" class="headerlink" title="4,主启动类"></a>4,主启动类</h3><p>​        ….</p>
<h3 id="5-业务类"><a href="#5-业务类" class="headerlink" title="5,业务类"></a>5,业务类</h3><h4 id="1-sql"><a href="#1-sql" class="headerlink" title="1,sql"></a>1,sql</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%844.png" alt></p>
<h4 id="2-实体类"><a href="#2-实体类" class="headerlink" title="2,实体类"></a>2,实体类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%845.png" alt></p>
<h4 id="3-entity类"><a href="#3-entity类" class="headerlink" title="3,.entity类"></a>3,.entity类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%846.png" alt></p>
<h4 id="4-dao层"><a href="#4-dao层" class="headerlink" title="4,dao层:"></a>4,dao层:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%847.png" alt></p>
<h4 id="5-mapper配置文件类"><a href="#5-mapper配置文件类" class="headerlink" title="5,mapper配置文件类"></a>5,mapper配置文件类</h4><p>​                <strong>在resource下,创建mapper/PayMapper.xml</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%848.png" alt></p>
<h4 id="6-写service和serviceImpl"><a href="#6-写service和serviceImpl" class="headerlink" title="6,写service和serviceImpl"></a>6,写service和serviceImpl</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%849.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%8410.png" alt="sc的9"></p>
<h4 id="7-controller"><a href="#7-controller" class="headerlink" title="7,controller"></a>7,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%8411.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%8412.png" alt></p>
<h2 id="3-热部署"><a href="#3-热部署" class="headerlink" title="3,热部署:"></a>3,热部署:</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%8413.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%8414.png" alt></p>
<p>…..</p>
<p>…..</p>
<p>….</p>
<h2 id="4-order模块"><a href="#4-order模块" class="headerlink" title="4,order模块"></a>4,order模块</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csc%E7%9A%843.png" alt></p>
<h3 id="1-pom"><a href="#1-pom" class="headerlink" title="1,pom"></a><strong>1,pom</strong></h3><h3 id="2-yml配置文件"><a href="#2-yml配置文件" class="headerlink" title="2,yml配置文件"></a><strong>2,yml配置文件</strong></h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Corder%E6%A8%A1%E5%9D%971.png" alt></p>
<h3 id="3-主启动类"><a href="#3-主启动类" class="headerlink" title="3,主启动类"></a><strong>3,主启动类</strong></h3><h3 id="4-复制pay模块的实体类-entity类"><a href="#4-复制pay模块的实体类-entity类" class="headerlink" title="4.复制pay模块的实体类,entity类"></a><strong>4.复制pay模块的实体类,entity类</strong></h3><h3 id="5-写controller类"><a href="#5-写controller类" class="headerlink" title="5,写controller类"></a><strong>5,写controller类</strong></h3><p>​        因为这里是消费者类,主要是消费,那么就没有service和dao,需要调用pay模块的方法</p>
<p>​        并且这里还没有微服务的远程调用,那么如果要调用另外一个模块,则需要使用基本的api调用</p>
<p>使用RestTemplate调用pay模块,</p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Corder%E6%A8%A1%E5%9D%972.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Corder%E6%A8%A1%E5%9D%973.png" alt></p>
<p>​    将restTemplate注入到容器</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Corder%E6%A8%A1%E5%9D%974.png" alt></p>
<p>编写controller:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Corder%E6%A8%A1%E5%9D%975.png" alt></p>
<h2 id="5-重构"><a href="#5-重构" class="headerlink" title="5,重构,"></a>5,重构,</h2><p>新建一个模块,将重复代码抽取到一个公共模块中</p>
<h3 id="1-创建commons模块"><a href="#1-创建commons模块" class="headerlink" title="1,创建commons模块"></a>1,创建commons模块</h3><h3 id="2-抽取公共pom"><a href="#2-抽取公共pom" class="headerlink" title="2,抽取公共pom"></a>2,抽取公共pom</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Ccommons%E6%A8%A1%E5%9D%97.png" alt></p>
<h3 id="3-entity和实体类放入commons中"><a href="#3-entity和实体类放入commons中" class="headerlink" title="3,entity和实体类放入commons中"></a>3,entity和实体类放入commons中</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Ccommons%E6%A8%A1%E5%9D%972.png" alt></p>
<h3 id="4-使用mavne-将commone模块打包-install"><a href="#4-使用mavne-将commone模块打包-install" class="headerlink" title="4,使用mavne,将commone模块打包(install),"></a>4,使用mavne,将commone模块打包(install),</h3><p>​        其他模块引入commons</p>
<h1 id="2-服务注册与发现"><a href="#2-服务注册与发现" class="headerlink" title="2,服务注册与发现"></a>2,服务注册与发现</h1><h2 id="6-Eureka"><a href="#6-Eureka" class="headerlink" title="6,Eureka:"></a>6,Eureka:</h2><p>前面我们没有服务注册中心,也可以服务间调用,为什么还要服务注册?</p>
<p>当服务很多时,单靠代码手动管理是很麻烦的,需要一个公共组件,统一管理多服务,包括服务是否正常运行,等</p>
<p>Eureka用于<strong>==服务注册==</strong>,目前官网<strong>已经停止更新</strong></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%841.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%842.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%843.png" alt></p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%844.png" alt></p>
<h3 id="单机版eureka"><a href="#单机版eureka" class="headerlink" title="单机版eureka:"></a><strong>单机版eureka:</strong></h3><h4 id="1-创建项目cloud-eureka-server-7001"><a href="#1-创建项目cloud-eureka-server-7001" class="headerlink" title="1,创建项目cloud_eureka_server_7001"></a><strong>1,创建项目cloud_eureka_server_7001</strong></h4><h4 id="2-引入pom依赖"><a href="#2-引入pom依赖" class="headerlink" title="2,引入pom依赖"></a><strong>2,引入pom依赖</strong></h4><p>​        eurka最新的依赖变了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%845.png" alt></p>
<h4 id="3-配置文件"><a href="#3-配置文件" class="headerlink" title="3,配置文件:"></a>3,配置文件:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%846.png" alt></p>
<h4 id="4-主启动类-1"><a href="#4-主启动类-1" class="headerlink" title="4,主启动类"></a>4,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%847.png" alt></p>
<h4 id="5-此时就可以启动当前项目了"><a href="#5-此时就可以启动当前项目了" class="headerlink" title="5,此时就可以启动当前项目了"></a><strong>5,此时就可以启动当前项目了</strong></h4><h4 id="6-其他服务注册到eureka"><a href="#6-其他服务注册到eureka" class="headerlink" title="6,其他服务注册到eureka:"></a><strong>6,其他服务注册到eureka:</strong></h4><p>比如此时pay模块加入eureka:</p>
<h5 id="1-主启动类上-加注解-表示当前是eureka客户端"><a href="#1-主启动类上-加注解-表示当前是eureka客户端" class="headerlink" title="1.主启动类上,加注解,表示当前是eureka客户端"></a>1.主启动类上,加注解,表示当前是eureka客户端</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8410.png" alt></p>
<h5 id="2-修改pom-引入"><a href="#2-修改pom-引入" class="headerlink" title="2,修改pom,引入"></a>2,修改pom,引入</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%848.png" alt></p>
<h5 id="3-修改配置文件"><a href="#3-修改配置文件" class="headerlink" title="3,修改配置文件:"></a>3,修改配置文件:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%849.png" alt></p>
<h5 id="4-pay模块重启-就可以注册到eureka中了"><a href="#4-pay模块重启-就可以注册到eureka中了" class="headerlink" title="4,pay模块重启,就可以注册到eureka中了"></a>4,pay模块重启,就可以注册到eureka中了</h5><p><strong>==order模块的注册是一样的==</strong></p>
<h3 id="集群版eureka"><a href="#集群版eureka" class="headerlink" title="集群版eureka:"></a>集群版eureka:</h3><h4 id="集群原理"><a href="#集群原理" class="headerlink" title="集群原理:"></a>集群原理:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8411.png" alt></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,就是pay模块启动时,注册自己,并且自身信息也放入eureka</span><br><span class="line"><span class="number">2</span>.order模块,首先也注册自己,放入信息,当要调用pay时,先从eureka拿到pay的调用地址</span><br><span class="line"><span class="number">3</span>.通过HttpClient调用</span><br><span class="line"> 	并且还会缓存一份到本地,每<span class="number">30</span>秒更新一次</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8412.png" alt></p>
<p><strong>集群构建原理:</strong></p>
<p>​        互相注册</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8413.png" alt></p>
<h4 id="构建新erueka项目"><a href="#构建新erueka项目" class="headerlink" title="构建新erueka项目"></a><strong>构建新erueka项目</strong></h4><p>名字:cloud_eureka_server_7002</p>
<h5 id="1-pom文件"><a href="#1-pom文件" class="headerlink" title="1,pom文件:"></a>1,pom文件:</h5><p>​        粘贴7001的即可</p>
<h5 id="2-配置文件"><a href="#2-配置文件" class="headerlink" title="2,配置文件:"></a>2,配置文件:</h5><p>​        在写配置文件前,修改一下主机的hosts文件</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8414.png" alt></p>
<p>首先修改之前的7001的eureka项目,因为多个eureka需要互相注册</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8415.png" alt></p>
<p>然后修改7002</p>
<p>​            <strong>7002也是一样的,只不过端口和地址改一下</strong></p>
<h5 id="3-主启动类-1"><a href="#3-主启动类-1" class="headerlink" title="3,主启动类:"></a>3,主启动类:</h5><p>​        复制7001的即可</p>
<h5 id="4-然后启动7001-7002即可"><a href="#4-然后启动7001-7002即可" class="headerlink" title="4,然后启动7001,7002即可"></a>4,然后启动7001,7002即可</h5><p><em><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8416.png" alt></em></p>
<h4 id="将pay-order模块注册到eureka集群中"><a href="#将pay-order模块注册到eureka集群中" class="headerlink" title="将pay,order模块注册到eureka集群中:"></a>将pay,order模块注册到eureka集群中:</h4><h5 id="1-只需要修改配置文件即可"><a href="#1-只需要修改配置文件即可" class="headerlink" title="1,只需要修改配置文件即可:"></a>1,只需要修改配置文件即可:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8417.png" alt></p>
<h5 id="2-两个模块都修改上面的都一样即可"><a href="#2-两个模块都修改上面的都一样即可" class="headerlink" title="2,两个模块都修改上面的都一样即可"></a>2,两个模块都修改上面的都一样即可</h5><p>​            然后启动两个模块</p>
<p>​            要先启动7001,7002,然后是pay模块8001,然后是order(80)</p>
<h3 id="3-将pay模块也配置为集群模式"><a href="#3-将pay模块也配置为集群模式" class="headerlink" title="3,将pay模块也配置为集群模式:"></a>3,将pay模块也配置为集群模式:</h3><h4 id="0-创建新模块-8002"><a href="#0-创建新模块-8002" class="headerlink" title="0,创建新模块,8002"></a>0,创建新模块,8002</h4><p>​    名称: cloud_pay_8002</p>
<h4 id="1-pom文件-复制8001的"><a href="#1-pom文件-复制8001的" class="headerlink" title="1,pom文件,复制8001的"></a>1,pom文件,复制8001的</h4><h4 id="2-pom文件复制8001的"><a href="#2-pom文件复制8001的" class="headerlink" title="2,pom文件复制8001的"></a>2,pom文件复制8001的</h4><h4 id="3-配置文件复制8001的"><a href="#3-配置文件复制8001的" class="headerlink" title="3,配置文件复制8001的"></a>3,配置文件复制8001的</h4><p>​        端口修改一下,改为8002</p>
<p>​        服务名称不用改,用一样的</p>
<h4 id="4-主启动类-复制8001的"><a href="#4-主启动类-复制8001的" class="headerlink" title="4.主启动类,复制8001的"></a>4.主启动类,复制8001的</h4><h4 id="5-mapper-service-controller都复制一份"><a href="#5-mapper-service-controller都复制一份" class="headerlink" title="5,mapper,service,controller都复制一份"></a>5,mapper,service,controller都复制一份</h4><p>​        然后就启动服务即可</p>
<p>​        此时访问order模块,发现并没有负载均衡到两个pay,模块中,而是只访问8001</p>
<p>​        虽然我们是使用RestTemplate访问的微服务,但是也可以负载均衡的</p>
<p>​        <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8418.png" alt></p>
<p><strong>注意这样还不可以,需要让RestTemplate开启负载均衡注解,还可以指定负载均衡算法,默认轮询</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8419.png" alt></p>
<h3 id="4-修改服务主机名和ip在eureka的web上显示"><a href="#4-修改服务主机名和ip在eureka的web上显示" class="headerlink" title="4,修改服务主机名和ip在eureka的web上显示"></a>4,修改服务主机名和ip在eureka的web上显示</h3><p>比如修改pay模块</p>
<h4 id="1-修改配置文件"><a href="#1-修改配置文件" class="headerlink" title="1,修改配置文件:"></a>1,修改配置文件:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8420.png" alt></p>
<h3 id="5-eureka服务发现"><a href="#5-eureka服务发现" class="headerlink" title="5,eureka服务发现:"></a>5,eureka服务发现:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8421.png" alt></p>
<p>以pay模块为例</p>
<h4 id="1-首先添加一个注解-在controller中"><a href="#1-首先添加一个注解-在controller中" class="headerlink" title="1,首先添加一个注解,在controller中"></a>1,首先添加一个注解,在controller中</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8422.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8423.png" alt></p>
<h4 id="2-在主启动类上添加一个注解"><a href="#2-在主启动类上添加一个注解" class="headerlink" title="2,在主启动类上添加一个注解"></a>2,在主启动类上添加一个注解</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8424.png" alt></p>
<p><strong>然后重启8001.访问/payment/discover</strong>y</p>
<h3 id="6-Eureka自我保护"><a href="#6-Eureka自我保护" class="headerlink" title="6,Eureka自我保护:"></a>6,Eureka自我保护:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8426.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8425.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8428.png" alt></p>
<p><strong>eureka服务端配置:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8429.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8430.png" alt></p>
<p>​            <strong>设置接受心跳时间间隔</strong></p>
<p><strong>客户端(比如pay模块):</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CEureka%E7%9A%8431.png" alt></p>
<p><strong>此时启动erueka和pay.此时如果直接关闭了pay,那么erueka会直接删除其注册信息</strong></p>
<h2 id="7-Zookeeper服务注册与发现"><a href="#7-Zookeeper服务注册与发现" class="headerlink" title="7,Zookeeper服务注册与发现:"></a>7,Zookeeper服务注册与发现:</h2><h3 id="1-启动zk-到linux上"><a href="#1-启动zk-到linux上" class="headerlink" title="1,启动zk,到linux上"></a>1,启动zk,到linux上</h3><h3 id="2-创建新的pay模块"><a href="#2-创建新的pay模块" class="headerlink" title="2,创建新的pay模块,"></a>2,创建新的pay模块,</h3><p>单独用于注册到zk中  </p>
<p>名字 : cloud_pay_8003</p>
<h4 id="1-pom依赖"><a href="#1-pom依赖" class="headerlink" title="1,pom依赖"></a>1,pom依赖</h4><h4 id="2-配置文件-1"><a href="#2-配置文件-1" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%843.png" alt></p>
<h4 id="3-主启动类-2"><a href="#3-主启动类-2" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%841.png" alt></p>
<h4 id="4-controller"><a href="#4-controller" class="headerlink" title="4,controller"></a>4,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%842.png" alt></p>
<h4 id="5-然后就可以启动"><a href="#5-然后就可以启动" class="headerlink" title="5,然后就可以启动"></a>5,然后就可以启动</h4><p><strong>此时启动,会报错,因为jar包与我们的zk版本不匹配</strong></p>
<p>解决:<br>        修改pom文件,改为与我们zk版本匹配的jar包</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%844.png" alt></p>
<p><strong>此时8003就注册到zk中了</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">我们在zk上注册的node是临时节点,当我们的服务一定时间内没有发送心跳</span><br><span class="line">  	那么zk就会`将这个服务的node删除了</span><br></pre></td></tr></table></figure>



<p><strong>这里测试,就不写service与dao什么的了</strong></p>
<h3 id="3-创建order消费模块注册到zk"><a href="#3-创建order消费模块注册到zk" class="headerlink" title="3,创建order消费模块注册到zk"></a>3,创建order消费模块注册到zk</h3><h4 id="1-创建项目"><a href="#1-创建项目" class="headerlink" title="1,创建项目"></a>1,创建项目</h4><p>名字: cloud_order_zk_80</p>
<h4 id="2-pom"><a href="#2-pom" class="headerlink" title="2,pom"></a>2,pom</h4><h4 id="3-配置文件-1"><a href="#3-配置文件-1" class="headerlink" title="3,配置文件"></a>3,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%845.png" alt></p>
<h4 id="4主启动类"><a href="#4主启动类" class="headerlink" title="4主启动类:"></a>4主启动类:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%841.png" alt></p>
<h4 id="5-RestTemolate"><a href="#5-RestTemolate" class="headerlink" title="5,RestTemolate"></a>5,RestTemolate</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%846.png" alt="注意,这里使用RestTemolate,要先注册它"></p>
<h4 id="6-controller"><a href="#6-controller" class="headerlink" title="6,controller"></a>6,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%847.png" alt></p>
<p><strong>然后启动即可注册到zk</strong></p>
<h4 id="8-集群版zk注册"><a href="#8-集群版zk注册" class="headerlink" title="8,集群版zk注册:"></a>8,集群版zk注册:</h4><p>只需要修改配置文件:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Czookeeper%E7%9A%845.png" alt></p>
<p>这个connect-string指定多个zk地址即可</p>
<p>connect-string: 1.2.3.4,2.3.4.5</p>
<h4 id><a href="#" class="headerlink" title></a></h4><h2 id="8-Consul"><a href="#8-Consul" class="headerlink" title="8,Consul:"></a>8,Consul:</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%841.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%842.png" alt></p>
<h3 id="1-按照consul"><a href="#1-按照consul" class="headerlink" title="1,按照consul"></a>1,按照consul</h3><p>需要下载一个安装包</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%843.png" alt></p>
<p>启动是一个命令行界面,需要输入consul agen-dev启动</p>
<h3 id="2-创建新的pay模块-8006"><a href="#2-创建新的pay模块-8006" class="headerlink" title="2,创建新的pay模块,8006"></a>2,创建新的pay模块,8006</h3><h4 id="1-项目名字"><a href="#1-项目名字" class="headerlink" title="1,项目名字"></a>1,项目名字</h4><p>cloud_consule_pay_8006</p>
<h4 id="2-pom依赖-1"><a href="#2-pom依赖-1" class="headerlink" title="2,pom依赖"></a>2,pom依赖</h4><h4 id="3-配置文件-2"><a href="#3-配置文件-2" class="headerlink" title="3,配置文件"></a>3,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%844.png" alt></p>
<h4 id="4-主启动类-2"><a href="#4-主启动类-2" class="headerlink" title="4,主启动类"></a>4,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%845.png" alt></p>
<h4 id="5-controller"><a href="#5-controller" class="headerlink" title="5,controller"></a>5,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%846.png" alt></p>
<h4 id="6-启动服务"><a href="#6-启动服务" class="headerlink" title="6,启动服务"></a>6,启动服务</h4><h4 id="-1"><a href="#-1" class="headerlink" title></a></h4><h3 id="3-创建新order模块"><a href="#3-创建新order模块" class="headerlink" title="3,创建新order模块"></a>3,创建新order模块</h3><p>cloud-consul-order-80</p>
<h4 id="1-pom文件-1"><a href="#1-pom文件-1" class="headerlink" title="1,pom文件"></a>1,pom文件</h4><h4 id="2-配置文件-2"><a href="#2-配置文件-2" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%847.png" alt></p>
<h4 id="3-主启动类-3"><a href="#3-主启动类-3" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%845.png" alt></p>
<h4 id="4-RestTemplate注册"><a href="#4-RestTemplate注册" class="headerlink" title="4,RestTemplate注册"></a>4,RestTemplate注册</h4><p>配置类注册</p>
<h4 id="5-controller-1"><a href="#5-controller-1" class="headerlink" title="5,controller"></a>5,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%848.png" alt></p>
<h4 id="6-启动服务-测试"><a href="#6-启动服务-测试" class="headerlink" title="6,启动服务,测试"></a>6,启动服务,测试</h4><h2 id="9-三个注册中心的异同"><a href="#9-三个注册中心的异同" class="headerlink" title="9,三个注册中心的异同:"></a>9,三个注册中心的异同:</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%849.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%8410.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cconsul%E7%9A%8411.png" alt></p>
<h1 id="3-服务调用"><a href="#3-服务调用" class="headerlink" title="3,服务调用"></a>3,服务调用</h1><h2 id="10-Ribbon负载均衡"><a href="#10-Ribbon负载均衡" class="headerlink" title="10,Ribbon负载均衡:"></a>10,Ribbon负载均衡:</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon.png" alt></p>
<p><strong>Ribbon目前也进入维护,基本上不准备更新了</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%842.png" alt></p>
<p><strong>进程内LB(本地负载均衡)</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%845.png" alt></p>
<p><strong>集中式LB(服务端负载均衡)</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%844.png" alt></p>
<p><strong>区别</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%843.png" alt></p>
<p><strong>Ribbon就是负载均衡+RestTemplate</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%846.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%847.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%848.png" alt></p>
<h3 id="使用Ribbon"><a href="#使用Ribbon" class="headerlink" title="使用Ribbon:"></a>使用Ribbon:</h3><h4 id="1-默认我们使用eureka的新版本时-它默认集成了ribbon"><a href="#1-默认我们使用eureka的新版本时-它默认集成了ribbon" class="headerlink" title="1,默认我们使用eureka的新版本时,它默认集成了ribbon:"></a>1,默认我们使用eureka的新版本时,它默认集成了ribbon:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%849.png" alt></p>
<p><strong>==这个starter中集成了reibbon了==</strong></p>
<h4 id="2-我们也可以手动引入ribbon"><a href="#2-我们也可以手动引入ribbon" class="headerlink" title="2,我们也可以手动引入ribbon"></a>2,我们也可以手动引入ribbon</h4><p><strong>放到order模块中,因为只有order访问pay时需要负载均衡</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8410.png" alt></p>
<h4 id="3-RestTemplate类"><a href="#3-RestTemplate类" class="headerlink" title="3,RestTemplate类:"></a>3,RestTemplate类:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8411.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8412.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate的:</span><br><span class="line">		xxxForObject()方法,返回的是响应体中的数据</span><br><span class="line">    xxxForEntity()方法.返回的是entity对象,这个对象不仅仅包含响应体数据,还包含响应体信息(状态码等)</span><br></pre></td></tr></table></figure>





<h4 id="Ribbon常用负载均衡算法"><a href="#Ribbon常用负载均衡算法" class="headerlink" title="Ribbon常用负载均衡算法:"></a>Ribbon常用负载均衡算法:</h4><p><strong>IRule接口,Riboon使用该接口,根据特定算法从所有服务中,选择一个服务,</strong></p>
<p><strong>Rule接口有7个实现类,每个实现类代表一个负载均衡算法</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8414.png" alt></p>
<h4 id="使用Ribbon-1"><a href="#使用Ribbon-1" class="headerlink" title="使用Ribbon:"></a>使用Ribbon:</h4><p><strong>==这里使用eureka的那一套服务==</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8415.png" alt></p>
<p><strong>==也就是不能放在主启动类所在的包及子包下==</strong></p>
<h5 id="1-修改order模块"><a href="#1-修改order模块" class="headerlink" title="1,修改order模块"></a>1,修改order模块</h5><h5 id="2-额外创建一个包"><a href="#2-额外创建一个包" class="headerlink" title="2,额外创建一个包"></a>2,额外创建一个包</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8416.png" alt></p>
<h5 id="3-创建配置类-指定负载均衡算法"><a href="#3-创建配置类-指定负载均衡算法" class="headerlink" title="3,创建配置类,指定负载均衡算法"></a>3,创建配置类,指定负载均衡算法</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8417.png" alt></p>
<h5 id="4-在主启动类上加一个注解"><a href="#4-在主启动类上加一个注解" class="headerlink" title="4,在主启动类上加一个注解"></a>4,在主启动类上加一个注解</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8418.png" alt></p>
<p><strong>表示,访问CLOUD_pAYMENT_SERVICE的服务时,使用我们自定义的负载均衡算法</strong></p>
<h4 id="自定义负载均衡算法"><a href="#自定义负载均衡算法" class="headerlink" title="自定义负载均衡算法:"></a>自定义负载均衡算法:</h4><h5 id="1-ribbon的轮询算法原理"><a href="#1-ribbon的轮询算法原理" class="headerlink" title="1,ribbon的轮询算法原理"></a>1,ribbon的轮询算法原理</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8419.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8421.png" alt></p>
<h5 id="2-自定义负载均衡算法"><a href="#2-自定义负载均衡算法" class="headerlink" title="2,自定义负载均衡算法:"></a>2,自定义负载均衡算法:</h5><p><strong>1,给</strong>pay模块(8001,8002),的controller方法添加一个方法,返回当前节点端口</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8423.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8422.png" alt></p>
<p><strong>2,修改order模块</strong></p>
<p>去掉@LoadBalanced</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8424.png" alt></p>
<h5 id="3-自定义接口"><a href="#3-自定义接口" class="headerlink" title="3,自定义接口"></a>3,自定义接口</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8429.png" alt></p>
<p>​                    ==具体的算法在实现类中实现==</p>
<h5 id="4-接口实现类"><a href="#4-接口实现类" class="headerlink" title="4,接口实现类"></a>4,接口实现类</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8425.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8426.png" alt></p>
<h5 id="5-修改controller"><a href="#5-修改controller" class="headerlink" title="5,修改controller:"></a>5,修改controller:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CRibbon%E7%9A%8428.png" alt></p>
<h5 id="6-启动服务-测试即可"><a href="#6-启动服务-测试即可" class="headerlink" title="6,启动服务,测试即可"></a>6,启动服务,测试即可</h5><h2 id="11-OpenFeign"><a href="#11-OpenFeign" class="headerlink" title="11,OpenFeign"></a>11,OpenFeign</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%841.png" alt></p>
<p><strong>是一个声明式的web客户端,只需要创建一个接口,添加注解即可完成微服务之间的调用</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%842.png" alt></p>
<p>==就是A要调用B,Feign就是在A中创建一个一模一样的B对外提供服务的的接口,我们调用这个接口,就可以服务到B==</p>
<h3 id="Feign与OpenFeign区别"><a href="#Feign与OpenFeign区别" class="headerlink" title="Feign与OpenFeign区别"></a><strong>Feign与OpenFeign区别</strong></h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%843.png" alt></p>
<h3 id="使用OpenFeign"><a href="#使用OpenFeign" class="headerlink" title="使用OpenFeign"></a>使用OpenFeign</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">之前的服务间调用,我们使用的是ribbon+RestTemplate</span><br><span class="line">		现在改为使用Feign</span><br></pre></td></tr></table></figure>

<h4 id="1-新建一个order项目-用于feign测试"><a href="#1-新建一个order项目-用于feign测试" class="headerlink" title="1,新建一个order项目,用于feign测试"></a>1,新建一个order项目,用于feign测试</h4><p>名字cloud_order_feign-80</p>
<h4 id="2-pom文件"><a href="#2-pom文件" class="headerlink" title="2,pom文件"></a>2,pom文件</h4><h4 id="3-配置文件-3"><a href="#3-配置文件-3" class="headerlink" title="3,配置文件"></a>3,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%844.png" alt></p>
<h4 id="4-主启动类-3"><a href="#4-主启动类-3" class="headerlink" title="4,主启动类"></a>4,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%845.png" alt></p>
<h4 id="5-fegin需要调用的其他的服务的接口"><a href="#5-fegin需要调用的其他的服务的接口" class="headerlink" title="5,fegin需要调用的其他的服务的接口"></a>5,fegin需要调用的其他的服务的接口</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%846.png" alt></p>
<h4 id="6-controller-1"><a href="#6-controller-1" class="headerlink" title="6,controller"></a>6,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%847.png" alt></p>
<h4 id="7测试"><a href="#7测试" class="headerlink" title="7测试:"></a>7测试:</h4><p>启动两个erueka(7001,7002)</p>
<p>启动两个pay(8001,8002)</p>
<p>启动当前的order模块</p>
<p><strong>Feign默认使用ribbon实现负载均衡</strong></p>
<h3 id="OpenFeign超时机制"><a href="#OpenFeign超时机制" class="headerlink" title="OpenFeign超时机制:"></a>OpenFeign超时机制:</h3><p>==OpenFeign默认等待时间是1秒,超过1秒,直接报错==</p>
<h4 id="1-设置超时时间-修改配置文件"><a href="#1-设置超时时间-修改配置文件" class="headerlink" title="1,设置超时时间,修改配置文件:"></a>1,设置超时时间,修改配置文件:</h4><p><strong>因为OpenFeign的底层是ribbon进行负载均衡,所以它的超时时间是由ribbon控制</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%848.png" alt></p>
<h3 id="OpenFeign日志"><a href="#OpenFeign日志" class="headerlink" title="OpenFeign日志:"></a>OpenFeign日志:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%849.png" alt></p>
<p><strong>OpenFeign的日志级别有:</strong><br><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%8410.png" alt></p>
<h4 id="1-使用OpenFeign的日志"><a href="#1-使用OpenFeign的日志" class="headerlink" title="1,使用OpenFeign的日志:"></a>1,使用OpenFeign的日志:</h4><p><strong>实现在配置类中添加OpenFeign的日志类</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%8411.png" alt></p>
<h4 id="2-为指定类设置日志级别"><a href="#2-为指定类设置日志级别" class="headerlink" title="2,为指定类设置日志级别:"></a>2,为指定类设置日志级别:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%8413.png" alt></p>
<p><strong>配置文件中:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CFeign%E7%9A%8412.png" alt></p>
<h4 id="3-启动服务即可"><a href="#3-启动服务即可" class="headerlink" title="3,启动服务即可"></a>3,启动服务即可</h4><h1 id="4-服务降级"><a href="#4-服务降级" class="headerlink" title="4,服务降级:"></a>4,服务降级:</h1><h2 id="12-Hystrix服务降级"><a href="#12-Hystrix服务降级" class="headerlink" title="12,Hystrix服务降级"></a>12,Hystrix服务降级</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%842.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%844.png" alt></p>
<h3 id="hystrix中的重要概念"><a href="#hystrix中的重要概念" class="headerlink" title="hystrix中的重要概念:"></a>hystrix中的重要概念:</h3><h4 id="1-服务降级"><a href="#1-服务降级" class="headerlink" title="1,服务降级"></a>1,服务降级</h4><p><strong>比如当某个服务繁忙,不能让客户端的请求一直等待,应该立刻返回给客户端一个备选方案</strong></p>
<h4 id="2-服务熔断"><a href="#2-服务熔断" class="headerlink" title="2,服务熔断"></a>2,服务熔断</h4><p><strong>当某个服务出现问题,卡死了,不能让用户一直等待,需要关闭所有对此服务的访问</strong></p>
<p>​            <strong>然后调用服务降级</strong></p>
<h4 id="3-服务限流"><a href="#3-服务限流" class="headerlink" title="3,服务限流"></a>3,服务限流</h4><p><strong>限流,比如秒杀场景,不能访问用户瞬间都访问服务器,限制一次只可以有多少请求</strong></p>
<h3 id="使用hystrix-服务降级"><a href="#使用hystrix-服务降级" class="headerlink" title="使用hystrix,服务降级:"></a>使用hystrix,服务降级:</h3><h4 id="1-创建带降级机制的pay模块"><a href="#1-创建带降级机制的pay模块" class="headerlink" title="1,创建带降级机制的pay模块 :"></a>1,创建带降级机制的pay模块 :</h4><p>名字: cloud-hystrix-pay-8007</p>
<h5 id="2-pom文件-1"><a href="#2-pom文件-1" class="headerlink" title="2,pom文件"></a>2,pom文件</h5><h5 id="3-配置文件-4"><a href="#3-配置文件-4" class="headerlink" title="3,配置文件"></a>3,配置文件</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%845.png" alt></p>
<h5 id="4-主启动类-4"><a href="#4-主启动类-4" class="headerlink" title="4,主启动类"></a>4,主启动类</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%848.png" alt></p>
<h5 id="5-service"><a href="#5-service" class="headerlink" title="5,service"></a>5,service</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%846.png" alt></p>
<h5 id="6controller"><a href="#6controller" class="headerlink" title="6controller"></a>6controller</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%847.png" alt></p>
<h5 id="7-先测试"><a href="#7-先测试" class="headerlink" title="7,先测试:"></a>7,先测试:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">此时使用压测工具,并发<span class="number">20000</span>个请求,请求会延迟的那个方法,</span><br><span class="line">		压测中,发现,另外一个方法并没有被压测,但是我们访问它时,却需要等待</span><br><span class="line">		这就是因为被压测的方法它占用了服务器大部分资源,导致其他请求也变慢了</span><br></pre></td></tr></table></figure>



<h5 id="8-先不加入hystrix"><a href="#8-先不加入hystrix" class="headerlink" title="8,先不加入hystrix,"></a>8,先不加入hystrix,</h5><h4 id="2-创建带降级的order模块"><a href="#2-创建带降级的order模块" class="headerlink" title="2,创建带降级的order模块:"></a>2,创建带降级的order模块:</h4><h5 id="1-名字-cloud-hystrix-order-80"><a href="#1-名字-cloud-hystrix-order-80" class="headerlink" title="1,名字:  cloud-hystrix-order-80"></a>1,名字:  cloud-hystrix-order-80</h5><h5 id="2-pom-1"><a href="#2-pom-1" class="headerlink" title="2,pom"></a>2,pom</h5><h5 id="3-配置文件-5"><a href="#3-配置文件-5" class="headerlink" title="3,配置文件"></a>3,配置文件</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%849.png" alt></p>
<h5 id="4-主启动类-5"><a href="#4-主启动类-5" class="headerlink" title="4,主启动类"></a>4,主启动类</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8411.png" alt></p>
<h5 id="5-远程调用pay模块的接口"><a href="#5-远程调用pay模块的接口" class="headerlink" title="5,远程调用pay模块的接口:"></a>5,远程调用pay模块的接口:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8412.png" alt></p>
<h5 id="6-controller-2"><a href="#6-controller-2" class="headerlink" title="6,controller:"></a>6,controller:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8413.png" alt></p>
<h5 id="7-测试"><a href="#7-测试" class="headerlink" title="7,测试"></a>7,测试</h5><p>​            启动order模块,访问pay</p>
<p>​            再次压测2万并发,发现order访问也变慢了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8414.png" alt></p>
<p><strong>解决:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8415.png" alt></p>
<h5 id="-2"><a href="#-2" class="headerlink" title></a><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8416.png" alt></h5><h4 id="3-配置服务降级"><a href="#3-配置服务降级" class="headerlink" title="3,配置服务降级:"></a>3,配置服务降级:</h4><h5 id="1-修改pay模块"><a href="#1-修改pay模块" class="headerlink" title="1,修改pay模块"></a>1,修改pay模块</h5><h6 id="1-为service的指定方法-会延迟的方法-添加-HystrixCommand注解"><a href="#1-为service的指定方法-会延迟的方法-添加-HystrixCommand注解" class="headerlink" title="1,为service的指定方法(会延迟的方法)添加@HystrixCommand注解"></a>1,为service的指定方法(会延迟的方法)添加@HystrixCommand注解</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8417.png" alt></p>
<h6 id="2-主启动类上-添加激活hystrix的注解"><a href="#2-主启动类上-添加激活hystrix的注解" class="headerlink" title="2,主启动类上,添加激活hystrix的注解"></a>2,主启动类上,添加激活hystrix的注解</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8418.png" alt></p>
<h6 id="3-触发异常"><a href="#3-触发异常" class="headerlink" title="3,触发异常"></a>3,触发异常</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8419.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8420.png" alt><strong>可以看到,也触发了降级</strong></p>
<h5 id="2-修改order模块-进行服务降级"><a href="#2-修改order模块-进行服务降级" class="headerlink" title="2,修改order模块,进行服务降级"></a>2,修改order模块,进行服务降级</h5><p>一般服务降级,都是放在客户端(order模块),</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8421.png" alt></p>
<h6 id="1-修改配置文件-1"><a href="#1-修改配置文件-1" class="headerlink" title="1,修改配置文件:"></a>1,修改配置文件:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8422.png" alt></p>
<h6 id="2-主启动类添加直接-启用hystrix"><a href="#2-主启动类添加直接-启用hystrix" class="headerlink" title="2,主启动类添加直接,启用hystrix:"></a><strong>2,主启动类添加直接,启用hystrix:</strong></h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8423.png" alt></p>
<p>​    </p>
<h6 id="3-修改controller-添加降级方法什么的"><a href="#3-修改controller-添加降级方法什么的" class="headerlink" title="3,修改controller,添加降级方法什么的"></a>3,修改controller,添加降级方法什么的</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8424.png" alt></p>
<h6 id="4-测试"><a href="#4-测试" class="headerlink" title="4,测试"></a>4,测试</h6><p>启动pay模块,order模块,</p>
<p><strong>注意:,这里pay模块和order模块都开启了服务降级</strong></p>
<p>​            但是order这里,设置了1.5秒就降级,所以访问时,一定会降级</p>
<h5 id="4-重构"><a href="#4-重构" class="headerlink" title="4,重构:"></a>4,重构:</h5><p><strong>上面出现的问题:</strong><br>        1,降级方法与业务方法写在了一块,耦合度高</p>
<p>​        2.每个业务方法都写了一个降级方法,重复代码多</p>
<h5 id="解决重复代码的问题"><a href="#解决重复代码的问题" class="headerlink" title="解决重复代码的问题:"></a><strong>解决重复代码的问题</strong>:</h5><p><strong>配置一个全局的降级方法,所有方法都可以走这个降级方法,至于某些特殊创建,再单独创建方法</strong></p>
<h6 id="1-创建一个全局方法"><a href="#1-创建一个全局方法" class="headerlink" title="1,创建一个全局方法"></a>1,创建一个全局方法</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8426.png" alt></p>
<h6 id="2-使用注解指定其为全局降级方法-默认降级方法"><a href="#2-使用注解指定其为全局降级方法-默认降级方法" class="headerlink" title="2,使用注解指定其为全局降级方法(默认降级方法)"></a>2,使用注解指定其为全局降级方法(默认降级方法)</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8425.png" alt></p>
<h6 id="3-业务方法使用默认降级方法"><a href="#3-业务方法使用默认降级方法" class="headerlink" title="3,业务方法使用默认降级方法:"></a>3,业务方法使用默认降级方法:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8428.png" alt></p>
<h6 id="4-测试-1"><a href="#4-测试-1" class="headerlink" title="4,测试:"></a>4,测试:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8429.png" alt></p>
<h5 id="解决代码耦合度的问题"><a href="#解决代码耦合度的问题" class="headerlink" title="解决代码耦合度的问题:"></a>解决代码耦合度的问题:</h5><p>修改order模块,这里开始,pay模块就不服务降级了,服务降级写在order模块即可</p>
<h6 id="1-Payservice接口是远程调用pay模块的-我们这里创建一个类实现service接口-在实现类中统一处理异常"><a href="#1-Payservice接口是远程调用pay模块的-我们这里创建一个类实现service接口-在实现类中统一处理异常" class="headerlink" title="1,Payservice接口是远程调用pay模块的,我们这里创建一个类实现service接口,在实现类中统一处理异常"></a>1,Payservice接口是远程调用pay模块的,我们这里创建一个类实现service接口,在实现类中统一处理异常</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8430.png" alt></p>
<h6 id="2-修改配置文件-添加"><a href="#2-修改配置文件-添加" class="headerlink" title="2,修改配置文件:添加:"></a>2,修改配置文件:添加:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8431.png" alt></p>
<h6 id="3-让PayService的实现类生效"><a href="#3-让PayService的实现类生效" class="headerlink" title="3,让PayService的实现类生效:"></a>3,让PayService的实现类生效:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8432.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">它的运行逻辑是:</span><br><span class="line">		当请求过来,首先还是通过Feign远程调用pay模块对应的方法</span><br><span class="line">    但是如果pay模块报错,调用失败,那么就会调用PayMentFalbackService类的</span><br><span class="line">    当前同名的方法,作为降级方法</span><br></pre></td></tr></table></figure>

<h6 id="4-启动测试"><a href="#4-启动测试" class="headerlink" title="4,启动测试"></a>4,启动测试</h6><p>启动order和pay正常访问–ok</p>
<p>==此时将pay服务关闭,order再次访问==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8433.png" alt></p>
<p>可以看到,并没有报500错误,而是降级访问==实现类==的同名方法</p>
<p>这样,即使服务器挂了,用户要不要一直等待,或者报错</p>
<p>问题:</p>
<p>​        <strong>这样虽然解决了代码耦合度问题,但是又出现了过多重复代码的问题,每个方法都有一个降级方法</strong></p>
<h3 id="使用服务熔断"><a href="#使用服务熔断" class="headerlink" title="使用服务熔断:"></a>使用服务熔断:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8434.png" alt></p>
<p><strong>比如并发达到1000,我们就拒绝其他用户访问,在有用户访问,就访问降级方法</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8435.png" alt></p>
<h4 id="1-修改前面的pay模块"><a href="#1-修改前面的pay模块" class="headerlink" title="1,修改前面的pay模块"></a>1,修改前面的pay模块</h4><h5 id="1-修改Payservice接口-添加服务熔断相关的方法"><a href="#1-修改Payservice接口-添加服务熔断相关的方法" class="headerlink" title="1,修改Payservice接口,添加服务熔断相关的方法:"></a><strong>1,修改Payservice接口,添加服务熔断相关的方法:</strong></h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8437.png" alt></p>
<p>这里属性整体意思是:<br>            10秒之内(窗口,会移动),如果并发==超过==10个,或者10个并发中,失败了6个,就开启熔断器</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8443.png" alt="image-20200414152637247"></p>
<p>IdUtil是Hutool包下的类,这个Hutool就是整合了所有的常用方法,比如UUID,反射,IO流等工具方法什么的都整合了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8436.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">断路器的打开和关闭,是按照一下<span class="number">5</span>步决定的</span><br><span class="line">  	<span class="number">1</span>,并发此时是否达到我们指定的阈值</span><br><span class="line">  	<span class="number">2</span>,错误百分比,比如我们配置了<span class="number">60</span>%,那么如果并发请求中,<span class="number">10</span>次有<span class="number">6</span>次是失败的,就开启断路器</span><br><span class="line">  	<span class="number">3</span>,上面的条件符合,断路器改变状态为open(开启)</span><br><span class="line">  	<span class="number">4</span>,这个服务的断路器开启,所有请求无法访问</span><br><span class="line">  	<span class="number">5</span>,在我们的时间窗口期,期间,尝试让一些请求通过(半开状态),如果请求还是失败,证明断路器还是开启状态,服务没有恢复</span><br><span class="line">  		如果请求成功了,证明服务已经恢复,断路器状态变为close关闭状态</span><br></pre></td></tr></table></figure>



<h5 id="2-修改controller"><a href="#2-修改controller" class="headerlink" title="2,修改controller"></a>2,修改controller</h5><p>添加一个测试方法;</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8439.png" alt></p>
<h5 id="3-测试"><a href="#3-测试" class="headerlink" title="3,测试:"></a>3,测试:</h5><p>启动pay,order模块</p>
<p>==多次访问,并且错误率超过60%:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8440.png" alt></p>
<p>此时服务熔断,此时即使访问正确的也会报错:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8441.png" alt></p>
<p><strong>但是,当过了几秒后,又恢复了</strong></p>
<p>​                因为在10秒窗口期内,它自己会尝试接收部分请求,发现服务可以正常调用,慢慢的当错误率低于60%,取消熔断</p>
<h3 id="Hystrix所有可配置的属性"><a href="#Hystrix所有可配置的属性" class="headerlink" title="Hystrix所有可配置的属性:"></a>Hystrix所有可配置的属性:</h3><p><strong>全部在这个方法中记录,以成员变量的形式记录,</strong></p>
<p>​        以后需要什么属性,查看这个类即可</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8438.png" alt></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8442.png" alt></p>
<p><strong>==当断路器开启后:==</strong></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8444.png" alt></p>
<p><strong>==其他参数:==</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8445.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8446.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8447.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8448.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8449.png" alt></p>
<p><strong>熔断整体流程:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>请求进来,首先查询缓存,如果缓存有,直接返回</span><br><span class="line">  	如果缓存没有,---&gt;<span class="number">2</span></span><br><span class="line"><span class="number">2</span>,查看断路器是否开启,如果开启的,Hystrix直接将请求转发到降级返回,然后返回</span><br><span class="line">  	如果断路器是关闭的,</span><br><span class="line">				判断线程池等资源是否已经满了,如果已经满了</span><br><span class="line">  					也会走降级方法</span><br><span class="line">  			如果资源没有满,判断我们使用的什么类型的Hystrix,决定调用构造方法还是run方法</span><br><span class="line">        然后处理请求</span><br><span class="line">        然后Hystrix将本次请求的结果信息汇报给断路器,因为断路器此时可能是开启的</span><br><span class="line">          			(因为断路器开启也是可以接收请求的)</span><br><span class="line">        		断路器收到信息,判断是否符合开启或关闭断路器的条件,</span><br><span class="line">				如果本次请求处理失败,又会进入降级方法</span><br><span class="line">        如果处理成功,判断处理是否超时,如果超时了,也进入降级方法</span><br><span class="line">        最后,没有超时,则本次请求处理成功,将结果返回给controller</span><br></pre></td></tr></table></figure>







<h3 id="Hystrix服务监控"><a href="#Hystrix服务监控" class="headerlink" title="Hystrix服务监控:"></a>Hystrix服务监控:</h3><h4 id="HystrixDashboard"><a href="#HystrixDashboard" class="headerlink" title="HystrixDashboard"></a>HystrixDashboard</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8451.png" alt></p>
<h4 id="2-使用HystrixDashboard"><a href="#2-使用HystrixDashboard" class="headerlink" title="2,使用HystrixDashboard:"></a>2,使用HystrixDashboard:</h4><h5 id="1-创建项目-1"><a href="#1-创建项目-1" class="headerlink" title="1,创建项目:"></a>1,创建项目:</h5><p>名字: cloud_hystrixdashboard_9001</p>
<h5 id="2-pom文件-2"><a href="#2-pom文件-2" class="headerlink" title="2,pom文件"></a>2,pom文件</h5><h5 id="3-配置文件-6"><a href="#3-配置文件-6" class="headerlink" title="3,配置文件"></a>3,配置文件</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8452.png" alt></p>
<h5 id="4-主启动类-6"><a href="#4-主启动类-6" class="headerlink" title="4,主启动类"></a>4,主启动类</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8453.png" alt></p>
<h5 id="5-修改所有pay模块-8001-8002-8003…"><a href="#5-修改所有pay模块-8001-8002-8003…" class="headerlink" title="5,修改所有pay模块(8001,8002,8003…)"></a>5,修改所有pay模块(8001,8002,8003…)</h5><p><strong>他们都添加一个pom依赖:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8454.png" alt></p>
<p>之前的pom文件中都添加过了,==这个是springboot的监控组件==</p>
<h5 id="6-启动9001即可"><a href="#6-启动9001即可" class="headerlink" title="6,启动9001即可"></a>6,启动9001即可</h5><p>​            访问: <strong>localhost:9001/hystrix</strong></p>
<h5 id="7-注意-此时仅仅是可以访问HystrixDashboard-并不代表已经监控了8001-8002"><a href="#7-注意-此时仅仅是可以访问HystrixDashboard-并不代表已经监控了8001-8002" class="headerlink" title="7,注意,此时仅仅是可以访问HystrixDashboard,并不代表已经监控了8001,8002"></a>7,注意,此时仅仅是可以访问HystrixDashboard,并不代表已经监控了8001,8002</h5><p>​                            如果要监控,还需要配置:(8001为例)</p>
<p>==8001的主启动类添加:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8455.png" alt></p>
<p><strong>其他8002,8003都是一样的</strong></p>
<h5 id="8-到此-可以启动服务"><a href="#8-到此-可以启动服务" class="headerlink" title="8,到此,可以启动服务"></a>8,到此,可以启动服务</h5><p>启动7001,8001,9001</p>
<p><strong>然后在web界面,指定9001要监控8001:</strong></p>
<h5 id="-3"><a href="#-3" class="headerlink" title></a><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8456.png" alt></h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8457.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8459.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8458.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8460.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8461.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CHystrix%E7%9A%8462.png" alt></p>
<h1 id="5-服务网关"><a href="#5-服务网关" class="headerlink" title="5,服务网关:"></a>5,服务网关:</h1><p>zuul停更了,</p>
<h2 id="13-GateWay"><a href="#13-GateWay" class="headerlink" title="13,GateWay"></a>13,GateWay</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%841.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%842.png" alt></p>
<p><strong>gateway之所以性能号,因为底层使用WebFlux,而webFlux底层使用netty通信(NIO)</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%843.png" alt></p>
<h3 id="GateWay的特性"><a href="#GateWay的特性" class="headerlink" title="GateWay的特性:"></a>GateWay的特性:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%844.png" alt></p>
<h3 id="GateWay与zuul的区别"><a href="#GateWay与zuul的区别" class="headerlink" title="GateWay与zuul的区别:"></a>GateWay与zuul的区别:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%845.png" alt></p>
<h3 id="zuul1-x的模型"><a href="#zuul1-x的模型" class="headerlink" title="zuul1.x的模型:"></a>zuul1.x的模型:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%846.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%847.png" alt></p>
<h3 id="什么是webflux"><a href="#什么是webflux" class="headerlink" title="什么是webflux:"></a>什么是webflux:</h3><p><strong>是一个非阻塞的web框架,类似springmvc这样的</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%848.png" alt></p>
<h3 id="GateWay的一些概念"><a href="#GateWay的一些概念" class="headerlink" title="GateWay的一些概念:"></a>GateWay的一些概念:</h3><h4 id="1-路由"><a href="#1-路由" class="headerlink" title="1,路由:"></a>1,路由:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%849.png" alt></p>
<p>就是根据某些规则,将请求发送到指定服务上</p>
<h4 id="2-断言"><a href="#2-断言" class="headerlink" title="2,断言:"></a>2,断言:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8410.png" alt></p>
<p>就是判断,如果符合条件就是xxxx,反之yyyy</p>
<h4 id="3-过滤"><a href="#3-过滤" class="headerlink" title="3,过滤:"></a>3,过滤:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8411.png" alt></p>
<p>​    <strong>路由前后,过滤请求</strong></p>
<h3 id="GateWay的工作原理"><a href="#GateWay的工作原理" class="headerlink" title="GateWay的工作原理:"></a>GateWay的工作原理:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8412.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8413.png" alt></p>
<h3 id="使用GateWay"><a href="#使用GateWay" class="headerlink" title="使用GateWay:"></a>使用GateWay:</h3><p>想要新建一个GateWay的项目</p>
<p>名字:     cloud_gateway_9527</p>
<h4 id="1-pom-1"><a href="#1-pom-1" class="headerlink" title="1,pom"></a>1,pom</h4><h4 id="2-配置文件-3"><a href="#2-配置文件-3" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8414.png" alt></p>
<h4 id="3-主启动类-4"><a href="#3-主启动类-4" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8415.png" alt></p>
<h4 id="4-针对pay模块-设置路由"><a href="#4-针对pay模块-设置路由" class="headerlink" title="4,针对pay模块,设置路由:"></a>4,针对pay模块,设置路由:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8416.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8418.png" alt></p>
<p><strong>==修改GateWay模块(9527)的配置文件==:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8417.png" alt></p>
<p>这里表示,</p>
<p>​            当访问localhost:9527/payment/get/1时,     </p>
<p>​            路由到localhost:8001/payment/get/1</p>
<h4 id="5-开始测试"><a href="#5-开始测试" class="headerlink" title="5,开始测试"></a>5,开始测试</h4><p><strong>启动7001,8001,9527</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果启动GateWay报错</span><br><span class="line">  	可能是GateWay模块引入了web和监控的starter依赖,需要移除</span><br></pre></td></tr></table></figure>

<p>访问:</p>
<p>​        localhost:9527/payment/get/1</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8419.png" alt></p>
<h4 id="6-GateWay的网关配置"><a href="#6-GateWay的网关配置" class="headerlink" title="6,GateWay的网关配置,"></a>6,GateWay的网关配置,</h4><p>​        <strong>GateWay的网关配置,除了支持配置文件,还支持硬编码方式</strong></p>
<h4 id="7使用硬编码配置GateWay"><a href="#7使用硬编码配置GateWay" class="headerlink" title="7使用硬编码配置GateWay:"></a>7使用硬编码配置GateWay:</h4><h5 id="创建配置类"><a href="#创建配置类" class="headerlink" title="创建配置类:"></a>创建配置类:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8420.png" alt></p>
<h4 id="8-然后重启服务即可"><a href="#8-然后重启服务即可" class="headerlink" title="8,然后重启服务即可"></a>8,然后重启服务即可</h4><h3 id="重构"><a href="#重构" class="headerlink" title="重构:"></a>重构:</h3><p>上面的配置虽然首先了网关,但是是在配置文件中写死了要路由的地址</p>
<p>现在需要修改,不指定地址,而是根据微服务名字进行路由,我们可以在注册中心获取某组微服务的地址</p>
<p>需要:</p>
<p>​        1个eureka,2个pay模块</p>
<h4 id="修改GateWay模块的配置文件"><a href="#修改GateWay模块的配置文件" class="headerlink" title="修改GateWay模块的配置文件:"></a>修改GateWay模块的配置文件:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8421.png" alt></p>
<h4 id="然后就可以启动微服务-测试"><a href="#然后就可以启动微服务-测试" class="headerlink" title="然后就可以启动微服务.测试"></a>然后就可以启动微服务.测试</h4><h3 id="Pridicate断言"><a href="#Pridicate断言" class="headerlink" title="Pridicate断言:"></a>Pridicate断言:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8424.png" alt></p>
<p><strong>我们之前在配置文件中配置了断言:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8422.png" alt></p>
<p><strong>这个断言表示,如果外部访问路径是指定路径,就路由到指定微服务上</strong></p>
<p>可以看到,这里有一个Path,这个是断言的一种,==断言的类型==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8423.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">After:</span><br><span class="line">		可以指定,只有在指定时间后,才可以路由到指定微服务</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8426.png" alt></p>
<p>​                这里表示,只有在==2020年的2月21的15点51分37秒==之后,访问==才可以路由==</p>
<p>​                在此之前的访问,都会报404</p>
<p>如何获取当前时区?**</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8425.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">before:</span><br><span class="line">		与after类似,他说在指定时间之前的才可以访问</span><br><span class="line">between:</span><br><span class="line">		需要指定两个时间,在他们之间的时间才可以访问</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8427.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cookie:</span><br><span class="line">		只有包含某些指定cookie(key,value),的请求才可以路由</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8428.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8429.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Header:</span><br><span class="line">		只有包含指定请求头的请求,才可以路由</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8431.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8432.png" alt></p>
<p>测试:<br><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8433.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">host:</span><br><span class="line">		只有指定主机的才可以访问,</span><br><span class="line">		比如我们当前的网站的域名是www.aa.com</span><br><span class="line">    那么这里就可以设置,只有用户是www.aa.com的请求,才进行路由</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8434.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8435.png" alt="gateway的34"></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8436.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8437.png" alt></p>
<p>可以看到,如果带了域名访问,就可以,但是直接访问ip地址.就报错了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">method:</span><br><span class="line">		只有指定请求才可以路由,比如get请求...</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8438.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path:</span><br><span class="line">		只有访问指定路径,才进行路由</span><br><span class="line">     比如访问,/abc才路由</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8439.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query:</span><br><span class="line">		必须带有请求参数才可以访问</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8440.png" alt></p>
<h3 id="Filter过滤器"><a href="#Filter过滤器" class="headerlink" title="Filter过滤器:"></a>Filter过滤器:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8441.png" alt></p>
<h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期:"></a>生命周期:</h4><p><strong>在请求进入路由之前,和处理请求完成,再次到达路由之前</strong></p>
<h4 id="种类"><a href="#种类" class="headerlink" title="种类:"></a>种类:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8442.png" alt></p>
<p>GateWayFilter,单一的过滤器</p>
<p><strong>与断言类似,比如闲置,请求头,只有特定的请求头才放行,反之就过滤</strong>:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8443.png" alt></p>
<p>GlobalFilter,全局过滤器:</p>
<h4 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器:"></a><strong>自定义过滤器:</strong></h4><p>实现两个接口</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8444.png" alt></p>
<p>​    <strong>然后启动服务,即可,因为过滤器通过@COmponet已经加入到容器了</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8446.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cgateway%E7%9A%8445.png" alt></p>
<h1 id="6-服务配置"><a href="#6-服务配置" class="headerlink" title="6,服务配置:"></a>6,服务配置:</h1><h2 id="Spring-Config分布式配置中心"><a href="#Spring-Config分布式配置中心" class="headerlink" title="Spring Config分布式配置中心:"></a>Spring Config分布式配置中心:</h2><p>==微服务面临的问题==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以看到,每个微服务都需要一个配置文件,并且,如果有几个微服务都需要连接数据库</span><br><span class="line">		那么就需要配<span class="number">4</span>次数据库相关配置,并且当数据库发生改动,那么需要同时修改<span class="number">4</span>个微服务的配置文件才可以</span><br></pre></td></tr></table></figure>

<p>所以有了springconfig配置中心</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%841.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%842.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%844.png" alt></p>
<h3 id="使用配置中心"><a href="#使用配置中心" class="headerlink" title="使用配置中心:"></a>使用配置中心:</h3><h4 id="0-使用github作为配置中心的仓库"><a href="#0-使用github作为配置中心的仓库" class="headerlink" title="0,使用github作为配置中心的仓库:"></a>0,使用github作为配置中心的仓库:</h4><p><strong>初始化git环境:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%845.png" alt></p>
<h4 id="1-新建config模块"><a href="#1-新建config模块" class="headerlink" title="1,新建config模块:"></a>1,新建config模块:</h4><p>名字:   cloud-config-3344</p>
<h4 id="2-pom-2"><a href="#2-pom-2" class="headerlink" title="2,pom"></a>2,pom</h4><h4 id="3-配置文件-7"><a href="#3-配置文件-7" class="headerlink" title="3,配置文件"></a>3,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%846.png" alt></p>
<h4 id="4-主启动类-7"><a href="#4-主启动类-7" class="headerlink" title="4,主启动类"></a>4,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%847.png" alt></p>
<h4 id="5-修改hosts"><a href="#5-修改hosts" class="headerlink" title="5,修改hosts:"></a>5,修改hosts:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%848.png" alt></p>
<h4 id="6-配置完成"><a href="#6-配置完成" class="headerlink" title="6,配置完成"></a>6,配置完成</h4><p>测试,3344是否可以从github上获取配置</p>
<p>启动3344    (要先启动eureka)</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%849.png" alt></p>
<p>它实际上就是,读取到配置文件中的GitHub的地址,然后拼接上/master/config-dev.yml</p>
<h4 id="7-读取配置文件的规则"><a href="#7-读取配置文件的规则" class="headerlink" title="7,读取配置文件的规则:"></a>7,读取配置文件的规则:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8410.png" alt></p>
<p>==2,==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8411.png" alt></p>
<p><strong>这里默认会读取master分支,因为我们配置文件中配置了</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8412.png" alt></p>
<p>==3==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8413.png" alt></p>
<p>注意,这个方式读取到的配置是==json格式==的</p>
<p><strong>所有规则:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8414.png" alt></p>
<h3 id="2-创建配置中心客户端"><a href="#2-创建配置中心客户端" class="headerlink" title="2,创建配置中心客户端:"></a>2,创建配置中心客户端:</h3><h4 id="1-创建config客户端项目"><a href="#1-创建config客户端项目" class="headerlink" title="1,创建config客户端项目"></a>1,创建config客户端项目</h4><p>名字:     cloud-config-client-3355</p>
<h4 id="2-pom-3"><a href="#2-pom-3" class="headerlink" title="2,pom"></a>2,pom</h4><h4 id="3-配置文件-8"><a href="#3-配置文件-8" class="headerlink" title="3,配置文件"></a>3,配置文件</h4><p>注意这个配置文件就不是application.yml</p>
<p>​            而是bootstrap.yml</p>
<p>这个配置文件的作用是,先到配置中心加载配置,然后加载到application.yml中</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8415.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8416.png" alt></p>
<h4 id="4-主启动类-8"><a href="#4-主启动类-8" class="headerlink" title="4,主启动类:"></a>4,主启动类:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8417.png" alt></p>
<h4 id="5-controller类"><a href="#5-controller类" class="headerlink" title="5,controller类"></a>5,controller类</h4><p>就是上面提到的,以rest风格将配置对外暴露</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8418.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8419.png" alt></p>
<p><strong>如果客户端运行正常,就会读取到github上配置文件的,config.info下的配置</strong></p>
<h4 id="6-测试"><a href="#6-测试" class="headerlink" title="6,测试:"></a>6,测试:</h4><p>启动3344,3355</p>
<p>​    访问3355的  /configInfo</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8421.png" alt></p>
<h4 id="7-问题"><a href="#7-问题" class="headerlink" title="7,问题::"></a>7,问题::</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">上面<span class="number">3355</span>确实获取到了配置文件,但是如果此时配置文件修改了,<span class="number">3355</span>是获取不到的</span><br><span class="line">		<span class="number">3344</span>可以实时获取到最新配置文件,但是<span class="number">3355</span>却获取不到</span><br><span class="line">  	除非重启服务</span><br></pre></td></tr></table></figure>

<h4 id="8-实现动态刷新"><a href="#8-实现动态刷新" class="headerlink" title="8,实现动态刷新:"></a><strong>8,实现动态刷新:</strong></h4><h5 id="1-修改3355-添加一个pom依赖"><a href="#1-修改3355-添加一个pom依赖" class="headerlink" title="1,修改3355,添加一个pom依赖:"></a>1,修改3355,添加一个pom依赖:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8422.png" alt></p>
<h5 id="2-修改配置文件-添加一个配置"><a href="#2-修改配置文件-添加一个配置" class="headerlink" title="2,修改配置文件,添加一个配置:"></a>2,修改配置文件,添加一个配置:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8423.png" alt></p>
<h5 id="3-修改controller"><a href="#3-修改controller" class="headerlink" title="3,修改controller:"></a>3,修改controller:</h5><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8424.png" alt></p>
<h5 id="4-此时重启服务"><a href="#4-此时重启服务" class="headerlink" title="4,此时重启服务"></a>4,此时重启服务</h5><p><strong>此时3355还不可以动态获取</strong></p>
<p>因为此时,还需要==外部==发送post请求通知3355</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8425.png" alt></p>
<p><strong>此时在刷新3355,发现可以获取到最新的配置文件了,这就实现了动态获取配置文件,因为3355并没有重启</strong></p>
<p>具体流程就是:</p>
<p>​            我们启动好服务后</p>
<p>​            运维人员,修改了配置文件,然后发送一个post请求通知3355</p>
<p>​            3355就可以获取最新配置文件</p>
<p><strong>问题:</strong></p>
<p>​        如果有多个客户端怎么办(3355,3356,3357…..)</p>
<p>​                        虽然可以使用shell脚本,循环刷新</p>
<p>​        但是,可不可以使用广播,一次通知??</p>
<p>​                    这些springconfig做不到,需要使用springcloud Bus消息总线</p>
<h1 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线:"></a>消息总线:</h1><h2 id="SpringCloud-Bus"><a href="#SpringCloud-Bus" class="headerlink" title="SpringCloud Bus:"></a>SpringCloud Bus:</h2><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8426.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8431.png" alt></p>
<p>注意,这里年张图片,就代表两种广播方式</p>
<p>​            图1:        <strong>它是Bus直接通知给其中一个客户端,由这个客户端开始蔓延,传播给其他所有客户端</strong></p>
<p>​            图2:        它<strong>是通知给配置中心的服务端,有服务端广播给所有客户端</strong></p>
<p><strong>为什么被称为总线?</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8428.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">就是通过消息队列达到广播的效果</span><br><span class="line">  		我们要广播每个消息时,主要放到某个topic中,所有监听的节点都可以获取到</span><br></pre></td></tr></table></figure>





<h3 id="使用Bus"><a href="#使用Bus" class="headerlink" title="使用Bus:"></a>使用Bus:</h3><h4 id="1-配置rabbitmq环境"><a href="#1-配置rabbitmq环境" class="headerlink" title="1,配置rabbitmq环境:"></a>1,配置rabbitmq环境:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8429.png" alt></p>
<h4 id="2-之前只有一个配置中心客户端-这里在创建一个"><a href="#2-之前只有一个配置中心客户端-这里在创建一个" class="headerlink" title="2,之前只有一个配置中心客户端,这里在创建一个"></a><strong>2,之前只有一个配置中心客户端,这里在创建一个</strong></h4><p>​        ==<strong>复制3355即可,创建为3366</strong>==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8430.png" alt></p>
<p>全部复制3355的即可</p>
<h4 id="2-使用Bus实现全局广播"><a href="#2-使用Bus实现全局广播" class="headerlink" title="2,使用Bus实现全局广播"></a>2,使用Bus实现全局广播</h4><p><strong>Bus广播有两种方式:</strong></p>
<p>​        ==就是上面两个图片的两种方式==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8432.png" alt></p>
<p><strong>这两种方式,第二种跟合适,因为:</strong></p>
<p>​            ==第一种的缺点:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cspringconfig%E7%9A%8433.png" alt></p>
<h4 id="配置第二种方式"><a href="#配置第二种方式" class="headerlink" title="配置第二种方式:"></a><strong>配置第二种方式:</strong></h4><h5 id="1-配置3344-配置中心服务端"><a href="#1-配置3344-配置中心服务端" class="headerlink" title="1,配置3344(配置中心服务端):"></a><strong>1,配置3344(配置中心服务端):</strong></h5><h6 id="1-修改配置文件-2"><a href="#1-修改配置文件-2" class="headerlink" title="1,修改配置文件:"></a>1,修改配置文件:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%841.png" alt></p>
<h6 id="2-添加pom"><a href="#2-添加pom" class="headerlink" title="2,添加pom"></a>2,添加pom</h6><p><strong>springboot的监控组件,和消息总线</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%842.png" alt></p>
<h5 id="2-修改3355-配置中心的客户端"><a href="#2-修改3355-配置中心的客户端" class="headerlink" title="2,修改3355(配置中心的客户端)"></a>2,修改3355(配置中心的客户端)</h5><h6 id="1-pom-2"><a href="#1-pom-2" class="headerlink" title="1,pom:"></a>1,pom:</h6><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%842.png" alt="Bus的2"></p>
<h6 id="2-配置文件-4"><a href="#2-配置文件-4" class="headerlink" title="2,配置文件:"></a>2,配置文件:</h6><p>==注意配置文件的名字,要改为bootstrap.yml==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%845.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%844" alt="image-20200415102708661"></p>
<h5 id="3-修改3366-也是配置中心的客户端"><a href="#3-修改3366-也是配置中心的客户端" class="headerlink" title="3,修改3366(也是配置中心的客户端)"></a>3,修改3366(也是配置中心的客户端)</h5><p>​            修改与3355是一模一样的</p>
<h5 id="4-测试-2"><a href="#4-测试-2" class="headerlink" title="4,测试"></a>4,测试</h5><p>启动7001,3344,3355,3366</p>
<p>此时修改GitHub上的配置文件</p>
<p>==此时只需要刷新3344,即可让3355,3366动态获取最新的配置文件==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%846.png" alt></p>
<p>其原理就是:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%847.png" alt></p>
<p><strong>所有客户端都监听了一个rabbitMq的topic,我们将信息放入这个topic,所有客户端都可以送到,从而实时更新</strong></p>
<h4 id="配置定点通知"><a href="#配置定点通知" class="headerlink" title="配置定点通知"></a>配置定点通知</h4><p>​        就是只通知部分服务,比如只通知3355,不通知3366</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%848.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%849.png" alt="Bus的8"></p>
<p><strong>只通知3355</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%8411.png" alt></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CBus%E7%9A%8412.png" alt></p>
<p><strong>可以看到,实际上就是通过==微服务的名称+端口号==进行指定</strong></p>
<h1 id="8-消息驱动"><a href="#8-消息驱动" class="headerlink" title="8,消息驱动:"></a>8,消息驱动:</h1><h2 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream:"></a>Spring Cloud Stream:</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">现在一个很项目可能分为三部分:</span><br><span class="line">			前端---&gt;后端----&gt;大数据</span><br><span class="line">			而后端开发使用消息中间件,可能会使用RabbitMq</span><br><span class="line">			而大数据开发,一般都是使用Kafka,</span><br><span class="line">			那么一个项目中有多个消息中间件,对于程序员,因为人员都不友好</span><br></pre></td></tr></table></figure>

<p>而Spring Cloud Stream就类似jpa,屏蔽底层消息中间件的差异,程序员主要操作Spring Cloud Stream即可</p>
<p>​            不需要管底层是kafka还是rabbitMq</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%841.png" alt></p>
<h3 id="什么是Spring-Cloud-Stream"><a href="#什么是Spring-Cloud-Stream" class="headerlink" title="==什么是Spring Cloud Stream=="></a>==什么是Spring Cloud Stream==</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%842.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%844.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%845.png" alt></p>
<h3 id="Spring-Cloud-Stream是怎么屏蔽底层差异的"><a href="#Spring-Cloud-Stream是怎么屏蔽底层差异的" class="headerlink" title="==Spring Cloud Stream是怎么屏蔽底层差异的?=="></a>==<strong>Spring Cloud Stream是怎么屏蔽底层差异的?</strong>==</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%846.png" alt></p>
<p><strong>绑定器:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%847.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%848.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%849.png" alt></p>
<h3 id="Spring-Cloud-Streamd-通信模式"><a href="#Spring-Cloud-Streamd-通信模式" class="headerlink" title="Spring Cloud Streamd 通信模式:"></a><strong>Spring Cloud Streamd 通信模式:</strong></h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8410.png" alt>)<img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8411.png" alt></p>
<h3 id="Spring-Cloud-Stream的业务流程"><a href="#Spring-Cloud-Stream的业务流程" class="headerlink" title="Spring Cloud Stream的业务流程:"></a>Spring Cloud Stream的业务流程:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8412.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8414.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8413.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">类似flume中的channel,source,sink  估计是借鉴(抄袭)的</span><br><span class="line">  	source用于获取数据(要发送到mq的数据)</span><br><span class="line">  	channel类似SpringCloudStream中的中间件,用于存放source接收到的数据,或者是存放binder拉取的数据</span><br></pre></td></tr></table></figure>







<h3 id="常用注解和api"><a href="#常用注解和api" class="headerlink" title="常用注解和api:"></a>常用注解和api:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8415.png" alt></p>
<h3 id="使用SpringCloudStream"><a href="#使用SpringCloudStream" class="headerlink" title="使用SpringCloudStream:"></a>使用SpringCloudStream:</h3><p>需要创建三个项目,一个生产者,两个消费者</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8416.png" alt></p>
<h3 id="1-创建生产者"><a href="#1-创建生产者" class="headerlink" title="1,创建生产者"></a>1,创建生产者</h3><h4 id="1-pom-3"><a href="#1-pom-3" class="headerlink" title="1,pom"></a>1,pom</h4><h4 id="2-配置文件-5"><a href="#2-配置文件-5" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8417" alt="image-20200415114816133"></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8418.png" alt></p>
<h4 id="3-主启动类-5"><a href="#3-主启动类-5" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8419.png" alt></p>
<h4 id="4-service和实现类"><a href="#4-service和实现类" class="headerlink" title="4,service和实现类"></a>4,service和实现类</h4><p>service定义发送消息</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8420.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8421.png" alt></p>
<p><strong>这里,就会调用send方法,将消息发送给channel,</strong></p>
<p>​                <strong>然后channel将消费发送给binder,然后发送到rabbitmq中</strong></p>
<h4 id="5-controller-2"><a href="#5-controller-2" class="headerlink" title="5,controller"></a>5,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8422.png" alt></p>
<h4 id="6-可以测试"><a href="#6-可以测试" class="headerlink" title="6,可以测试"></a>6,可以测试</h4><p><strong>启动rabbitmq</strong></p>
<p><strong>启动7001,8801</strong></p>
<p>​        确定8801后,会在rabbitmq中创建一个Exchange,就是我们配置文件中配置的exchange</p>
<p><strong>访问8801的/sendMessage</strong></p>
<h3 id="创建消费者"><a href="#创建消费者" class="headerlink" title="创建消费者:"></a>创建消费者:</h3><h4 id="1-pom文件-2"><a href="#1-pom文件-2" class="headerlink" title="1,pom文件"></a>1,pom文件</h4><h4 id="2-配置文件-6"><a href="#2-配置文件-6" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p>==<strong>这里排版一点问题</strong>==</p>
<p><strong>==input==就表示,当前服务是一个消费者,需要消费消息,下面就是指定消费哪个Exchange中的消息</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8423.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8424.png" alt></p>
<h4 id="3-主启动类-6"><a href="#3-主启动类-6" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8425.png" alt></p>
<h4 id="4-业务类-消费数据"><a href="#4-业务类-消费数据" class="headerlink" title="4,业务类(消费数据)"></a>4,业务类(消费数据)</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8426.png" alt></p>
<p><strong>生产者发送消息时,使用send方法发送,send方法发送的是一个个Message,里面封装了数据</strong></p>
<h4 id="5-测试"><a href="#5-测试" class="headerlink" title="5,测试:"></a>5,测试:</h4><p>启动7001.8801.8802</p>
<p><strong>此时使用生产者生产消息</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8427.png" alt></p>
<p>==可以看到,消费者已经接收到消息了==</p>
<h3 id="创建消费者2"><a href="#创建消费者2" class="headerlink" title="创建消费者2"></a>创建消费者2</h3><p>创建8803,</p>
<p>==与8802创建一模一样,就不写了==</p>
<p><strong>创建8803主要是为了演示重复消费等问题</strong></p>
<p>…</p>
<p>….</p>
<p>…</p>
<h3 id="重复消费问题"><a href="#重复消费问题" class="headerlink" title="==重复消费问题:=="></a>==重复消费问题:==</h3><p>此时启动7001.8801.8802.8803</p>
<p>此时生产者生产一条消息</p>
<p>但是此时查询消费者,发现8802,8803==都消费到了同一条数据==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8428.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8429.png" alt></p>
<h4 id="1-自定义分组"><a href="#1-自定义分组" class="headerlink" title="1,自定义分组"></a>1,自定义分组</h4><p><strong>修改8802,8803的配置文件</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8430.png" alt></p>
<p>![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\SpringCloudStream的31 - 副本.png)</p>
<p><strong>现在将8802,8803都分到了A组</strong></p>
<p>然后去重启02,03</p>
<p><strong>然后此时生产者生产两条消息</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8433.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8434.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CSpringCloudStream%E7%9A%8435.png" alt></p>
<p><strong>可以看到,每人只消费了一条消息,并且没有重复消费</strong></p>
<h3 id="持久化问题"><a href="#持久化问题" class="headerlink" title="持久化问题:"></a>持久化问题:</h3><p>就是当服务挂了,怎么消费没有消费的数据??</p>
<p>这里,先将8802移除A组,</p>
<p>​        然后将02,03服务关闭</p>
<p>此时生产者开启,发送3条消息</p>
<p>​        此时重启02,03</p>
<p>​        可以看到,当02退出A组后,它就获取不到在它宕机的时间段内的数据</p>
<p>​        但是03重启后,直接获取到了宕机期间它没有消费的数据,并且消费了</p>
<p>总结:<br>        也就是,当我们没有配置分组时,会出现消息漏消费的问题</p>
<p>​        而配置分组后,我们可以自动获取未消费的数据</p>
<h1 id="9-链路追踪"><a href="#9-链路追踪" class="headerlink" title="9,链路追踪:"></a>9,链路追踪:</h1><h2 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h2><p><strong>sleuth要解决的问题:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%841.png" alt></p>
<p><strong>而来sleuth就是用于追踪每个请求的整体链路</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%842.png" alt></p>
<h3 id="使用sleuth"><a href="#使用sleuth" class="headerlink" title="使用sleuth:"></a>使用sleuth:</h3><h4 id="1-安装zipkin"><a href="#1-安装zipkin" class="headerlink" title="1,安装zipkin:"></a>1,安装zipkin:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%843.png" alt></p>
<p><strong>运行jar包</strong></p>
<p>​            java -jar xxxx.jar</p>
<p><strong>然后就可以访问web界面,  默认zipkin监听的端口是9411</strong></p>
<p>​            localhost:9411/zipkin/</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%844.png" alt></p>
<p><strong>一条链路完整图片:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%845.png" alt></p>
<p><strong>精简版:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%846.png" alt></p>
<p><strong>可以看到,类似链表的形式</strong></p>
<h4 id="2-使用sleuth"><a href="#2-使用sleuth" class="headerlink" title="2,使用sleuth:"></a>2,使用sleuth:</h4><p>不需要额外创建项目,使用之前的8001和order的80即可</p>
<h5 id="1-修改8001"><a href="#1-修改8001" class="headerlink" title="1,修改8001"></a>1,修改8001</h5><p><strong>引入pom:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%847.png" alt></p>
<p>这个包虽然叫zipkin但是,里面包含了zpikin与sleuth</p>
<p><strong>修改配置文件:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%848.png" alt></p>
<h5 id="2-修改80"><a href="#2-修改80" class="headerlink" title="2,修改80"></a>2,修改80</h5><p><strong>添加pom</strong></p>
<p>与上面是一样的</p>
<p><strong>添加配置</strong>:</p>
<p>与上面也是一样的</p>
<h5 id="3-测试-1"><a href="#3-测试-1" class="headerlink" title="3,测试:"></a>3,测试:</h5><p>启动7001.8001,80,9411</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csleuth%E7%9A%849.png" alt></p>
<h1 id="10-Spring-CloudAlibaba"><a href="#10-Spring-CloudAlibaba" class="headerlink" title="10,Spring CloudAlibaba:"></a>10,Spring CloudAlibaba:</h1><p><strong>之所以有Spring CloudAlibaba,是因为Spring Cloud Netflix项目进入维护模式</strong></p>
<p>​        <strong>也就是,就不是不更新了,不会开发新组件了</strong></p>
<p>​        <strong>所以,某些组件都有代替版了,比如Ribbon由Loadbalancer代替,等等</strong></p>
<p>==支持的功能==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%841.png" alt></p>
<p>几乎可以将之前的Spring Cloud代替</p>
<p>==具体组件==:<br><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%842.png" alt></p>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos:"></a>Nacos:</h2><p><strong>服务注册和配置中心的组合</strong></p>
<p>​            Nacos=erueka+config+bus</p>
<h3 id="安装Nacos"><a href="#安装Nacos" class="headerlink" title="安装Nacos:"></a>安装Nacos:</h3><p>需要java8  和 Mavne</p>
<p><strong>1,到github上下载安装包</strong></p>
<p>​        解压安装包</p>
<p><strong>2,启动Nacos</strong></p>
<p>​        在bin下,进入cod</p>
<p>​        ./startup.cmd</p>
<p><strong>3,访问Nacos</strong></p>
<p>​        Nacos默认监听8848</p>
<p>​        localhost:8848/nacos</p>
<p>​        账号密码:默认都是nacos</p>
<h3 id="使用Nacos"><a href="#使用Nacos" class="headerlink" title="使用Nacos:"></a>使用Nacos:</h3><p>新建pay模块</p>
<p>​        <strong>现在不需要额外的服务注册模块了,Nacos单独启动了</strong></p>
<p>名字: cloudalibaba-pay-9001</p>
<h4 id="1-pom-4"><a href="#1-pom-4" class="headerlink" title="1,pom"></a>1,pom</h4><p>父项目管理alibaba的依赖:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%844.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%843.png" alt></p>
<p>==9001的pom==:</p>
<p>​            另外一个文件…..</p>
<h4 id="2-配置文件-7"><a href="#2-配置文件-7" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%845.png" alt></p>
<h4 id="3-启动类"><a href="#3-启动类" class="headerlink" title="3,启动类"></a>3,启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%846.png" alt></p>
<h4 id="4-controller-1"><a href="#4-controller-1" class="headerlink" title="4,controller:"></a>4,controller:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%847.png" alt></p>
<h4 id="5-测试-1"><a href="#5-测试-1" class="headerlink" title="5,测试"></a>5,测试</h4><p>启动9001</p>
<p>然后查看Nacos的web界面,可以看到9001已经注册成功</p>
<h3 id="-4"><a href="#-4" class="headerlink" title></a></h3><h3 id="创建其他Pay模块"><a href="#创建其他Pay模块" class="headerlink" title="创建其他Pay模块"></a>创建其他Pay模块</h3><p>​        额外在创建9002,9003</p>
<p>​        直接复制上面的即可</p>
<h3 id="创建order模块"><a href="#创建order模块" class="headerlink" title="创建order模块"></a>创建order模块</h3><p>名字:  cloudalibaba-order-83</p>
<h4 id="1-pom-5"><a href="#1-pom-5" class="headerlink" title="1,pom"></a>1,pom</h4><p><strong>为什么Nacos支持负载均衡?</strong></p>
<p>​                Nacos直接集成了Ribon,所以有负载均衡</p>
<h4 id="2-配置文件-8"><a href="#2-配置文件-8" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%848.png" alt></p>
<p><strong>这个server-url的作用是,我们在controller,需要使用RestTempalte远程调用9001,</strong></p>
<p>​        <strong>这里是指定9001的地址</strong></p>
<h4 id="3-主启动类-7"><a href="#3-主启动类-7" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%849.png" alt></p>
<h4 id="4-编写配置类"><a href="#4-编写配置类" class="headerlink" title="4,编写配置类"></a>4,编写配置类</h4><p>​    ==因为Naocs要使用Ribbon进行负载均衡,那么就需要使用RestTemplate==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8410.png" alt></p>
<h4 id="5-controller-3"><a href="#5-controller-3" class="headerlink" title="5,controller:"></a>5,controller:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8411.png" alt></p>
<h4 id="6-测试-1"><a href="#6-测试-1" class="headerlink" title="6,测试"></a>6,测试</h4><p>启动83,访问9001,9002,可以看到,实现了负载均衡</p>
<h3 id="Nacos与其他服务注册的对比"><a href="#Nacos与其他服务注册的对比" class="headerlink" title="Nacos与其他服务注册的对比"></a>Nacos与其他服务注册的对比</h3><p>Nacos它既可以支持CP,也可以支持AP,可以切换</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8412.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8413.png" alt></p>
<p>==下面这个curl命令,就是切换模式==</p>
<h3 id="使用Nacos作为配置中心"><a href="#使用Nacos作为配置中心" class="headerlink" title="使用Nacos作为配置中心:"></a>使用Nacos作为配置中心:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8414.png" alt></p>
<p><strong>==需要创建配置中心的客户端模块==</strong></p>
<p>cloudalibaba-Nacos-config-client-3377</p>
<h4 id="1-pom-6"><a href="#1-pom-6" class="headerlink" title="1,pom"></a>1,pom</h4><h4 id="2-配置文件-9"><a href="#2-配置文件-9" class="headerlink" title="2,配置文件"></a>2,配置文件</h4><p>这里需要配置两个配置文件,application.ymk和bootstarp.yml</p>
<p>​            主要是为了可以与spring clodu config无缝迁移</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8415.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以看到</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8416.png" alt></p>
<h4 id="3-主启动类-8"><a href="#3-主启动类-8" class="headerlink" title="3,主启动类"></a>3,主启动类</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8418.png" alt></p>
<h4 id="4-controller-2"><a href="#4-controller-2" class="headerlink" title="4,controller"></a>4,controller</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8417.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以看到,这里也添加了<span class="meta">@RefreshScope</span></span><br><span class="line">  		之前在Config配置中心,也是添加这个注解实现动态刷新的</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8419.png" alt></p>
<h4 id="5-在Nacos添加配置信息"><a href="#5-在Nacos添加配置信息" class="headerlink" title="5,在Nacos添加配置信息:"></a>5,在Nacos添加配置信息:</h4><p>==<strong>Nacos的配置规则:</strong>==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8420.png" alt></p>
<p><strong>配置规则,就是我们在客户端如何指定读取配置文件,配置文件的命名的规则</strong></p>
<p>默认的命名方式:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8421.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">prefix:</span><br><span class="line">		默认就是当前服务的服务名称</span><br><span class="line"> 		也可以通过spring.cloud.necos.config.prefix配置</span><br><span class="line">spring.profile.active:</span><br><span class="line">		就是我们在application.yml中指定的,当前是开发环境还是测试等环境</span><br><span class="line">    这个可以不配置,如果不配置,那么前面的 -  也会没有</span><br><span class="line">file-extension</span><br><span class="line">     就是当前文件的格式(后缀),目前只支持yml和properties</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8424.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8425.png" alt></p>
<p>==在web UI上创建配置文件:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8422.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8423.png" alt></p>
<p>注意,DataId就是配置文件名字:</p>
<p>​        名字一定要按照上面的==规则==命名,否则客户端会读取不到配置文件</p>
<h4 id="6-测试-2"><a href="#6-测试-2" class="headerlink" title="6,测试"></a>6,测试</h4><p>重启3377客户端</p>
<p>访问3377</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8426.png" alt></p>
<p><strong>拿到了配置文件中的值</strong></p>
<h4 id="7-注意默认就开启了自动刷新"><a href="#7-注意默认就开启了自动刷新" class="headerlink" title="7,注意默认就开启了自动刷新"></a>7,注意默认就开启了自动刷新</h4><p>此时我们修改了配置文件</p>
<p>客户端是可以立即更新的</p>
<p>​            因为Nacos支持Bus总线,会自动发送命令更新所有客户端</p>
<h3 id="Nacos配置中心之分类配置"><a href="#Nacos配置中心之分类配置" class="headerlink" title="Nacos配置中心之分类配置:"></a>Nacos配置中心之分类配置:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8428.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8429.png" alt></p>
<p>NameSpace默认有一个:public名称空间</p>
<p>这三个类似java的: 包名 + 类名 + 方法名</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8430.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8431.png" alt></p>
<h4 id="1-配置不同DataId"><a href="#1-配置不同DataId" class="headerlink" title="1,配置不同DataId:"></a>1,配置不同DataId:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8432.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8433.png" alt></p>
<p>​    ==通过配置文件,实现多环境的读取:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8434.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此时,改为dev,就会读取dev的配置文件,改为test,就会读取test的配置文件</span><br></pre></td></tr></table></figure>





<h4 id="2-配置不同的GroupID"><a href="#2-配置不同的GroupID" class="headerlink" title="2,配置不同的GroupID:"></a>2,配置不同的GroupID:</h4><p>直接在新建配置文件时指定组</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8435.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8436.png" alt></p>
<p>==在客户端配置,使用指定组的配置文件:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8437.png" alt></p>
<p><strong>这两个配置文件都要修改</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8438.png" alt></p>
<p>​    </p>
<p>重启服务,即可</p>
<h4 id="配置不同的namespace"><a href="#配置不同的namespace" class="headerlink" title="配置不同的namespace:"></a>配置不同的namespace:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8439.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8442.png" alt></p>
<p>==客户端配置使用不同名称空间:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8441.png" alt></p>
<p><strong>要通过命名空间id指定</strong></p>
<p>OK,测试</p>
<h3 id="Nacos集群和持久化配置"><a href="#Nacos集群和持久化配置" class="headerlink" title="Nacos集群和持久化配置:"></a>Nacos集群和持久化配置:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8445.png" alt></p>
<p>Nacos默认有自带嵌入式数据库,derby,但是如果做集群模式的话,就不能使用自己的数据库</p>
<p>​            不然每个节点一个数据库,那么数据就不统一了,需要使用外部的mysql</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8443.png" alt></p>
<h4 id="1-单机版-切换mysql数据库"><a href="#1-单机版-切换mysql数据库" class="headerlink" title="1,单机版,切换mysql数据库:"></a>1,单机版,切换mysql数据库:</h4><p>​                    <strong>将nacos切换到使用我们自己的mysql数据库:</strong></p>
<p><strong>1,nacos默认自带了一个sql文件,在nacos安装目录下</strong></p>
<p>​            将它放到我们的mysql执行</p>
<p><strong>2,修改Nacos安装目录下的安排application.properties,添加:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8446.png" alt></p>
<p><strong>3,此时可以重启nacos,那么就会改为使用我们自己的mysql</strong></p>
<h4 id="Linux上配置Nacos集群-Mysql数据库"><a href="#Linux上配置Nacos集群-Mysql数据库" class="headerlink" title="Linux上配置Nacos集群+Mysql数据库"></a>Linux上配置Nacos集群+Mysql数据库</h4><p>==官方架构图:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8445.png" alt></p>
<p><strong>需要一个Nginx作为VIP</strong></p>
<p>1,下载安装Nacos的Linux版安装包</p>
<p>2,进入安装目录,现在执行自带的sql文件</p>
<p>​            进入mysql,执行sql文件</p>
<p>3.修改配置文件,切换为我们的mysql</p>
<p>​            就是上面windos版要修改的几个属性</p>
<p>4,修改cluster.conf,指定哪几个节点是Nacos集群</p>
<p>​            这里使用3333,4444,5555作为三个Nacos节点监听的端口</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8447.png" alt></p>
<p>5,我们这里就不配置在不同节点上了,就放在一个节点上</p>
<p>​            既然要在一个节点上启动不同Nacos实例,就要修改startup.sh,使其根据不同端口启动不同Nacos实例</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8448.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8449.png" alt></p>
<p>可以看到,这个脚本就是通过jvm启动nacos</p>
<p>​        所以我们最后修改的就是,nohup java -Dserver.port=3344</p>
<p>6,配置Nginx:</p>
<p>​            <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8450.png" alt></p>
<p>7,启动Nacos:<br>            ./startup.sh -p 3333</p>
<p>​            ./startup.sh -p 4444</p>
<p>​            ./startup.sh -p 5555</p>
<p>7,启动nginx</p>
<p>8,测试:</p>
<p>​        访问192.168.159.121:1111</p>
<p>​        如果可以进入nacos的web界面,就证明安装成功了</p>
<p>9,将微服务注册到Nacos集群:<br><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8451.png" alt></p>
<p>10,进入Nacos的web界面</p>
<p>​        可以看到,已经注册成功</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8452.png" alt></p>
<h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel:"></a>Sentinel:</h2><p>实现熔断与限流,就是Hystrix</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8453.png" alt></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8454.png" alt></p>
<h3 id="使用sentinel"><a href="#使用sentinel" class="headerlink" title="==使用sentinel:=="></a>==使用sentinel:==</h3><p>1,下载sentinel的jar包</p>
<p>2,运行sentinel</p>
<p>​        由于是一个jar包,所以可以直接java -jar运行    </p>
<p>​        注意,默认sentinel占用8080端口</p>
<p>3,访问sentinel</p>
<p>​        localhost:8080</p>
<h3 id="微服务整合sentinel"><a href="#微服务整合sentinel" class="headerlink" title="微服务整合sentinel:"></a>微服务整合sentinel:</h3><h5 id="1-启动Nacos"><a href="#1-启动Nacos" class="headerlink" title="1,启动Nacos"></a>1,启动Nacos</h5><h5 id="2-新建一个项目-8401-主要用于配置sentinel"><a href="#2-新建一个项目-8401-主要用于配置sentinel" class="headerlink" title="2,新建一个项目,8401,主要用于配置sentinel"></a>2,新建一个项目,8401,主要用于配置sentinel</h5><ol>
<li><p>pom</p>
</li>
<li><p>配置文件</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8455.png" alt></p>
</li>
<li><p>主启动类</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5CAlibaba%E7%9A%8456.png" alt></p>
</li>
<li><p>controller\</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%841.png" alt></p>
</li>
<li><p>到这里就可以启动8401</p>
<p>​    此时我们到sentinel中查看,发现并8401的任何信息</p>
<p>​    是因为,sentinel是懒加载,需要我们执行一次访问,才会有信息</p>
<p>​    访问localhost/8401/testA</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%842.png" alt></p>
</li>
<li><p>可以看到.已经开始监听了</p>
</li>
</ol>
<p>​    </p>
<h3 id="sentinel的流控规则"><a href="#sentinel的流控规则" class="headerlink" title="sentinel的流控规则"></a>sentinel的流控规则</h3><p>流量限制控制规则</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%847.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%843.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%844.png" alt></p>
<p>==流控模式==:</p>
<ol>
<li><p>直接快速失败</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%849.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%845.png" alt></p>
<p>  ==直接失败的效果:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%846.png" alt></p>
</li>
<li><p>线程数:</p>
<p>​        <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%848.png" alt></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8410.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">比如a请求过来,处理很慢,在一直处理,此时b请求又过来了</span><br><span class="line">		此时因为a占用一个线程,此时要处理b请求就只有额外开启一个线程</span><br><span class="line">		那么就会报错</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8411.png" alt></p>
</li>
</ol>
<ol start="3">
<li><p>关联:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8412.png" alt></p>
<p>==应用场景:  比如<strong>支付接口</strong>达到阈值,就要限流下<strong>订单的接口</strong>,防止一直有订单==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8413.png" alt></p>
<p><strong>当testA达到阈值,qps大于1,就让testB之后的请求直接失败</strong></p>
<p>可以使用postman压测</p>
</li>
</ol>
<p>​    </p>
<ol start="4">
<li><p>链路:<br>多个请求调用同一个微服务</p>
</li>
<li><p>预热Warm up:</p>
<p>​     <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8414.png" alt></p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8415.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8416.png" alt></p>
<p>==应用场景==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8417.png" alt></p>
</li>
<li><p>排队等待:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8418.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8419.png" alt></p>
</li>
</ol>
<h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则:"></a>降级规则:</h3><p><strong>就是熔断降级</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8421.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8420.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8422.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8423.png" alt></p>
<h4 id="1-RT配置"><a href="#1-RT配置" class="headerlink" title="1,RT配置:"></a>1,RT配置:</h4><p>新增一个请求方法用于测试</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8424.png" alt></p>
<p>==配置RT:==</p>
<p>​                这里配置的PT,默认是秒级的平均响应时间</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8425.png" alt></p>
<p>默认计算平均时间是: 1秒类进入5个请求,并且响应的平均值超过阈值(这里的200ms),就报错]</p>
<p>​            1秒5请求是Sentinel默认设置的</p>
<p>==测试==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8427.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8426.png" alt></p>
<p><strong>默认熔断后.就直接抛出异常</strong></p>
<h4 id="2-异常比例"><a href="#2-异常比例" class="headerlink" title="2,异常比例:"></a>2,异常比例:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8428.png" alt></p>
<p>修改请求方法</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8429.png" alt></p>
<p>配置:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8431.png" alt></p>
<p>==如果没触发熔断,这正常抛出异常==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8432.png" alt></p>
<p>==触发熔断==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8433.png" alt></p>
<h4 id="3-异常数"><a href="#3-异常数" class="headerlink" title="3, 异常数:"></a>3, 异常数:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8434.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8435.png" alt></p>
<p>一分钟之内,有5个请求发送异常,进入熔断</p>
<h3 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则:"></a>热点规则:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8436.png" alt></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8437.png" alt></p>
<p>比如:</p>
<p>​            localhost:8080/aa?name=aa</p>
<p>​            localhost:8080/aa?name=b’b</p>
<p>​            加入两个请求中,带有参数aa的请求访问频次非常高,我们就现在name==aa的请求,但是bb的不限制</p>
<p>==如何自定义降级方法,而不是默认的抛出异常?==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8438.png" alt></p>
<p><strong>使用@SentinelResource直接实现降级方法,它等同Hystrix的@HystrixCommand</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8439.png" alt></p>
<p>==定义热点规则:==</p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8440.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8442.png" alt></p>
<p><strong>此时我们访问/testHotkey并且带上才是p1</strong></p>
<p>​            如果qps大于1,就会触发我们定义的降级方法</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8441.png" alt></p>
<p><strong>但是我们的参数是P2,就没有问题</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8444.png" alt></p>
<p>只有带了p1,才可能会触发热点限流</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8443.png" alt></p>
<h4 id="2-设置热点规则中的其他选项"><a href="#2-设置热点规则中的其他选项" class="headerlink" title="2,设置热点规则中的其他选项:"></a>2,设置热点规则中的其他选项:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8445.png" alt></p>
<p><strong>需求:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8446.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8447.png" alt></p>
<p>==测试==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8448.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8449.png" alt></p>
<p><strong>注意:</strong></p>
<p>参数类型只支持,8种基本类型+String类</p>
<p>==注意:==</p>
<p>如果我们程序出现异常,是不会走blockHander的降级方法的,因为这个方法只配置了热点规则,没有配置限流规则</p>
<p>我们这里配置的降级方法是sentinel针对热点规则配置的</p>
<p>只有触发热点规则才会降级</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8450.png" alt></p>
<h3 id="3-系统规则"><a href="#3-系统规则" class="headerlink" title="3,系统规则:"></a>3,系统规则:</h3><p>系统自适应限流:<br>            从整体维度对应用入口进行限流</p>
<p>对整体限流,比如设置qps到达100,这里限流会限制整个系统不可以</p>
<p><em><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8451.png" alt></em></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8452.png" alt></p>
<p>==测试==:<br><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8453.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8454.png" alt></p>
<h3 id="SentinelResource注解"><a href="#SentinelResource注解" class="headerlink" title="@SentinelResource注解:"></a>@SentinelResource注解:</h3><p><strong>用于配置降级等功能</strong></p>
<p>1,环境搭建</p>
<ol>
<li><p>为8401添加依赖</p>
<p>添加我们自己的commone包的依赖</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8455.png" alt></p>
</li>
<li><p>额外创建一个controller类</p>
<p>​     <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8456.png" alt></p>
</li>
</ol>
<ol start="3">
<li><p>配置限流</p>
<p><strong>注意,我们这里配置规则,资源名指定的是@SentinelResource注解value的值,</strong></p>
<p><strong>这样也是可以的,也就是不一定要指定访问路径</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8457.png" alt></p>
</li>
<li><p>测试.</p>
<p>可以看到已经进入降级方法了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8458.png" alt></p>
</li>
<li><p>==此时我们关闭8401服务==</p>
<p>可以看到,这些定义的规则是临时的,关闭服务,规则就没有了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%8459.png" alt></p>
</li>
</ol>
<p><strong>可以看到,上面配置的降级方法,又出现Hystrix遇到的问题了</strong></p>
<p>​            降级方法与业务方法耦合</p>
<p>​            每个业务方法都需要对应一个降级方法</p>
<h4 id="自定义限流处理逻辑"><a href="#自定义限流处理逻辑" class="headerlink" title="自定义限流处理逻辑:"></a>自定义限流处理逻辑:</h4><ol>
<li><p>==单独创建一个类,用于处理限流==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%841.png" alt></p>
</li>
<li><p>==在controller中,指定使用自定义类中的方法作为降级方法==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%842.png" alt></p>
</li>
<li><p>==Sentinel中定义流控规则==:</p>
<p>这里资源名,是以url指定,也可以使用@SentinelResource注解value的值指定</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%845.png" alt></p>
</li>
</ol>
<ol start="4">
<li><p>==测试==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%843.png" alt></p>
</li>
<li><p>==整体==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%844.png" alt></p>
</li>
<li></li>
</ol>
<h4 id="SentinelResource注解的其他属性"><a href="#SentinelResource注解的其他属性" class="headerlink" title="@SentinelResource注解的其他属性:"></a>@SentinelResource注解的其他属性:</h4><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%847.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%846.png" alt></p>
<h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断:"></a>服务熔断:</h3><ol>
<li><p><strong>启动nacos和sentinel</strong></p>
</li>
<li><p><strong>新建两个pay模块  9003和9004</strong></p>
<ol>
<li><p>pom</p>
</li>
<li><p>配置文件</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%848.png" alt>*</p>
</li>
<li><p>主启动类 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain9003</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9003<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%849.png" alt></p>
<p><strong>然后启动9003.9004</strong></p>
</li>
</ol>
</li>
<li><p><strong>新建一个order-84消费者模块:</strong></p>
<ol>
<li><p>pom</p>
<p>与上面的pay一模一样</p>
</li>
<li><p>配置文件</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8410.png" alt></p>
</li>
<li><p>主启动类</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8411.png" alt></p>
</li>
<li><p>配置类</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8412.png" alt></p>
</li>
<li><p>controller</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8413.png" alt></p>
</li>
</ol>
</li>
</ol>
<pre><code>6.   **==为业务方法添加fallback来指定降级方法==**:

    ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的14.png)

    ​    ==重启order==

    测试:

    ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的15.png)



     ==所以,fallback是用于管理异常的,当业务方法发生异常,可以降级到指定方法==

    ​            注意,我们这里==并没有使用sentinel配置任何规则==,但是却降级成功,就是因为

    ​            fallback是用于管理异常的,当业务方法发生异常,可以降级到指定方法==



7.   **==为业务方法添加blockHandler,看看是什么效果==**

     ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的16.png)

     **重启84,访问业务方法:**

    ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的17.png)

     可以看到.,直接报错了,并没有降级

    ​                也就是说,blockHandler==只对sentienl定义的规则降级==



8.   **==如果fallback和blockHandler都配置呢?==**]

     ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的18.png)

     **设置qps规则,阈值1**

     ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的19.png)

     ==测试:==

    ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的20.png)



     可以看到,当两个都同时生效时,==blockhandler优先生效==

9.  **==@SentinelResource还有一个属性,exceptionsToIgnore==**

     ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的21.png)

     **exceptionsToIgnore指定一个异常类,**

    ​                    **表示如果当前方法抛出的是指定的异常,不降级,直接对用户抛出异常**

     ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\sentinel的的22.png)</code></pre><h3 id="sentinel整合ribbon-openFeign-fallback"><a href="#sentinel整合ribbon-openFeign-fallback" class="headerlink" title="sentinel整合ribbon+openFeign+fallback"></a>sentinel整合ribbon+openFeign+fallback</h3><ol>
<li><p>修改84模块,使其支持feign</p>
<ol>
<li><p>pom</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8423.png" alt></p>
</li>
<li><p>配置文件</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8424.png" alt></p>
</li>
<li><p>主启动类,也要修改</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8425.png" alt></p>
</li>
<li><p>创建远程调用pay模块的接口</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8426.png" alt></p>
</li>
<li><p>创建这个接口的实现类,用于降级</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8427.png" alt></p>
</li>
<li><p>再次修改接口,指定降级类</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8428.png" alt></p>
</li>
<li><p>controller添加远程调用</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8429.png" alt></p>
</li>
<li><p>测试</p>
<p>启动9003,84</p>
</li>
<li><p>测试,如果关闭9003.看看84会不会降级</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8430.png" alt></p>
<p><strong>可以看到,正常降级了</strong></p>
</li>
</ol>
</li>
</ol>
<p><strong>熔断框架比较</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8431.png" alt></p>
<h3 id="sentinel持久化规则"><a href="#sentinel持久化规则" class="headerlink" title="sentinel持久化规则"></a>sentinel持久化规则</h3><p>默认规则是临时存储的,重启sentinel就会消失</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8432.png" alt></p>
<p><strong>这里以之前的8401为案例进行修改:</strong></p>
<ol>
<li><p>修改8401的pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">添加:</span><br><span class="line"><span class="comment">&lt;!-- SpringCloud ailibaba sentinel-datasource-nacos 持久化需要用到--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>修改配置文件:</p>
<p>添加:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8433.png" alt></p>
<p><strong>实际上就是指定,我们的规则要保证在哪个名称空间的哪个分组下</strong></p>
<pre><code>这里没有指定namespace, 但是是可以指定的</code></pre><p>​            <strong>注意,这里的dataid要与8401的服务名一致</strong></p>
</li>
<li><p><strong>在nacos中创建一个配置文件,dataId就是上面配置文件中指定的</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8434.png" alt></p>
<p>==json中,这些属性的含义:==</p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8435.png" alt></p>
</li>
</ol>
<ol start="4">
<li><p>启动8401:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8436.png" alt></p>
<p>可以看到,直接读取到了规则</p>
</li>
<li><p>关闭8401</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8437.png" alt></p>
</li>
<li><p>此时重启8401,如果sentinel又可以正常读取到规则,那么证明持久化成功</p>
<p>可以看到,又重新出现了</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Csentinel%E7%9A%84%E7%9A%8438.png" alt></p>
</li>
</ol>
<h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata:"></a>Seata:</h2><p>是一个分布式事务的解决方案,</p>
<p><strong>分布式事务中的一些概念,也是seata中的概念:</strong></p>
<p>​        <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%842.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%843.png" alt></p>
<h3 id="seata安装"><a href="#seata安装" class="headerlink" title="seata安装:"></a>seata安装:</h3><ol>
<li><p><strong>下载安装seata的安装包</strong></p>
</li>
<li><p><strong>修改file.conf</strong></p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%844.png" alt></p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%845.png" alt></p>
<p> <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%846.png" alt></p>
</li>
<li><p><strong>mysql建库建表</strong></p>
<p>1,上面指定了数据库为seata,所以创建一个数据库名为seata</p>
<p>2,建表,在seata的安装目录下有一个db_store.sql,运行即可</p>
</li>
<li><p><strong>继续修改配置文件,修改registry.conf</strong></p>
<p>配置seata作为微服务,指定注册中心</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%847.png" alt></p>
</li>
<li><p>启动</p>
<p>先启动nacos</p>
<p>在启动seata-server(运行安装目录下的,seata-server.bat)</p>
</li>
</ol>
<p><strong>业务说明</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%848.png" alt></p>
<p>下单—&gt;库存—&gt;账号余额</p>
<ol>
<li><p>创建三个数据库</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%849.png" alt></p>
</li>
<li><p>创建对应的表</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8410.png" alt></p>
</li>
<li><p>创建回滚日志表,方便查看</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8411.png" alt></p>
<p><strong>注意==每个库都要执行一次==这个sql,生成回滚日志表</strong></p>
</li>
<li><p>==每个业务都创建一个微服务,也就是要有三个微服务,订单,库存,账号==</p>
<p>​     ==订单==,seta-order-2001</p>
<ol>
<li><p>pom</p>
</li>
<li><p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="comment"># 自定义事务组名称需要与seata-server中的对应,我们之前在seata的配置文件中配置的名字</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">fsp_tx_group</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 当前数据源操作类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="comment"># mysql驱动类</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">io:</span></span><br><span class="line">      <span class="attr">seata:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath*:mapper/*.xml</span></span><br></pre></td></tr></table></figure>

<p>还要额外创建其他配置文件,创建一个file.conf:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">transport &#123;</span><br><span class="line">  # tcp udt unix-domain-socket</span><br><span class="line">  type &#x3D; &quot;TCP&quot;</span><br><span class="line">  #NIO NATIVE</span><br><span class="line">  server &#x3D; &quot;NIO&quot;</span><br><span class="line">  #enable heartbeat</span><br><span class="line">  heartbeat &#x3D; true</span><br><span class="line">  #thread factory for netty</span><br><span class="line">  thread-factory &#123;</span><br><span class="line">    boss-thread-prefix &#x3D; &quot;NettyBoss&quot;</span><br><span class="line">    worker-thread-prefix &#x3D; &quot;NettyServerNIOWorker&quot;</span><br><span class="line">    server-executor-thread-prefix &#x3D; &quot;NettyServerBizHandler&quot;</span><br><span class="line">    share-boss-worker &#x3D; false</span><br><span class="line">    client-selector-thread-prefix &#x3D; &quot;NettyClientSelector&quot;</span><br><span class="line">    client-selector-thread-size &#x3D; 1</span><br><span class="line">    client-worker-thread-prefix &#x3D; &quot;NettyClientWorkerThread&quot;</span><br><span class="line">    # netty boss thread size,will not be used for UDT</span><br><span class="line">    boss-thread-size &#x3D; 1</span><br><span class="line">    #auto default pin or 8</span><br><span class="line">    worker-thread-size &#x3D; 8</span><br><span class="line">  &#125;</span><br><span class="line">  shutdown &#123;</span><br><span class="line">    # when destroy server, wait seconds</span><br><span class="line">    wait &#x3D; 3</span><br><span class="line">  &#125;</span><br><span class="line">  serialization &#x3D; &quot;seata&quot;</span><br><span class="line">  compressor &#x3D; &quot;none&quot;</span><br><span class="line">&#125;</span><br><span class="line">service &#123;</span><br><span class="line">  #vgroup-&gt;rgroup</span><br><span class="line">  # 事务组名称</span><br><span class="line">  vgroup_mapping.fsp_tx_group &#x3D; &quot;default&quot;</span><br><span class="line">  #only support single node</span><br><span class="line">  default.grouplist &#x3D; &quot;127.0.0.1:8091&quot;</span><br><span class="line">  #degrade current not support</span><br><span class="line">  enableDegrade &#x3D; false</span><br><span class="line">  #disable</span><br><span class="line">  disable &#x3D; false</span><br><span class="line">  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span><br><span class="line">  max.commit.retry.timeout &#x3D; &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout &#x3D; &quot;-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">client &#123;</span><br><span class="line">  async.commit.buffer.limit &#x3D; 10000</span><br><span class="line">  lock &#123;</span><br><span class="line">    retry.internal &#x3D; 10</span><br><span class="line">    retry.times &#x3D; 30</span><br><span class="line">  &#125;</span><br><span class="line">  report.retry.count &#x3D; 5</span><br><span class="line">  tm.commit.retry.count &#x3D; 1</span><br><span class="line">  tm.rollback.retry.count &#x3D; 1</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">## transaction log store</span><br><span class="line">store &#123;</span><br><span class="line">  ## store mode: file、db</span><br><span class="line">  #mode &#x3D; &quot;file&quot;</span><br><span class="line">  mode &#x3D; &quot;db&quot;</span><br><span class="line"> </span><br><span class="line">  ## file store</span><br><span class="line">  file &#123;</span><br><span class="line">    dir &#x3D; &quot;sessionStore&quot;</span><br><span class="line"> </span><br><span class="line">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    max-branch-session-size &#x3D; 16384</span><br><span class="line">    # globe session size , if exceeded throws exceptions</span><br><span class="line">    max-global-session-size &#x3D; 512</span><br><span class="line">    # file buffer size , if exceeded allocate new buffer</span><br><span class="line">    file-write-buffer-cache-size &#x3D; 16384</span><br><span class="line">    # when recover batch read size</span><br><span class="line">    session.reload.read_size &#x3D; 100</span><br><span class="line">    # async, sync</span><br><span class="line">    flush-disk-mode &#x3D; async</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  ## database store</span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)&#x2F;BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource &#x3D; &quot;dbcp&quot;</span><br><span class="line">    ## mysql&#x2F;oracle&#x2F;h2&#x2F;oceanbase etc.</span><br><span class="line">    db-type &#x3D; &quot;mysql&quot;</span><br><span class="line">    driver-class-name &#x3D; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    url &#x3D; &quot;jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;seata&quot;</span><br><span class="line">    user &#x3D; &quot;root&quot;</span><br><span class="line">    password &#x3D; &quot;root&quot;</span><br><span class="line">    min-conn &#x3D; 1</span><br><span class="line">    max-conn &#x3D; 3</span><br><span class="line">    global.table &#x3D; &quot;global_table&quot;</span><br><span class="line">    branch.table &#x3D; &quot;branch_table&quot;</span><br><span class="line">    lock-table &#x3D; &quot;lock_table&quot;</span><br><span class="line">    query-limit &#x3D; 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">lock &#123;</span><br><span class="line">  ## the lock store mode: local、remote</span><br><span class="line">  mode &#x3D; &quot;remote&quot;</span><br><span class="line"> </span><br><span class="line">  local &#123;</span><br><span class="line">    ## store locks in user&#39;s database</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  remote &#123;</span><br><span class="line">    ## store locks in the seata&#39;s server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">recovery &#123;</span><br><span class="line">  #schedule committing retry period in milliseconds</span><br><span class="line">  committing-retry-period &#x3D; 1000</span><br><span class="line">  #schedule asyn committing retry period in milliseconds</span><br><span class="line">  asyn-committing-retry-period &#x3D; 1000</span><br><span class="line">  #schedule rollbacking retry period in milliseconds</span><br><span class="line">  rollbacking-retry-period &#x3D; 1000</span><br><span class="line">  #schedule timeout retry period in milliseconds</span><br><span class="line">  timeout-retry-period &#x3D; 1000</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">transaction &#123;</span><br><span class="line">  undo.data.validation &#x3D; true</span><br><span class="line">  undo.log.serialization &#x3D; &quot;jackson&quot;</span><br><span class="line">  undo.log.save.days &#x3D; 7</span><br><span class="line">  #schedule delete expired undo_log in milliseconds</span><br><span class="line">  undo.log.delete.period &#x3D; 86400000</span><br><span class="line">  undo.log.table &#x3D; &quot;undo_log&quot;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">## metrics settings</span><br><span class="line">metrics &#123;</span><br><span class="line">  enabled &#x3D; false</span><br><span class="line">  registry-type &#x3D; &quot;compact&quot;</span><br><span class="line">  # multi exporters use comma divided</span><br><span class="line">  exporter-list &#x3D; &quot;prometheus&quot;</span><br><span class="line">  exporter-prometheus-port &#x3D; 9898</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">support &#123;</span><br><span class="line">  ## spring</span><br><span class="line">  spring &#123;</span><br><span class="line">    # auto proxy the DataSource bean</span><br><span class="line">    datasource.autoproxy &#x3D; false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建registry.conf:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type &#x3D; &quot;nacos&quot;</span><br><span class="line"> </span><br><span class="line">  nacos &#123;</span><br><span class="line">    #serverAddr &#x3D; &quot;localhost&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;localhost:8848&quot;</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl &#x3D; &quot;http:&#x2F;&#x2F;localhost:8761&#x2F;eureka&quot;</span><br><span class="line">    application &#x3D; &quot;default&quot;</span><br><span class="line">    weight &#x3D; &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;localhost:6379&quot;</span><br><span class="line">    db &#x3D; &quot;0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout &#x3D; 6000</span><br><span class="line">    connect.timeout &#x3D; 2000</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    serverAddr &#x3D; &quot;http:&#x2F;&#x2F;localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;127.0.0.1:9603&quot;</span><br><span class="line">    application &#x3D; &quot;default&quot;</span><br><span class="line">    region &#x3D; &quot;DEFAULT_ZONE&quot;</span><br><span class="line">    datacenter &#x3D; &quot;DefaultDataCenter&quot;</span><br><span class="line">    cluster &#x3D; &quot;default&quot;</span><br><span class="line">    group &#x3D; &quot;SEATA_GROUP&quot;</span><br><span class="line">    addressWaitTime &#x3D; &quot;3000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name &#x3D; &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">config &#123;</span><br><span class="line">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type &#x3D; &quot;file&quot;</span><br><span class="line"> </span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;localhost&quot;</span><br><span class="line">    namespace &#x3D; &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    app.id &#x3D; &quot;seata-server&quot;</span><br><span class="line">    apollo.meta &#x3D; &quot;http:&#x2F;&#x2F;192.168.1.204:8801&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout &#x3D; 6000</span><br><span class="line">    connect.timeout &#x3D; 2000</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr &#x3D; &quot;http:&#x2F;&#x2F;localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name &#x3D; &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>==实际上,就是要将seata中的我们之前修改的两个配置文件复制到这个项目下==</p>
</li>
<li><p><strong>主启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration<span class="class">.<span class="keyword">class</span>) //取消数据源的自动创建</span></span><br><span class="line"><span class="class">@<span class="title">EnableDiscoveryClient</span></span></span><br><span class="line"><span class="class">@<span class="title">EnableFeignClients</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SeataOrderMain2001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SeataOrderMain2001<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<pre><code>4.   **service层**

     <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface OrderService &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建订单</span><br><span class="line">     * @param order</span><br><span class="line">     */</span><br><span class="line">    void create(Order order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(value = "seata-storage-service")</span><br><span class="line">public interface StorageService &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 减库存</span><br><span class="line">     * @param productId</span><br><span class="line">     * @param count</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(value = "/storage/decrease")</span><br><span class="line">    CommonResult decrease(@RequestParam("productId") Long productId, @RequestParam("count") Integer count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(value = "seata-account-service")</span><br><span class="line">public interface AccountService &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 减余额</span><br><span class="line">     * @param userId</span><br><span class="line">     * @param money</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(value = "/account/decrease")</span><br><span class="line">    CommonResult decrease(@RequestParam("userId") Long userId, @RequestParam("money") BigDecimal money);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl implements OrderService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private OrderDao orderDao;</span><br><span class="line">    @Resource</span><br><span class="line">    private AccountService accountService;</span><br><span class="line">    @Resource</span><br><span class="line">    private StorageService storageService;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建订单-&gt;调用库存服务扣减库存-&gt;调用账户服务扣减账户余额-&gt;修改订单状态</span><br><span class="line">     * 简单说:</span><br><span class="line">     * 下订单-&gt;减库存-&gt;减余额-&gt;改状态</span><br><span class="line">     * GlobalTransactional seata开启分布式事务,异常时回滚,name保证唯一即可</span><br><span class="line">     * @param order 订单对象</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    ///@GlobalTransactional(name = "fsp-create-order", rollbackFor = Exception.class)</span><br><span class="line">    public void create(Order order) &#123;</span><br><span class="line">        // 1 新建订单</span><br><span class="line">        log.info("-----&gt;开始新建订单");</span><br><span class="line">        orderDao.create(order);</span><br><span class="line"></span><br><span class="line">        // 2 扣减库存</span><br><span class="line">        log.info("-----&gt;订单微服务开始调用库存,做扣减Count");</span><br><span class="line">        storageService.decrease(order.getProductId(), order.getCount());</span><br><span class="line">        log.info("-----&gt;订单微服务开始调用库存,做扣减End");</span><br><span class="line"></span><br><span class="line">        // 3 扣减账户</span><br><span class="line">        log.info("-----&gt;订单微服务开始调用账户,做扣减Money");</span><br><span class="line">        accountService.decrease(order.getUserId(), order.getMoney());</span><br><span class="line">        log.info("-----&gt;订单微服务开始调用账户,做扣减End");</span><br><span class="line"></span><br><span class="line">        // 4 修改订单状态,从0到1,1代表已完成</span><br><span class="line">        log.info("-----&gt;修改订单状态开始");</span><br><span class="line">        orderDao.update(order.getUserId(), 0);</span><br><span class="line"></span><br><span class="line">        log.info("-----&gt;下订单结束了,O(∩_∩)O哈哈~");</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>















5.   **dao层,也就是接口**

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1 新建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">create</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2 修改订单状态,从0改为1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> Long userId, @<span class="title">Param</span><span class="params">(<span class="string">"status"</span>)</span> Integer status)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

     ==在resource下创建mapper文件夹,编写mapper.xml==

    <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.eiletxie.springcloud.alibaba.dao.OrderDao"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"BaseResultMap"</span> <span class="attr">type</span>=<span class="string">"com.eiletxie.springcloud.alibaba.domain.Order"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">jdbcType</span>=<span class="string">"BIGINT"</span>&gt;</span><span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"user_id"</span> <span class="attr">property</span>=<span class="string">"userId"</span> <span class="attr">jdbcType</span>=<span class="string">"BIGINT"</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"product_id"</span> <span class="attr">property</span>=<span class="string">"productId"</span> <span class="attr">jdbcType</span>=<span class="string">"BIGINT"</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"count"</span> <span class="attr">property</span>=<span class="string">"count"</span> <span class="attr">jdbcType</span>=<span class="string">"INTEGER"</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"money"</span> <span class="attr">property</span>=<span class="string">"money"</span> <span class="attr">jdbcType</span>=<span class="string">"DECIMAL"</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"status"</span> <span class="attr">property</span>=<span class="string">"status"</span> <span class="attr">jdbcType</span>=<span class="string">"INTEGER"</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"create"</span> <span class="attr">parameterType</span>=<span class="string">"com.eiletxie.springcloud.alibaba.domain.Order"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into t_order(user_id,product_id,count,money,status) values (#&#123;userId&#125;,#&#123;productId&#125;,#&#123;count&#125;,#&#123;money&#125;,0);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span>&gt;</span></span><br><span class="line">        update t_order set status =1 where user_id =#&#123;userId&#125; and status=#&#123;status&#125;;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

6.   **controller层**

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/order/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">create</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        orderService.create(order);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>, <span class="string">"订单创建成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



7.   **entity类(也叫domain类)**

     <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommonResult</span><span class="params">(Integer code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(code, message, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    ![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\seala的12.png)







8.   config配置类

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(&#123;<span class="string">"com.eiletxie.springcloud.alibaba.dao"</span>&#125;)		指定我们的接口的位置</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> EiletXie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Since</span> 2020/3/18 21:51</span></span><br><span class="line"><span class="comment"> * 使用Seata对数据源进行代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProxyConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mybatis.mapperLocations&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mapperLocations;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">druidDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProxy <span class="title">dataSourceProxy</span><span class="params">(DataSource druidDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxy(druidDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sqlSessionFactoryBean</span><span class="params">(DataSourceProxy dataSourceProxy)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSourceProxy);</span><br><span class="line">        ResourcePatternResolver resolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</span><br><span class="line">        bean.setMapperLocations(resolver.getResources(mapperLocations));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



9.   

10.   

11.  

  ==库存==,seta-storage-2002

**==看脑图==**

1.    pom   
2.   配置文件
3.   主启动类
4.    service层
5.    dao层
6.    controller层
7.   
8.   



 ==账号==,seta-account-2003

**==看脑图==**

1.    pom     
2.   配置文件
3.   主启动类
4.   service层
5.    dao层
6.   controller层
7.   
8.   </code></pre><ol start="5">
<li><p><strong>全局创建完成后,首先测试不加seata</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8414.png" alt></p>
</li>
</ol>
<pre><code>![](C:\Users\陈超\Desktop\Linux\springboot+cloud\springcloud\seala的13.png)</code></pre><ol start="6">
<li><p>使用seata:</p>
<p><strong>在==订单模块==的serviceImpl类中的==create方法==添加启动分布式事务的注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	这里添加开启分布式事务的注解,name指定当前全局事务的名称</span></span><br><span class="line"><span class="comment">	rollbackFor表示,发生什么异常需要回滚</span></span><br><span class="line"><span class="comment">	noRollbackFor:表示,发生什么异常不需要回滚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span>(name = <span class="string">"fsp-create-order"</span>,rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">///@<span class="title">GlobalTransactional</span>(<span class="title">name</span> </span>= <span class="string">"fsp-create-order"</span>, rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">void</span> <span class="title">create</span>(<span class="title">Order</span> <span class="title">order</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1 新建订单</span></span><br><span class="line">    log.info(<span class="string">"-----&gt;开始新建订单"</span>);</span><br><span class="line">    orderDao.create(order);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2 扣减库存</span></span><br><span class="line">    log.info(<span class="string">"-----&gt;订单微服务开始调用库存,做扣减Count"</span>);</span><br><span class="line">    storageService.decrease(order.getProductId(), order.getCount());</span><br><span class="line">    log.info(<span class="string">"-----&gt;订单微服务开始调用库存,做扣减End"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 扣减账户</span></span><br><span class="line">    log.info(<span class="string">"-----&gt;订单微服务开始调用账户,做扣减Money"</span>);</span><br><span class="line">    accountService.decrease(order.getUserId(), order.getMoney());</span><br><span class="line">    log.info(<span class="string">"-----&gt;订单微服务开始调用账户,做扣减End"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4 修改订单状态,从0到1,1代表已完成</span></span><br><span class="line">    log.info(<span class="string">"-----&gt;修改订单状态开始"</span>);</span><br><span class="line">    orderDao.update(order.getUserId(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"-----&gt;下订单结束了,O(∩_∩)O哈哈~"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="7">
<li><p>此时在测试</p>
<p>发现,发生异常后,直接回滚了,前面的修改操作都回滚了</p>
</li>
</ol>
<h3 id="setat原理"><a href="#setat原理" class="headerlink" title="setat原理:"></a>setat原理:</h3><p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8415.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8416.png" alt></p>
<p><strong>seata提供了四个模式:</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8417.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8418.png" alt></p>
<p>==第一阶段:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8420.png" alt></p>
<p>​    <img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8419.png" alt></p>
<p>==二阶段之提交==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8421.png" alt></p>
<p>==二阶段之回滚:==</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8422.png" alt></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8423.png" alt></p>
<p>==断点==:</p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8424.png" alt></p>
<p><strong>可以看到,他们的xid全局事务id是一样的,证明他们在一个事务下</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8425.png" alt></p>
<p><strong>before 和 after的原理就是</strong></p>
<p><img src="/2020/11/22/SpringCloud01/SpringCloud/C:%5CUsers%5C%E9%99%88%E8%B6%85%5CDesktop%5CLinux%5Cspringboot+cloud%5Cspringcloud%5Cseala%E7%9A%8426.png" alt></p>
<p><strong>在更新数据之前,先解析这个更新sql,然后查询要更新的数据,进行保存</strong></p>

      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/" class="post-title-link" itemprop="url">MySQL_Advanced_Optimization_01_性能监控篇</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-29 13:44:08 / Modified: 18:18:11" itemprop="dateCreated datePublished" datetime="2020-10-29T13:44:08+08:00">2020-10-29</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>25 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="show-profile-查询剖析"><a href="#show-profile-查询剖析" class="headerlink" title="show profile (查询剖析)"></a>show profile (查询剖析)</h1><p>要使用<code>profiling</code>功能, 首先确保其已开启会话变量:profiling. 默认是关闭OFF(0), 可以通过set指令进行开启.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%profil%&#39;</span><br></pre></td></tr></table></figure>
<p>开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set profiling &#x3D;&#39;ON&#39;; -- 等号右边也可以是1, (0代表关闭, 1代表开启)</span><br></pre></td></tr></table></figure>
<p>profiling设置是会话级别的, 关闭会话则profiling信息会消失.</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AFprofiling.png" alt="开启profiling"></p>
<p>官网给出的<code>show profile</code> 指令格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILE [type [, type] ... ]</span><br><span class="line">    [FOR QUERY n]</span><br><span class="line">    [LIMIT row_count [OFFSET offset]]</span><br><span class="line"></span><br><span class="line">type: &#123;</span><br><span class="line">    ALL</span><br><span class="line">  | BLOCK IO</span><br><span class="line">  | CONTEXT SWITCHES</span><br><span class="line">  | CPU</span><br><span class="line">  | IPC</span><br><span class="line">  | MEMORY</span><br><span class="line">  | PAGE FAULTS</span><br><span class="line">  | SOURCE</span><br><span class="line">  | SWAPS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>show profiles</code>: 注意带s, 该指令会返回最近一批发送到服务端的查询语句的信息(包含query_id, duration, statements),具体返回多少条由<code>profiling_history_size</code>变量决定. 其默认值是15, 上限100. 如果设置为0, 等效于: <code>set profiling =&#39;OFF&#39;;</code>  </p>
<p>MySQL5.7版本官网提示, show profile有可能不会在未来版本中出现,  取而代之的将会是 <code>performance schema</code> 性能模式.</p>
<p><strong>The SHOW PROFILE and SHOW PROFILES statements are deprecated and will be removed in a future MySQL release. Use the Performance Schema instead; see <a href="https://dev.mysql.com/doc/refman/5.7/en/performance-schema-query-profiling.html" target="_blank" rel="noopener">Section 25.19.1, “Query<br> Profiling Using Performance Schema”</a>.</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profile all for query 1; -- 查询性能详细信息</span><br></pre></td></tr></table></figure>
<p><strong>如果不指明for query n, 则返回最近一条查询语句的性能分析.</strong></p>
<p>![show_profile_all](MySQL-Advanced-Optimization-01-性能监控篇/show profiles_1_all.png)</p>
<p><strong>总结: show profile可以查看的信息有: 功能较少新版本即将被性能模式(Performance Schema)取代.</strong></p>
<h1 id="performance-schema-高级查询剖析"><a href="#performance-schema-高级查询剖析" class="headerlink" title="performance schema (高级查询剖析)"></a><a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-quick-start.html" target="_blank" rel="noopener">performance schema (高级查询剖析)</a></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>MySQL的performance schema 用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况</strong>。<br>特点如下：<br>​1、提供了一种在数据库运行时实时检查server的内部执行情况的方法。performance_schema 数据库中的表使用performance_schema存储引擎。该数据库主要关注数据库运行过程中的性能相关的数据，与information_schema不同，information_schema主要关注server运行过程中的元数据信息<br>​2、performance_schema通过监视server的事件来实现监视server内部运行情况， “事件”就是server内部活动中所做的任何事情以及对应的时间消耗，利用这些信息来判断server中的相关资源消耗在了哪里？一般来说，事件可以是函数调用、操作系统的等待、SQL语句执行的阶段（如sql语句执行过程中的parsing 或 sorting阶段）或者整个SQL语句与SQL语句集合。事件的采集可以方便的提供server中的相关存储引擎对磁盘文件、表I/O、表锁等资源的同步调用信息。<br>​3、performance_schema中的事件与写入二进制日志中的事件（描述数据修改的events）、事件计划调度程序（这是一种存储程序）的事件不同。performance_schema中的事件记录的是server执行某些活动对某些资源的消耗、耗时、这些活动执行的次数等情况。<br>​4、performance_schema中的事件只记录在本地server的performance_schema中，其下的这些表中数据发生变化时不会被写入binlog中，也不会通过复制机制被复制到其他server中。<br>​5、 当前活跃事件、历史事件和事件摘要相关的表中记录的信息。能提供某个事件的执行次数、使用时长。进而可用于分析某个特定线程、特定对象（如mutex或file）相关联的活动。<br>​6、PERFORMANCE_SCHEMA存储引擎使用server源代码中的“检测点”来实现事件数据的收集。对于performance_schema实现机制本身的代码没有相关的单独线程来检测，这与其他功能（如复制或事件计划程序）不同<br>​7、收集的事件数据存储在performance_schema数据库的表中。这些表可以使用SELECT语句查询，也可以使用SQL语句更新performance_schema数据库中的表记录（如动态修改performance_schema的setup_*开头的几个配置表，但要注意：配置表的更改会立即生效，这会影响数据收集）<br>​8、performance_schema的表中的数据不会持久化存储在磁盘中，而是保存在内存中，一旦服务器重启，这些数据会丢失（包括配置表在内的整个performance_schema下的所有数据）<br>​9、MySQL支持的所有平台中事件监控功能都可用，但不同平台中用于统计事件时间开销的计时器类型可能会有所差异。</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performace_schema%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8.png" alt="performace_schema相关属性列表"><br>在mysql的5.7版本中Performance Schemap配置是默认开启的. 如果想要显式的关闭的话需要修改配置文件，不能直接进行修改，会报错Variable ‘performance_schema’ is a read only variable。可以通过修改MySQL服务端配置文件<code>my.cnf</code>,在其中添加如下配置行显示地开启或者关闭该配置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--查看performance_schema的属性</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema&#39;;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| performance_schema | ON    |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">--在配置文件中修改performance_schema的属性值，on表示开启，off表示关闭</span><br><span class="line">[mysqld]</span><br><span class="line">performance_schema&#x3D;ON</span><br><span class="line"></span><br><span class="line">--切换数据库</span><br><span class="line">use performance_schema;</span><br><span class="line"></span><br><span class="line">--查看当前数据库下的所有表,会看到有很多表存储着相关的信息</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">--可以通过show create table tablename来查看创建表的时候的表结构</span><br><span class="line">mysql&gt; show create table setup_consumers;</span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">| Table           | Create Table                    </span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">| setup_consumers | CREATE TABLE &#96;setup_consumers&#96; (</span><br><span class="line">  &#96;NAME&#96; varchar(64) NOT NULL,                      </span><br><span class="line">  &#96;ENABLED&#96; enum(&#39;YES&#39;,&#39;NO&#39;) NOT NULL               </span><br><span class="line">) ENGINE&#x3D;PERFORMANCE_SCHEMA DEFAULT CHARSET&#x3D;utf8 |  </span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>


<p>想要搞明白后续的内容，需要理解两个基本概念：<br>instruments: 生产者，用于采集mysql中各种各样的操作产生的事件信息，对应配置表中的配置项我们可以称为监控采集配置项。<br>consumers:   消费者，对应的消费者表用于存储来自instruments采集的数据，对应配置表中的配置项我们可以称为消费存储配置项。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--语句事件记录表，这些表记录了语句事件信息，当前语句事件表events_statements_current、历史语句事件表events_statements_history和长语句历史事件表events_statements_history_long、以及聚合后的摘要表summary，其中，summary表还可以根据帐号(account)，主机(host)，程序(program)，线程(thread)，用户(user)和全局(global)再进行细分)</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%statement%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--等待事件记录表，与语句事件类型的相关记录表类似：</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%wait%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--阶段事件记录表，记录语句执行的阶段事件的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%stage%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--事务事件记录表，记录事务相关的事件的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%transaction%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监控文件系统层调用的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%file%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监视内存使用的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%memory%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--动态对performance_schema进行配置的配置表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%setup%'</span>;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">performance_schema&#x3D;ON</span><br></pre></td></tr></table></figure>
<p>通过如下命令可以验证<code>performance schema</code>开启与否:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema&#39;;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| performance_schema | ON    |</span><br><span class="line">+--------------------+-------+</span><br></pre></td></tr></table></figure>
<p>ON表示开启成功, OFF表示有错误, 此时应该查看错误日志.<br><code>Performance Schema</code> 本质上是存储引擎的一种实现, 所以执行如下命令会有响应的输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM INFORMATION_SCHEMA.ENGINES WHERE ENGINE&#x3D;&#39;PERFORMANCE_SCHEMA&#39;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">      ENGINE: PERFORMANCE_SCHEMA</span><br><span class="line">     SUPPORT: YES</span><br><span class="line">     COMMENT: Performance Schema</span><br><span class="line">TRANSACTIONS: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  SAVEPOINTS: NO</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW ENGINES\G</span><br><span class="line">...</span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>performance_schema</code>存储引擎作用于<code>performance_schema</code>库中的表.<br><code>performance_schema</code>库及其中表的结构信息可以从<code>INFORMATION_SCHEMA</code>库中获取. 一下两种方式都能查看<code>performance_schema</code>库中的表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES</span><br><span class="line">       WHERE TABLE_SCHEMA &#x3D; &#39;performance_schema&#39;;</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| TABLE_NAME                                           |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| accounts                                             |</span><br><span class="line">| cond_instances                                       |</span><br><span class="line">...</span><br><span class="line">| events_stages_current                                |</span><br><span class="line">| events_stages_history                                |</span><br><span class="line">| events_stages_history_long                           |</span><br><span class="line">| events_stages_summary_by_account_by_event_name       |</span><br><span class="line">| events_stages_summary_by_host_by_event_name          |</span><br><span class="line">| events_stages_summary_by_thread_by_event_name        |</span><br><span class="line">| events_stages_summary_by_user_by_event_name          |</span><br><span class="line">| events_stages_summary_global_by_event_name           |</span><br><span class="line">| events_statements_current                            |</span><br><span class="line">| events_statements_history                            |</span><br><span class="line">| events_statements_history_long                       |</span><br><span class="line">...</span><br><span class="line">| file_instances                                       |</span><br><span class="line">| file_summary_by_event_name                           |</span><br><span class="line">| file_summary_by_instance                             |</span><br><span class="line">| host_cache                                           |</span><br><span class="line">| hosts                                                |</span><br><span class="line">| memory_summary_by_account_by_event_name              |</span><br><span class="line">| memory_summary_by_host_by_event_name                 |</span><br><span class="line">| memory_summary_by_thread_by_event_name               |</span><br><span class="line">| memory_summary_by_user_by_event_name                 |</span><br><span class="line">| memory_summary_global_by_event_name                  |</span><br><span class="line">| metadata_locks                                       |</span><br><span class="line">| mutex_instances                                      |</span><br><span class="line">| objects_summary_global_by_type                       |</span><br><span class="line">| performance_timers                                   |</span><br><span class="line">| replication_connection_configuration                 |</span><br><span class="line">| replication_connection_status                        |</span><br><span class="line">| replication_applier_configuration                    |</span><br><span class="line">| replication_applier_status                           |</span><br><span class="line">| replication_applier_status_by_coordinator            |</span><br><span class="line">| replication_applier_status_by_worker                 |</span><br><span class="line">| rwlock_instances                                     |</span><br><span class="line">| session_account_connect_attrs                        |</span><br><span class="line">| session_connect_attrs                                |</span><br><span class="line">| setup_actors                                         |</span><br><span class="line">| setup_consumers                                      |</span><br><span class="line">| setup_instruments                                    |</span><br><span class="line">| setup_objects                                        |</span><br><span class="line">| socket_instances                                     |</span><br><span class="line">| socket_summary_by_event_name                         |</span><br><span class="line">| socket_summary_by_instance                           |</span><br><span class="line">| table_handles                                        |</span><br><span class="line">| table_io_waits_summary_by_index_usage                |</span><br><span class="line">| table_io_waits_summary_by_table                      |</span><br><span class="line">| table_lock_waits_summary_by_table                    |</span><br><span class="line">| threads                                              |</span><br><span class="line">| users                                                |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES FROM performance_schema;</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| Tables_in_performance_schema                         |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| accounts                                             |</span><br><span class="line">| cond_instances                                       |</span><br><span class="line">| events_stages_current                                |</span><br><span class="line">| events_stages_history                                |</span><br><span class="line">| events_stages_history_long                           |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>performance_schema</code>库中的表会随着时间 的推移而越来越多. 因为会有越来越多的instrument生产者事件. 根据采集信息的类别, </p>
<h2 id="performance-schema表的分类"><a href="#performance-schema表的分类" class="headerlink" title="performance_schema表的分类"></a>performance_schema表的分类</h2><p>performance_schema库下的表可以按收集信息类型可以进行如下分组:<br> 当前事件表(Current events), 历史事件和总结表(event histories and summaries), 对象实例表(object instances), and 配置信息表(setup (configuration) information)<br>下面简单展示了几个这些表的部分操作, 详细操作信息可以参考官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-table-descriptions.html" target="_blank" rel="noopener">Section 26.12, “Performance Schema Table Descriptions”.</a></p>
<p>首先, 并非所有生产者和消费者配置项都是开启的, 所以performance schema并非默认搜集所有事件信息. 要想开启所有事件采集和消费的配置并开启计时配置, 执行下面的两行命令即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE performance_schema.setup_instruments</span><br><span class="line">       SET ENABLED &#x3D; &#39;YES&#39;, TIMED &#x3D; &#39;YES&#39;;</span><br><span class="line">Query OK, 560 rows affected (0.04 sec)</span><br><span class="line">mysql&gt; UPDATE performance_schema.setup_consumers</span><br><span class="line">       SET ENABLED &#x3D; &#39;YES&#39;;</span><br><span class="line">Query OK, 10 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>要查看服务器当前正在执行说明可以执行下面的命令, 输出结果每一行代表一个线程最近执行的操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT *</span><br><span class="line">       FROM performance_schema.events_waits_current\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">            THREAD_ID: 0</span><br><span class="line">             EVENT_ID: 5523</span><br><span class="line">         END_EVENT_ID: 5523</span><br><span class="line">           EVENT_NAME: wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex</span><br><span class="line">               SOURCE: thr_lock.c:525</span><br><span class="line">          TIMER_START: 201660494489586</span><br><span class="line">            TIMER_END: 201660494576112</span><br><span class="line">           TIMER_WAIT: 86526</span><br><span class="line">                SPINS: NULL</span><br><span class="line">        OBJECT_SCHEMA: NULL</span><br><span class="line">          OBJECT_NAME: NULL</span><br><span class="line">           INDEX_NAME: NULL</span><br><span class="line">          OBJECT_TYPE: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 142270668</span><br><span class="line">     NESTING_EVENT_ID: NULL</span><br><span class="line">   NESTING_EVENT_TYPE: NULL</span><br><span class="line">            OPERATION: lock</span><br><span class="line">      NUMBER_OF_BYTES: NULL</span><br><span class="line">                FLAGS: 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>上述输出结果的说明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  该事件表示线程id为0的线程正在等待子系统mysys的互斥锁:THR_LOCK::mutex，等待时间为86526皮秒(1皮秒=一万亿分之一秒).</span></span><br><span class="line"><span class="comment">//  属性说明：</span></span><br><span class="line"><span class="comment">//	id:事件来自哪个线程，事件编号是多少</span></span><br><span class="line"><span class="comment">//	event_name:表示检测到的具体的内容</span></span><br><span class="line"><span class="comment">//	source:表示这个检测代码在哪个源文件中以及行号</span></span><br><span class="line"><span class="comment">//	timer_start:表示该事件的开始时间</span></span><br><span class="line"><span class="comment">//	timer_end:表示该事件的结束时间</span></span><br><span class="line"><span class="comment">//	timer_wait:表示该事件总的花费时间</span></span><br><span class="line"><span class="comment">// 注意：_current表中每个线程只保留一条记录，一旦线程完成工作，该表中不会再记录该线程的事件信息, 如果事件未结束, 那么timer_end和timer_wait会是空.</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AF%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%B9%B6%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8Dserver%E6%89%A7%E8%A1%8C%E4%BF%A1%E6%81%AF.png" alt="开启等待事件配置项并查看当前server执行信息"></p>
<p>历史表和当前事件表的结构信息类似,只是历史表记录的是服务器最近(recently)执行的操作, 而不是当前(currently)  .</p>
<p> <code>events_waits_history</code>表: 显示每个线程最近的十个事件信息.<br> <code>events_waits_history_long</code>表: 显示最近的1000个事件.<br>For example, to see information for recent events produced by thread 13, do this:<br>若想查看线程13最近执行的事件信息, 可以执行命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT EVENT_ID, EVENT_NAME, TIMER_WAIT</span><br><span class="line">       FROM performance_schema.events_waits_history</span><br><span class="line">       WHERE THREAD_ID &#x3D; 13</span><br><span class="line">       ORDER BY EVENT_ID;</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br><span class="line">| EVENT_ID | EVENT_NAME                              | TIMER_WAIT |</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br><span class="line">|       86 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex  |     686322 |</span><br><span class="line">|       87 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     320535 |</span><br><span class="line">|       88 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     339390 |</span><br><span class="line">|       89 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     377100 |</span><br><span class="line">|       90 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin        |     614673 |</span><br><span class="line">|       91 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_open          |     659925 |</span><br><span class="line">|       92 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;THD::LOCK_thd_data |     494001 |</span><br><span class="line">|       93 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     222489 |</span><br><span class="line">|       94 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     214947 |</span><br><span class="line">|       95 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm       |     312993 |</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br></pre></td></tr></table></figure>

<p>当历史表存满后, 新来的时间会被插入, 而历史事件会被清除.<br>select thread_id,event_id,event_name,timer_wait from events_waits_history order by thread_id limit 21;</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/events_waits_history%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C.png" alt="events_waits_history表查询结果"></p>
<p>总结表(Summary tables)存储的是所有事件按时间聚合的信息, 聚合的方式可以是多样的.为了查看哪个instruments事件执行次数最多, 或者等待时长最长,查询<code>events_waits_summary_global_by_event_name</code>表, 并按COUNT_STAR 或 SUM_TIMER_WAIT列进行排序即可.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT EVENT_NAME, COUNT_STAR</span><br><span class="line">       FROM performance_schema.events_waits_summary_global_by_event_name</span><br><span class="line">       ORDER BY COUNT_STAR DESC LIMIT 10;</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line">| EVENT_NAME                                        | COUNT_STAR |</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc            |       6419 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;FRM                              |        452 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin                  |        337 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_open              |        187 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm                 |        147 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;THD::LOCK_thd_data           |        115 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile                         |        102 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_system_variables |         89 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex            |         89 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_open                    |         88 |</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT EVENT_NAME, SUM_TIMER_WAIT</span><br><span class="line">       FROM performance_schema.events_waits_summary_global_by_event_name</span><br><span class="line">       ORDER BY SUM_TIMER_WAIT DESC LIMIT 10;</span><br><span class="line">+----------------------------------------+----------------+</span><br><span class="line">| EVENT_NAME                             | SUM_TIMER_WAIT |</span><br><span class="line">+----------------------------------------+----------------+</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;MYSQL_LOG             |     1599816582 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc |     1530083250 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog_index          |     1385291934 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;FRM                   |     1292823243 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile              |      411193611 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;dfile              |      322401645 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm      |      145126935 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;casetest              |      104324715 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin       |       86027823 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;pid                   |       72591750 |</span><br><span class="line">+----------------------------------------+----------------+</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0%E6%9C%80%E5%A4%9A%E7%9A%84instruments.png" alt="执行次数最多的instruments"></p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E7%AD%89%E5%BE%85%E6%97%B6%E9%95%BF%E6%9C%80%E9%95%BF%E7%9A%84instruments.png" alt="等待时长最长的instruments"></p>
<p>instance表记录了哪些类型的对象会被检测。这些对象在被server使用时，在该表中将会产生一条事件记录，这些表提供了事件名称和一些解释信息, 状态信息等. 例如，file_instances表列出了文件I/O操作及其关联文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT *</span><br><span class="line">       FROM performance_schema.file_instances\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql-log&#x2F;60500&#x2F;binlog.000007</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog</span><br><span class="line">OPEN_COUNT: 0</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql&#x2F;60500&#x2F;data&#x2F;mysql&#x2F;tables_priv.MYI</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile</span><br><span class="line">OPEN_COUNT: 1</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql&#x2F;60500&#x2F;data&#x2F;mysql&#x2F;columns_priv.MYI</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile</span><br><span class="line">OPEN_COUNT: 1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>setup表用来配置和展示监控特征.例如, 表<code>setup_instruments</code> 罗列了哪些instruments事件被采集, 被计时等.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT NAME, ENABLED, TIMED</span><br><span class="line">       FROM performance_schema.setup_instruments;</span><br><span class="line">+---------------------------------------------------+---------+-------+</span><br><span class="line">| NAME                                              | ENABLED | TIMED |</span><br><span class="line">+---------------------------------------------------+---------+-------+</span><br><span class="line">...</span><br><span class="line">| stage&#x2F;sql&#x2F;end                                     | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;executing                               | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;init                                    | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;insert                                  | NO      | NO    |</span><br><span class="line">...</span><br><span class="line">| statement&#x2F;sql&#x2F;load                                | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;grant                               | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;check                               | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;flush                               | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_read_lock        | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_system_variables | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_lock_db                 | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_manager                 | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_grant                  | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOGGER::LOCK_logger         | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_sys_init_connect       | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_sys_init_slave         | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog                           | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog_index                     | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;casetest                         | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;dbopt                            | YES     | YES   |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>To control whether events are collected for an instrument, set its ENABLED value to YES or NO. For example:<br>通过修改<code>performance_schema.setup_instruments</code>表的enable列的值, 可以达到配置事件是否被采集.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE performance_schema.setup_instruments</span><br><span class="line">       SET ENABLED &#x3D; &#39;NO&#39;</span><br><span class="line">       WHERE NAME &#x3D; &#39;wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_mysql_create_db&#39;;</span><br></pre></td></tr></table></figure>
<p>性能模式通过采集到的事件信息去更新<code>performance schema</code>库下的表, 这个就是”消费者”的操作. <code>setup_consumers</code>列出了可用的消费者及其开启情况.<br><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%9F%A5%E7%9C%8B%E5%8F%AF%E7%94%A8%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%8A%E5%85%B6%E5%BC%80%E5%90%AF%E6%83%85%E5%86%B5.jpg" alt="查看可用消费者及其开启情况"> </p>
<p>为了控制性能模式是否维护事件信息到消费者, 可以设置上图中的<code>enable</code>为yes. 更多setup表的详细配置信息参见官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-filtering.html" target="_blank" rel="noopener">Section 26.4.2, “Performance Schema Event Filtering”</a></p>
<p>解释:<br>instrument name命名规则参见官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-instrument-naming.html" target="_blank" rel="noopener">Section 26.6, “Performance Schema Instrument Naming Conventions”.</a><br>An instrument name consists of a sequence of elements separated by ‘/‘ characters. Example names:<br>一个生产者名称由一串以<code>/</code>分割的字符串元素组成, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;log</span><br><span class="line">wait&#x2F;io&#x2F;file&#x2F;mysys&#x2F;charset</span><br><span class="line">wait&#x2F;lock&#x2F;table&#x2F;sql&#x2F;handler</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;mysys&#x2F;COND_alarm</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;sql&#x2F;BINLOG::update_cond</span><br><span class="line">wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;BITMAP_mutex</span><br><span class="line">wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_delete</span><br><span class="line">wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;Query_cache_query::lock</span><br><span class="line">stage&#x2F;sql&#x2F;closing tables</span><br><span class="line">stage&#x2F;sql&#x2F;Sorting result</span><br><span class="line">statement&#x2F;com&#x2F;Execute</span><br><span class="line">statement&#x2F;com&#x2F;Query</span><br><span class="line">statement&#x2F;sql&#x2F;create_table</span><br><span class="line">statement&#x2F;sql&#x2F;lock_tables</span><br><span class="line">errors</span><br></pre></td></tr></table></figure>
<p>该树形结构的名称从左往右逐步具象化.一个instruments所拥有的元素的个数由其类型决定. 给定元素的意义由其左边所有元素一起决定.<br>例如, myisam出现在如下两个instruments名称中, 但是, 一个与文件io有关, 而第二个则与同步有关.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;log</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;myisam&#x2F;MI_SORT_INFO::cond</span><br></pre></td></tr></table></figure>

<p>生产者名称(instrument name)是由一个前缀(其结构由Performance Schema而定)和一个后缀(程序自定义的)构成. 前缀的顶层元素表明了生产者的类型. 可以有如下家中形式:<br>idle: 空闲事件. 该生产者没有更深层的元素.<br>error: 错误事件.该生产者没有更深层的元素.<br>memory: 内存事件.<br>stage: 阶段事件.<br>statement: 语句事件.<br>transaction: 事务事件. 该生产者没有更深层的元素.<br>wait: 等待事件.</p>
<h2 id="常用配置项的参数说明-重点"><a href="#常用配置项的参数说明-重点" class="headerlink" title="常用配置项的参数说明(重点)"></a>常用配置项的参数说明<font color="red">(重点)</font></h2><p>1、启动选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_consumer_events_statements_current&#x3D;TRUE</span><br><span class="line">-- 是否在mysql server启动时就开启events_statements_current表的记录功能(该表记录当前的语句事件信息)，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新setup_consumers配置表中的events_statements_current配置项，默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_statements_history&#x3D;TRUE</span><br><span class="line">-- 与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件短历史信息，默认为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_stages_history_long&#x3D;FALSE</span><br><span class="line">-- 与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件长历史信息，默认为FALSE</span><br><span class="line"></span><br><span class="line">-- 除了statement(语句)事件之外，还支持：wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个启动项分别进行配置，但这些等待事件默认未启用，如果需要在MySQL Server启动时一同启动，则通常需要写进my.cnf配置文件中</span><br><span class="line">-- performance_schema_consumer_global_instrumentation&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启全局表（如：mutex_instances、rwlock_instances、cond_instances、file_instances、users、hostsaccounts、socket_summary_by_event_name、file_summary_by_instance等大部分的全局对象计数统计和事件汇总统计信息表 ）的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新全局配置项</span><br><span class="line">-- 默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_statements_digest&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启events_statements_summary_by_digest 表的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新digest配置项</span><br><span class="line">-- 默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_thread_instrumentation&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启</span><br><span class="line"></span><br><span class="line">events_xxx_summary_by_yyy_by_event_name表的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新线程配置项</span><br><span class="line">默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_instrument[&#x3D;name]</span><br><span class="line">-- 是否在MySQL Server启动时就启用某些采集器，由于instruments配置项多达数千个，所以该配置项支持key-value模式，还支持%号进行通配等，如下:</span><br><span class="line"></span><br><span class="line">-- [&#x3D;name]可以指定为具体的Instruments名称（但是这样如果有多个需要指定的时候，就需要使用该选项多次），也可以使用通配符，可以指定instruments相同的前缀+通配符，也可以使用%代表所有的instruments</span><br><span class="line"></span><br><span class="line">-- 指定开启单个instruments</span><br><span class="line"></span><br><span class="line">performance-schema-instrument&#x3D; &#39;instrument_name&#x3D;value&#39;</span><br><span class="line"></span><br><span class="line">-- 使用通配符指定开启多个instruments</span><br><span class="line"></span><br><span class="line">performance-schema-instrument&#x3D; &#39;wait&#x2F;synch&#x2F;cond&#x2F;%&#x3D;COUNTED&#39;</span><br><span class="line"></span><br><span class="line">--  开关所有的instruments</span><br><span class="line"></span><br><span class="line">-- performance-schema-instrument&#x3D; &#39;%&#x3D;ON&#39;</span><br><span class="line"></span><br><span class="line">-- performance-schema-instrument&#x3D; &#39;%&#x3D;OFF&#39;</span><br><span class="line"></span><br><span class="line">-- 注意，这些启动选项要生效的前提是，需要设置performance_schema&#x3D;ON。另外，这些启动选项虽然无法使用show variables语句查看，但我们可以通过setup_instruments和setup_consumers表查询这些选项指定的值。</span><br></pre></td></tr></table></figure>

<p>2、系统变量</p>
<p>控制performance_schema功能的开关，要使用MySQL的performance_schema，需要在mysqld启动时启用，以启用事件收集功能<br>该参数在5.7.x之前支持performance_schema的版本中默认关闭，5.7.x版本开始默认开启<br>注意：如果mysqld在初始化performance_schema时发现无法分配任何相关的内部缓冲区，则performance_schema将自动禁用，并将performance_schema设置为OFF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%performance_schema%&#39;;</span><br><span class="line">-- 重要的属性解释</span><br><span class="line">performance_schema&#x3D;ON</span><br></pre></td></tr></table></figure>
<p>控制events_statements_summary_by_digest表中的最大行数。如果产生的语句摘要信息超过此最大值，便无法继续存入该表，此时performance_schema会增加状态变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_digests_size&#x3D;10000</span><br></pre></td></tr></table></figure>
<p>控制events_statements_history_long表中的最大行数，该参数控制所有会话在events_statements_history_long表中能够存放的总事件记录数，超过这个限制之后，最早的记录将被覆盖<br>全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10000，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10000 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_events_statements_history_long_size&#x3D;10000</span><br></pre></td></tr></table></figure>
<p>控制events_statements_history表中单个线程（会话）的最大行数，该参数控制单个会话在events_statements_history表中能够存放的事件记录数，超过这个限制之后，单个会话最早的记录将被覆盖<br>全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10<br>除了statement(语句)事件之外，wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个参数分别进行存储限制配置，有兴趣的同学自行研究，这里不再赘述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_events_statements_history_size&#x3D;10</span><br></pre></td></tr></table></figure>
<p>用于控制标准化形式的SQL语句文本在存入performance_schema时的限制长度，该变量与max_digest_length变量相关(max_digest_length变量含义请自行查阅相关资料)<br>全局变量，只读变量，默认值1024字节，整型值，取值范围0~1048576</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_max_digest_length&#x3D;1024</span><br></pre></td></tr></table></figure>
<p> 控制存入events_statements_current，events_statements_history和events_statements_history_long语句事件表中的SQL_TEXT列的最大SQL长度字节数。 超出系统变量performance_schema_max_sql_text_length的部分将被丢弃，不会记录，一般情况下不需要调整该参数，除非被截断的部分与其他SQL比起来有很大差异<br> 全局变量，只读变量，整型值，默认值为1024字节，取值范围为0~1048576，5.7.6版本引入<br> 降低系统变量performance_schema_max_sql_text_length值可以减少内存使用，但如果汇总的SQL中，被截断部分有较大差异，会导致没有办法再对这些有较大差异的SQL进行区分。 增加该系统变量值会增加内存使用，但对于汇总SQL来讲可以更精准地区分不同的部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_max_sql_text_length&#x3D;1024</span><br></pre></td></tr></table></figure>

<h2 id="重要配置表的相关说明"><a href="#重要配置表的相关说明" class="headerlink" title="重要配置表的相关说明"></a>重要配置表的相关说明</h2><p>配置表之间存在相互关联关系，按照配置影响的先后顺序，可添加为</p>
<p>performance_timers表中记录了server中有哪些可用的事件计时器<br>字段解释：<br>    timer_name:表示可用计时器名称，CYCLE是基于CPU周期计数器的定时器<br>    timer_frequency:表示每秒钟对应的计时器单位的数量,CYCLE计时器的换算值与CPU的频率相关、<br>    timer_resolution:计时器精度值，表示在每个计时器被调用时额外增加的值<br>    timer_overhead:表示在使用定时器获取事件时开销的最小周期值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_timers;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performance_timers%E8%A1%A8.jpg" alt="performance_timers表结构信息"></p>
<p>setup_timers表中记录当前使用的事件计时器信息</p>
<p>字段解释：<br>    name:计时器类型，对应某个事件类别<br>    timer_name:计时器类型名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from setup_timers;</span><br></pre></td></tr></table></figure>

<p>setup_consumers表中列出了consumers可配置列表项<br>字段解释：<br>    NAME：consumers配置名称<br>    ENABLED：consumers是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from setup_consumers;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_consumer.jpg" alt="setup_consumers表结构信息"><br>setup_instruments 表列出了instruments 列表配置项，即代表了哪些事件支持被收集：<br>字段解释：<br>    NAME：instruments名称，instruments名称可能具有多个部分并形成层次结构<br>    ENABLED：instrumetns是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。如果设置为NO，则这个instruments不会被执行，不会产生任何的事件信息<br>    TIMED：instruments是否收集时间信息，有效值为YES或NO，此列可以使用UPDATE语句修改，如果设置为NO，则这个instruments不会收集时间信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_instruments;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_instruments.jpg" alt="setup_instruments表结构信息"><br>setup_actors表的初始内容是匹配任何用户和主机，因此对于所有前台线程，默认情况下启用监视和历史事件收集功能<br>字段解释：<br>    HOST：与grant语句类似的主机名，一个具体的字符串名字，或使用“％”表示“任何主机”<br>    USER：一个具体的字符串名称，或使用“％”表示“任何用户”<br>    ROLE：当前未使用，MySQL 8.0中才启用角色功能<br>    ENABLED：是否启用与HOST，USER，ROLE匹配的前台线程的监控功能，有效值为：YES或NO<br>    HISTORY：是否启用与HOST， USER，ROLE匹配的前台线程的历史事件记录功能，有效值为：YES或NO</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_actors;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_actors.jpg" alt="setup_actors表结构信息"><br>setup_objects表控制performance_schema是否监视特定对象。默认情况下，此表的最大行数为100行。<br>字段解释：<br>    OBJECT_TYPE：instruments类型，有效值为：“EVENT”（事件调度器事件）、“FUNCTION”（存储函数）、“PROCEDURE”（存储过程）、“TABLE”（基表）、“TRIGGER”（触发器），TABLE对象类型的配置会影响表I/O事件（wait/io/table/sql/handler instrument）和表锁事件（wait/lock/table/sql/handler instrument）的收集<br>    OBJECT_SCHEMA：某个监视类型对象涵盖的数据库名称，一个字符串名称，或“％”(表示“任何数据库”)<br>    OBJECT_NAME：某个监视类型对象涵盖的表名，一个字符串名称，或“％”(表示“任何数据库内的对象”)<br>    ENABLED：是否开启对某个类型对象的监视功能，有效值为：YES或NO。此列可以修改<br>    TIMED：是否开启对某个类型对象的时间收集功能，有效值为：YES或NO，此列可以修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_objects;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_objects.jpg" alt="setup_objects表结构信息"></p>
<p>threads表对于每个server线程生成一行包含线程相关的信息，<br>字段解释：<br>    THREAD_ID：线程的唯一标识符（ID）<br>    NAME：与server中的线程检测代码相关联的名称(注意，这里不是instruments名称)<br>    TYPE：线程类型，有效值为：FOREGROUND、BACKGROUND。分别表示前台线程和后台线程<br>    PROCESSLIST_ID：对应INFORMATION_SCHEMA.PROCESSLIST表中的ID列。<br>    PROCESSLIST_USER：与前台线程相关联的用户名，对于后台线程为NULL。<br>    PROCESSLIST_HOST：与前台线程关联的客户端的主机名，对于后台线程为NULL。<br>    PROCESSLIST_DB：线程的默认数据库，如果没有，则为NULL。<br>    PROCESSLIST_COMMAND：对于前台线程，该值代表着当前客户端正在执行的command类型，如果是sleep则表示当前会话处于空闲状态<br>    PROCESSLIST_TIME：当前线程已处于当前线程状态的持续时间（秒）<br>    PROCESSLIST_STATE：表示线程正在做什么事情。<br>    PROCESSLIST_INFO：线程正在执行的语句，如果没有执行任何语句，则为NULL。<br>    PARENT_THREAD_ID：如果这个线程是一个子线程（由另一个线程生成），那么该字段显示其父线程ID<br>    ROLE：暂未使用<br>    INSTRUMENTED：线程执行的事件是否被检测。有效值：YES、NO<br>    HISTORY：是否记录线程的历史事件。有效值：YES、NO *<br>    THREAD_OS_ID：由操作系统层定义的线程或任务标识符（ID）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from threads;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/threads.jpg" alt="threads表结构信息"><br>注意：在performance_schema库中还包含了很多其他的库和表，能对数据库的性能做完整的监控，具体需要参考官网详细了解。</p>
<h2 id="performance-schema实践操作"><a href="#performance-schema实践操作" class="headerlink" title="performance_schema实践操作"></a>performance_schema实践操作</h2><p>​        基本了解了表的相关信息之后，可以通过这些表进行实际的查询操作来进行实际的分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1、哪类的SQL执行最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--2、哪类SQL的平均响应时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--3、哪类SQL排序记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_SORT_ROWS <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--4、哪类SQL扫描记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_EXAMINED <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--5、哪类SQL使用临时表最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_CREATED_TMP_TABLES,SUM_CREATED_TMP_DISK_TABLES <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--6、哪类SQL返回结果集最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_SENT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--7、哪个表物理IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> file_name,event_name,SUM_NUMBER_OF_BYTES_READ,SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">FROM</span> file_summary_by_instance <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_NUMBER_OF_BYTES_READ + SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--8、哪个表逻辑IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> object_name,COUNT_READ,COUNT_WRITE,COUNT_FETCH,SUM_TIMER_WAIT <span class="keyword">FROM</span> table_io_waits_summary_by_table <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--9、哪个索引访问最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_NAME,INDEX_NAME,COUNT_FETCH,COUNT_INSERT,COUNT_UPDATE,COUNT_DELETE <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--10、哪个索引从来没有用过？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">WHERE</span> INDEX_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> COUNT_STAR = <span class="number">0</span> <span class="keyword">AND</span> OBJECT_SCHEMA &lt;&gt; <span class="string">'mysql'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> OBJECT_SCHEMA,OBJECT_NAME;</span><br><span class="line"><span class="comment">--11、哪个等待事件消耗时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_NAME,COUNT_STAR,SUM_TIMER_WAIT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_waits_summary_global_by_event_name <span class="keyword">WHERE</span> event_name != <span class="string">'idle'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--12-1、剖析某条SQL的执行情况，包括statement信息，stege信息，wait信息</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_ID,sql_text <span class="keyword">FROM</span> events_statements_history <span class="keyword">WHERE</span> sql_text <span class="keyword">LIKE</span> <span class="string">'%count(*)%'</span>;</span><br><span class="line"><span class="comment">--12-2、查看每个阶段的时间消耗</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,EVENT_NAME,<span class="keyword">SOURCE</span>,TIMER_END - TIMER_START <span class="keyword">FROM</span> events_stages_history_long <span class="keyword">WHERE</span> NESTING_EVENT_ID = <span class="number">1553</span>;</span><br><span class="line"><span class="comment">--12-3、查看每个阶段的锁等待情况</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,event_name,<span class="keyword">source</span>,timer_wait,object_name,index_name,operation,nesting_event_id <span class="keyword">FROM</span> events_waits_history_longWHERE nesting_event_id = <span class="number">1553</span>;</span><br></pre></td></tr></table></figure>


<p>与性能模式有关的状态变量有如下这些:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &#39;perf%&#39;;</span><br><span class="line">+-----------------------------------------------+-------+</span><br><span class="line">| Variable_name                                 | Value |</span><br><span class="line">+-----------------------------------------------+-------+</span><br><span class="line">| Performance_schema_accounts_lost              | 0     |</span><br><span class="line">| Performance_schema_cond_classes_lost          | 0     |</span><br><span class="line">| Performance_schema_cond_instances_lost        | 0     |</span><br><span class="line">| Performance_schema_digest_lost                | 0     |</span><br><span class="line">| Performance_schema_file_classes_lost          | 0     |</span><br><span class="line">| Performance_schema_file_handles_lost          | 0     |</span><br><span class="line">| Performance_schema_file_instances_lost        | 0     |</span><br><span class="line">| Performance_schema_hosts_lost                 | 0     |</span><br><span class="line">| Performance_schema_locker_lost                | 0     |</span><br><span class="line">| Performance_schema_memory_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_metadata_lock_lost         | 0     |</span><br><span class="line">| Performance_schema_mutex_classes_lost         | 0     |</span><br><span class="line">| Performance_schema_mutex_instances_lost       | 0     |</span><br><span class="line">| Performance_schema_nested_statement_lost      | 0     |</span><br><span class="line">| Performance_schema_program_lost               | 0     |</span><br><span class="line">| Performance_schema_rwlock_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_rwlock_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_session_connect_attrs_lost | 0     |</span><br><span class="line">| Performance_schema_socket_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_socket_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_stage_classes_lost         | 0     |</span><br><span class="line">| Performance_schema_statement_classes_lost     | 0     |</span><br><span class="line">| Performance_schema_table_handles_lost         | 0     |</span><br><span class="line">| Performance_schema_table_instances_lost       | 0     |</span><br><span class="line">| Performance_schema_thread_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_thread_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_users_lost                 | 0     |</span><br><span class="line">+-----------------------------------------------+-------+</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%80%A7%E8%83%BD%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F.jpg" alt="性能模式状态变量"></p>
<p>例如, 当服务端某生产者采集到一个互斥对象,但是服务器又无法在运行时为采集动作分配内存, 那么Performance_schema_mutex_classes_lost值就会+1.<br>这种情况下, 互斥对象依旧正常以同步方式正常运行(即服务器正常运行), 但是该对象的性能表现数据就不会被采集到. </p>
<p>加入有如下场景:<br>服务端起始变量设置为performance_schema_max_mutex_classes=200, 并且已经加载了150个互斥对象,此时有两个plugin a和b分别持有40和20个互斥对象采集器.<br>当服务器加载了plugin a后再加载plugin b时就会有10个乎此对象采集器无法加载.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &quot;perf%mutex_classes_lost&quot;;</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| Variable_name                         | Value |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| Performance_schema_mutex_classes_lost | 10    |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">1 row in set (0.10 sec)</span><br></pre></td></tr></table></figure>
<p>注意, 采集动作对plugin b仍然部分有效, 只是有10个Performance_schema_mutex_classes_lost .<br>当服务器无法创建互斥对象采集器时, 将不会有数据写入setup_instruments.<br>Performance_schema_mutex_classes_lost 增量步长为 1.</p>
<p>以上所有模式对所有采集器都适用, 而非仅仅mutex.</p>
<h1 id="show-processlist-查看连接的线程个数"><a href="#show-processlist-查看连接的线程个数" class="headerlink" title="show processlist (查看连接的线程个数)"></a>show processlist (查看连接的线程个数)</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show [full] processlist;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/show_processlist.png" alt="show_processlist"><br>指令的输出列<a href="https://dev.mysql.com/doc/refman/5.7/en/show-processlist.html" target="_blank" rel="noopener">官网解释译文</a>:</p>
<ol>
<li>id: 连接标识符. 与 INFORMATION_SCHEMA.PROCESSLIST表的ID列一致.</li>
<li>user: 执行查询的用户名. 如果其值为system user, 则说明发对应查询非客户端发起的.</li>
<li>Host: 客户端主机端口信息</li>
<li>db: 当前查询所用的库. 如果职位NULL, 表示没有指定库.</li>
<li>Command: 客户端线程指令的类型. 如果当前连接为空闲状态则该列返回值为sleep.</li>
<li>Time: 该线程已处于当前状态的持续时间. 单位为秒</li>
<li>State: 当前线程所执行的内容: 可以是操作, 事件, 状态.[详见](https://dev.mysql.com/doc/refman/5.7/en/thread-information.html)如果某县城处于同一状态很多秒, 就可能有问题需要排查.</li>
<li>线程正(最近)执行的语句信息. NULL表示空闲,未执行任何语句.</li>
</ol>


      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/10/04/stepbystepJava/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/04/stepbystepJava/" class="post-title-link" itemprop="url">stepbystepJava</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-04 16:24:02" itemprop="dateCreated datePublished" datetime="2020-10-04T16:24:02+08:00">2020-10-04</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/28/Algorithms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/28/Algorithms/" class="post-title-link" itemprop="url">Algorithms</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-28 23:44:17" itemprop="dateCreated datePublished" datetime="2020-09-28T23:44:17+08:00">2020-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-04 15:59:32" itemprop="dateModified" datetime="2020-10-04T15:59:32+08:00">2020-10-04</time>
              </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>218</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>异或</p>
<ol>
<li>0101101000101000 类似这样的数, 取出最右边的①</li>
<li>一个数组中有一个数出现了奇数词,其他元素都出现了偶数次, 找出这个出现奇数次的数</li>
<li>一个数组中有两个数出现了奇数词,其他元素都出现了偶数次, 找出这两个出现奇数次的数</li>
<li>一个二int类型值的二进制数中1 的个数</li>
</ol>
<p>各类排序 (冒泡, 选择, 插入, 归并, 桶)</p>
<p>链表</p>
<p>单链表和双链表如何反转</p>
<p>删除单链表的指定值. (如: 2-0-3-4-5-6-7-2-4-1 要删除2, 则返回 0-3-4-5-6-7-4-1)</p>

      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter16/" class="post-title-link" itemprop="url">SpringBoot_Chapter16</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:38" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:38+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter15/" class="post-title-link" itemprop="url">SpringBoot_Chapter15</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:33" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:33+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter14/" class="post-title-link" itemprop="url">SpringBoot_Chapter14</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:29" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:29+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter13/" class="post-title-link" itemprop="url">SpringBoot_Chapter13</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:23" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:23+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter12/" class="post-title-link" itemprop="url">SpringBoot_Chapter12</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:19" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:19+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://liweian.co.uk/2020/09/22/SpringBoot-Chapter11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/22/SpringBoot-Chapter11/" class="post-title-link" itemprop="url">SpringBoot_Chapter11</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-22 00:09:15" itemprop="dateCreated datePublished" datetime="2020-09-22T00:09:15+08:00">2020-09-22</time>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>



<div>
  
</div>




    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
 


 <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->



      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Brooks.H.Joshua"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Brooks.H.Joshua</p>
  <div class="site-description" itemprop="description">Less Is More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/blog" title="https:&#x2F;&#x2F;spring.io&#x2F;blog" rel="noopener" target="_blank">Spring官博</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.itboyhub.com/" title="http:&#x2F;&#x2F;www.itboyhub.com&#x2F;" rel="noopener" target="_blank">JavaBoy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" title="https:&#x2F;&#x2F;www.cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html" rel="noopener" target="_blank">DSV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://visualgo.net/zh" title="https:&#x2F;&#x2F;visualgo.net&#x2F;zh" rel="noopener" target="_blank">DV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apache.org/index.html#projects-list" title="http:&#x2F;&#x2F;www.apache.org&#x2F;index.html#projects-list" rel="noopener" target="_blank">Apache</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">StackOverflow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://metacademy.org/" title="https:&#x2F;&#x2F;metacademy.org&#x2F;" rel="noopener" target="_blank">Metacademy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">WebNav</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.36zhen.com/t?id=3448" title="http:&#x2F;&#x2F;www.36zhen.com&#x2F;t?id&#x3D;3448" rel="noopener" target="_blank">前端书籍资料</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">G前端开发基础</a>
        </li>
    </ul>
  </div>

     
	<!--网易云音乐-->
	  <div id="music163player">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1002994&auto=1&height=66"></iframe>
	  </div>
      </div>

    </div>
  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Brooks.H.Joshua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">753k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">11:24</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

</html>
